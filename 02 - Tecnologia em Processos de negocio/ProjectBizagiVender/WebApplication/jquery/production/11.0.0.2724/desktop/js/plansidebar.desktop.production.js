bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu.plan",{},{init:function(n,t,i,r){var u=this;u.params=r||{};u.projectDashboard=i;u._super(n,t,r);u.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.plan").concat("#project-dashboard-menu")})},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.params&&n.params.contextsLeftSidebarCaseDashboard&&n.params.contextsLeftSidebarCaseDashboard.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))})},updateView:function(n,t){var i=this,r,u,f;i.params=$.extend(i.params,t.args);i.clean();r=i.getContent().empty();u=i.getTemplate("project-dashboard-menu");i.params.menuPlanDashboard=i.params.menuPlanDashboard||{};$.extend(i.params.menuPlanDashboard,i.params.menuDashboard);i.planState=i.getPlanState(i.params.plan,i.params.planChild);f={planState:i.planState,showCommentsOptionMenu:i.params.menuPlanDashboard.showCommentsOptionMenu,showFilesOptionMenu:i.params.menuPlanDashboard.showFilesOptionMenu,showTimeLineOptionMenu:i.params.menuPlanDashboard.showTimeLineOptionMenu&&i.isVisibleShowTimeLine(i.planState)};u.render(f).appendTo(r);$("li[data-context='"+i.params.showContextByMenuDashboard.toUpperCase()+"']",i.content).addClass("active").siblings().removeClass("active");i.handlerEvents()},getPlanState:function(n,t){var i;return t&&t.currentState?i=t.currentState:n&&n.currentState&&(i=n.currentState),i},isVisibleShowTimeLine:function(n){var i=this,t=!0;return n==="PENDING"&&(t=!1),t},loadContentById:function(n){var t=this,i,r;n.preventDefault();i=$(n.target).closest("li");i.data("context")==="PLANBACK"?t.backParentPlan():i.hasClass("active")||(r=i.data("context"),r&&(t.pub("notify",{type:r.toUpperCase(),args:$.extend(t.params,{showContextByMenuDashboard:r})}),$("li[data-context='"+t.params.showContextByMenuDashboard.toUpperCase()+"']",t.content).addClass("active").siblings().removeClass("active")))},subMenuHandler:function(){var t=this,n=t.getContent(),i=$("[data-context='PLANCOMMENTS']",n),r=$("[data-context='PLANFILES']",n),u=$("[data-context='PLANTIMELINE']",n);$(".ui-bizagi-wp-project-tab-submenu a",n).on("click",function(){i.toggle();r.toggle();t.isVisibleShowTimeLine(t.planState)&&u.toggle()})},backParentPlan:function(){var n=this,i=n.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),r=parseInt(i[0]),t=n.projectDashboard.getParamsByBackFromPlan(n.params,r);n.pub("notify",{type:t.typeContext,args:$.extend(n.params,t.paramsNotify)})},handlerEvents:function(){var n=this,t=n.getContent();n.subMenuHandler();$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(n.loadContentById,n))},clean:function(){var n=this,t=n.getContent();$(".ui-bizagi-wp-project-tab-links a",t).off();n.params&&n.params.contextsLeftSidebarCaseDashboard&&n.params.contextsLeftSidebarCaseDashboard.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))})}});bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.plan",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard",bizagi.workportal.widgets.project.dashboard.menu.plan],!0);
bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.sidebar",{},{init:function(n,t,i,r){var u=this;u._super(n,t,r);u.serviceloadDataPlan=i;u.params=r||{};r.supportNav=!1;u.loadTemplates({"project-plan-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.plan.sidebar").concat("#project-plan-sidebar")})},renderContent:function(){var n=this,t=n.getTemplate("project-plan-sidebar");return n.content=t.render({}),$.when(n.areTemplatedLoaded()).done(function(){var t={idPlan:n.params.plan.id};n.params.planChild&&n.params.planChild.id&&(t.idPlan=n.params.planChild.id);n.serviceloadDataPlan.loadData(t,n.getDateServer,n.params);n.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(n.loadedWithDataActivities,n));n.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(n.loadedWithDataFirstParent,n))}),n.content},loadedWithDataActivities:function(){var n=this;n.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:n.params});n.pub("notify",{type:"UPDATE_INFO_PLAN",args:n.params});n.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:n.params});n.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:n.params})},loadedWithDataFirstParent:function(){var n=this;n.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:n.params})},clean:function(){var n=this;n.serviceloadDataPlan&&(n.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(n.loadedWithDataActivities,n)),n.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(n.loadedWithDataFirstParent,n)))}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.sidebar],!0);
bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.action",{},{init:function(n,t,i,r,u,f,e){var o=this;o._super(n,t,e);o.PENDING_PLAN="PENDING";o.EXECUTING_PLAN="EXECUTING";o.CLOSED_PLAN="CLOSED";o.CONTEXT_ACTIVITYPLAN="ACTIVITYPLAN";o.CONTEXT_ACTIVITYPLANOVERVIEW="ACTIVITYPLANOVERVIEW";o.CONTEXT_PLANCREATE="PLANCREATE";o.CONTEXT_ACTIVITYPLANCREATE="ACTIVITYPLANCREATE";o.showActionsPlan=!1;o.projectDashboard=i;o.notifier=r;o.planTemplateCreate=u;o.planPopupEdit=f;o.loadTemplates({"plan-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.action").concat("#project-plan-action")})},renderContent:function(){var n=this,t=n.getTemplate("plan-action-main");return n.showActionsPlan=n.params.showContextByMenuDashboard!==n.CONTEXT_ACTIVITYPLAN&&n.params.showContextByMenuDashboard!==n.CONTEXT_ACTIVITYPLANOVERVIEW,n.plugins={},n.content=t.render({plan:n.params.plan.name,stateClosedPlan:n.CLOSED_PLAN,currentStatePlan:n.params.plan.currentState,showActionsPlan:n.showActionsPlan}),n.showActionsPlan&&(n.params.plan.contextualized=typeof n.params.plan.contextualized=="undefined"?!0:n.params.plan.contextualized),n.content},postRender:function(){var n=this,t=n.getContent();if(n.showActionsPlan){n.initilizeActionMenu();$("a#to-close-plan",t).on("click",$.proxy(n.onClosePlan,n))}n.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(n.onNotifyLoadInfoSummaryPlan,n));n.clearAlertsOnFocus();n.planTemplateCreate.sub("planTemplateCreatedSuccess",function(){n.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))});n.planTemplateCreate.sub("planTemplateCreatedFailed",function(){n.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))});n.planPopupEdit.sub("planEditedSuccess",function(){n.setNamePlan(n.params.plan.name);n.pub("notify",{type:"UPDATE_INFO_PLAN"});n.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:n.params});n.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))});n.planPopupEdit.sub("planEditedFailed",function(){n.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))});n.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(n.onNotifyExpandedRightSidebar,n))},onNotifyExpandedRightSidebar:function(){var n=this;n.showActionsPlan&&n.initilizeActionMenu()},onNotifyLoadInfoSummaryPlan:function(){var n=this;n.setStatePlan(n.params.plan.currentState);n.setNamePlan(n.params.plan.name)},setStatePlan:function(n){var t=this;if(n)switch(n.toUpperCase()){case"PENDING":$(".state-pending-plan",t.content).show().siblings().hide();break;case"EXECUTING":$(".state-executing-plan",t.content).show().siblings().hide();break;case"CLOSED":$(".state-closed-plan",t.content).show().siblings().hide()}},setNamePlan:function(n){var t=this;$(".ui-bizagi-wp-project-plan-header .bz-wp-section",t.content).text(n)},onSelectMenu:function(n,t){var i=this,r;if($(n.currentTarget).find("i").length===0){r=$(t.item).data("item");switch(r){case"edit":i.onClickMenuOpenEdition();break;case"delete":i.onClickMenuDeletePlan();break;case"saveastmpl":i.onClickMenuSaveAsTemplate()}}},onClickMenuOpenEdition:function(){var n=this,t=n.params.plan;n.planPopupEdit.showPopup(n.params,n.dataService,t)},onClickMenuSaveAsTemplate:function(){var n=this;n.planTemplateCreate.showPopupAddTemplatePlan(n.params,n.dataService,n.params.plan.contextualized,n.params.plan.id)},onClickMenuDeletePlan:function(){var n=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done(function(){var t={id:n.params.plan.id};$.when(n.callDeletePlan(t)).always(function(t){if(t.status===200||typeof t.status=="undefined"){$.extend(n.params.plan,i);n.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""));var r=n.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),u=parseInt(r[0]),i=n.projectDashboard.getParamsByBackFromPlan(n.params,u,!0);n.pub("notify",{type:i.typeContext,args:$.extend(n.params,i.paramsNotify)})}else n.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))})})},onSubmitFormPlan:function(n){n.preventDefault()},initilizeActionMenu:function(){var n=this;$(".ui-bizagi-wp-project-plan-action-menu",n.content).menu({select:$.proxy(n.onSelectMenu,n)}).removeClass("ui-widget-content")},clearAlertsOnFocus:function(){$(".ui-bizagi-wp-project-container-validator-relative input, .ui-bizagi-wp-project-container-validator-relative textarea").focus(function(){$(this).parent().find(".k-invalid-msg").hide()}).focusout(function(){$(this).val().length<1&&$(this).parent().find(".k-invalid-msg").show()})},callDeletePlan:function(n){var t=this;return $.when(t.dataService.deletePlan(n))},clean:function(){var n=this;n.planTemplateCreate.unsub("planTemplateCreatedSuccess");n.planTemplateCreate.unsub("planTemplateCreatedFailed");n.planPopupEdit.unsub("planEditedSuccess");n.planPopupEdit.unsub("planEditedFailed");n.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(n.onNotifyExpandedRightSidebar,n))}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.action",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit",bizagi.workportal.widgets.project.plan.action],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.state",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.loadTemplates({"plan-state-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.state").concat("#project-plan-state")})},renderContent:function(){var n=this,t=n.getTemplate("plan-state-main");return n.content=t.render({}),n.content},postRender:function(){var n=this;n.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(n.onNotifyLoadInfoSummaryPlan,n))},onNotifyLoadInfoSummaryPlan:function(n,t){var i=this,r;i.params=$.extend(i.params,t.args);r=i.params.plan.currentState;switch(r.toUpperCase()){case"PENDING":$(".state-pending",i.content).show().siblings().hide();break;case"EXECUTING":$(".state-executing",i.content).show().siblings().hide();break;case"CLOSED":$(".state-closed",i.content).show().siblings().hide()}}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.state",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.state],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.progress",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.progress").concat("#project-plan-progress")})},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.sub("LOAD_INFO_SUMMARY_PROGRESS_PLAN",$.proxy(n.onNotifyLoadInfoSummaryPlan,n))},onNotifyLoadInfoSummaryPlan:function(n,t){var i=this,f,e,o;i.params=$.extend(i.params,t.args);var u=i.getContent().empty(),s=i.calculateProgress(),r={};r.progress=s;r.colorBar=r.progress<33?"Red":r.progress<66?"Yellow":"Green";f=i.getTemplate("plan-progress-main");f.render(r).appendTo(u);e=$(".remaining-days .time-remaining",u);o=$(".remaining-days .days",u).width();e.css("padding-left",(o+7).toString()+"px")},calculateProgress:function(){var n=this,t=0,i=n.params.plan.activities.length,r=0;return i!==0&&(n.params.plan.activities.forEach(function(n){n.workItemState==="Completed"&&t++}),r=Math.round(t/i*100)),r}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.progress],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.time",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.PENDING_PLAN="PENDING";r.EXECUTING_PLAN="EXECUTING";r.CLOSED_PLAN="CLOSED";r.datePickerRegional=bizagi.localization.getResource("datePickerRegional");r.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.time").concat("#project-plan-time")})},renderContent:function(){var n=this,t=n.getTemplate("plan-time-main");return n.content=t.render({}),n.content},postRender:function(){var n=this;n.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(n.onNotifyLoadInfoSummaryPlan,n))},onNotifyLoadInfoSummaryPlan:function(n,t){var i=this;i.params=$.extend(i.params,t.args);i.params.plan&&(i.params.plan.dueDate?i.params.plan.currentState===i.PENDING_PLAN||i.params.plan.currentState===i.EXECUTING_PLAN?i.updateWidget(n,t):i.sub("LOADED_ACTIVITIES_PLAN",$.proxy(i.updateWidget,i)):i.getContent().empty())},updateWidget:function(n,t){var i=this,r;i.params=$.extend(i.params,t.args);r=i.getContent().empty();i.params.plan.currentState===i.CLOSED_PLAN&&i.getClosedDatePlan(i.params.plan);$.when(i.getIntervalOnMinutes(i.params.plan)).done(function(n){var u=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-n.minutesToShowTime*6e4),null,!0),o=u.replace(/\d/g,""),s=i.getKeywordDifferenceDates(i.params.plan),t=bizagi.localization.getResource("workportal-project-plan-state-"+s);t=t.replace("%s",o);var h=u.replace(/\D/g,""),f=i.getSecondDate(i.params.plan),e=i.getWidthBar(i.params.plan,n),c=i.getColorBarByPercent(e),l={fromDate:i.getFormattedDate(new Date(i.getFirstDate(i.params.plan))),toDate:f?i.getFormattedDate(new Date(f)):null,valueOfTimeCalculated:h,messageDescripionDifference:t,percentBar:e,colorBar:c},a=i.getTemplate("plan-time-main");a.render(l).appendTo(r)})},getFirstDate:function(n){var t=this;switch(n.currentState){case t.PENDING_PLAN:return n.dueDate?n.dueDate:n.creationDate;case t.EXECUTING_PLAN:case t.CLOSED_PLAN:return n.startDate}},getSecondDate:function(n){var t=this;switch(n.currentState){case t.PENDING_PLAN:return null;case t.EXECUTING_PLAN:return n.dueDate;case t.CLOSED_PLAN:return n.closedDate}},getLastActivity:function(n){var t=JSON.parse(JSON.stringify(n));return t.sort(function(n,t){return n.finishDate<t.finishDate?1:-1})[0]},getClosedDatePlan:function(n){var t=this;return n.closedDate=t.getLastActivity(n.activities).finishDate,n.closedDate},getDifferenceBetweenDates:function(n,t){var r=this,i=$.Deferred(),u={idUser:bizagi.currentUser.idUser,fromDate:n,toDate:t};return $.when(r.callGetEffectiveDuration(u)).done(function(n){i.resolve(n.minutes)}),i.promise()},getIntervalOnMinutes:function(n){var t=this,i=$.Deferred();switch(n.currentState){case t.PENDING_PLAN:n.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),n.dueDate)).done(function(r){$.when(t.getDifferenceBetweenDates(n.creationDate,Date.now())).done(function(n){i.resolve({minutesToShowTime:r,minutesCreateToNow:n})})}):n.dueDate<n.creationDate?$.when(t.getDifferenceBetweenDates(n.dueDate,n.creationDate)).done(function(r){$.when(t.getDifferenceBetweenDates(n.creationDate,Date.now())).done(function(n){i.resolve({minutesToShowTime:r+n,minutesCreateToNow:n})})}):n.dueDate>n.creationDate&&$.when(t.getDifferenceBetweenDates(n.creationDate,n.dueDate)).done(function(r){$.when(t.getDifferenceBetweenDates(n.dueDate,Date.now())).done(function(n){i.resolve({minutesToShowTime:r+n,minutesCreateToNow:n})})});break;case t.EXECUTING_PLAN:n.dueDate?n.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),n.dueDate)).done(function(r){$.when(t.getDifferenceBetweenDates(n.startDate,Date.now())).done(function(n){i.resolve({minutesToShowTime:r,minutesStartToNow:n})})}):$.when(t.getDifferenceBetweenDates(n.dueDate,Date.now())).done(function(r){$.when(t.getDifferenceBetweenDates(n.startDate,n.dueDate)).done(function(n){i.resolve({minutesToShowTime:r,minutesStartToDueDate:n})})}):$.when(t.getDifferenceBetweenDates(n.startDate,Date.now())).done(function(n){i.resolve({minutesToShowTime:n})});break;case t.CLOSED_PLAN:$.when(t.getDifferenceBetweenDates(n.startDate,n.closedDate)).done(function(n){i.resolve({minutesToShowTime:n})})}return i.promise()},getKeywordDifferenceDates:function(n){var t=this;switch(n.currentState){case t.PENDING_PLAN:return n.dueDate>Date.now()?"remaining":"exceeded";case t.EXECUTING_PLAN:return n.dueDate?n.dueDate>Date.now()?"remaining":"exceeded":"opened";case t.CLOSED_PLAN:return"executed"}},getRelativeTime:function(n){return bizagi.util.dateFormatter.getRelativeTime(n,null,!1)},getWidthBar:function(n,t){var r=this,u={},i,f;switch(n.currentState){case r.PENDING_PLAN:return n.dueDate?n.dueDate<Date.now()?0:(i=t.minutesCreateToNow+t.minutesToShowTime,valuePercentInterval=t.minutesToShowTime,Math.ceil(valuePercentInterval*100/i)):0;case r.EXECUTING_PLAN:return n.dueDate?n.dueDate>Date.now()?(i=t.minutesStartToNow+t.minutesToShowTime,valuePercentInterval=t.minutesToShowTime,Math.ceil(valuePercentInterval*100/i)):0:0;case r.CLOSED_PLAN:return n.closedDate>Date.now()?(f=n.closedDate-n.startDate,u=Date.now()-n.startDate,Math.ceil(u*100/f)):100}},getColorBarByPercent:function(n){return n<33?"Red":n<66?"Yellow":"Green"},callGetEffectiveDuration:function(n){var i=this,t=$.Deferred();return $.when(i.dataService.getEffectiveDuration(n)).done(function(n){t.resolve(n)}),t.promise()},getFormattedDate:function(n){var t=this,i=t.datePickerRegional.monthNames,r=n.getMonth();return i[r]+" "+bizagi.util.dateFormatter.formatDate(n,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.time],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.parent",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.parent").concat("#project-plan-parent")})},renderContent:function(){var n=this,t=n.getTemplate("plan-parent-main");return n.content=t.render({}),n.content},postRender:function(){var n=this;n.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(n.onNotifyLoadInfoSummaryPlan,n))},onNotifyLoadInfoSummaryPlan:function(n,t){var i=this,r=i.getContent().empty();i.params=$.extend(i.params,t.args);i.params.plan.parentWorkItem&&$.when(i.dataService.getPlanParent({idPlan:i.params.plan.id})).done(function(n){var t,u;if(i.params.plan.parent=n,i.params.plan.parent){t={idParent:i.params.plan.parent.radNumber,nameParent:i.params.plan.parent.displayName,idCase:i.params.plan.parent.idCase,idWorkflow:i.params.plan.parent.idWorkflow,idWorkItem:i.params.plan.parent.idWorkItem,idTask:i.params.plan.parent.idTask,processName:i.params.process?i.params.process:i.params.plan.parent.planName};r.empty();u=i.getTemplate("plan-parent-main");u.render(t).appendTo(r);$("#go-to-parent-case",r).on("click",$.proxy(i.onClickGoToParentCase,i))}}).fail(function(){})},onClickGoToParentCase:function(n){n.preventDefault();var t=this;t.routingExecute($(n.target).closest("#go-to-parent-case"))}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.parent],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.users",{},{init:function(n,t,i){var r=this;r.usersMap={};r.plugins={};r._super(n,t,i);r.loadTemplates({"plan-users-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users"),"plan-users-tooltip":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users-tooltip")})},renderContent:function(){var n=this,t=n.getTemplate("plan-users-main");return n.content=t.render({}),n.content},postRender:function(){var n=this;n.sub("LOAD_INFO_ACTIVITIES_PLAN",$.proxy(n.onNotifyLoadInfoSummaryPlan,n))},onNotifyLoadInfoSummaryPlan:function(n,t){var i=this,o=t.args,f=[],r=[],s=i.getContent().empty(),u=bizagi.currentUser.idUser,e;i.params=$.extend(i.params,t.args);r.push({idUser:u,userType:["owner"]});i.usersMap["-"+u+"-"]={picture:"",id:u,name:"",userType:["owner"]};f.push(u);$.each(i.params.plan.activities,function(n,t){var e=parseInt(t.userAssigned,0);e===u?$.inArray("Assigned",r[0].userType)===-1&&(r[0].userType.push("Assigned"),i.usersMap["-"+u+"-"].userType.push("Assigned")):(i.usersMap["-"+e+"-"]={picture:"",id:e,name:"",userType:["Assigned"]},r.filter(function(n){return n.idUser==e}).length===0&&(r.push({idUser:e,userType:["Assigned"]}),f.push(e)))});i.params=o;e=i.getTemplate("plan-users-main");e.render({owner:r[0],assignee:r.slice(1),label:bizagi.localization.getResource("workportal-project-plan-assignee")}).appendTo(s);i.plugins.tooltip=i.initilizeTooltip();$.when(i.callGetDataUsers(f)).then(function(){i.renderUserProfilesAndImages()})},renderUserProfilesAndImages:function(){var n=this;$.each(n.usersMap,function(t,i){var r=$(".ui-bizagi-wp-userlist li[data-iduser="+i.id+"]",n.content);i.picture!==""?(r.find("img").prop("src",i.picture),$(".bz-wp-avatar-label",r).hide()):i.name?($(".bz-wp-avatar-img",r).hide(),$(".bz-wp-avatar-label",r).html(i.name.getInitials())):console.log("obj.name is undefined")})},callGetDataUsers:function(n){var t=this,i={},r=$.Deferred();return i={userIds:n.join(),width:50,height:50},$.when(t.dataService.getUsersData(i)).always(function(n){for(var i=0,u=n.length;i<u;i+=1)typeof n[i].name=="undefined"?bizagi.log(n[i]+" Id Not Found",n,"error"):t.usersMap["-"+n[i].id+"-"]?(t.usersMap["-"+n[i].id+"-"].picture+=n[i].picture?"data:image/png;base64,"+n[i].picture:"",t.usersMap["-"+n[i].id+"-"].name=n[i].name||""):console.log("self.usersMap['-' + response[i].id + '-'] is undefined");r.resolve()}),r.promise()},initilizeTooltip:function(){var n=this;return $(".ui-bizagi-wp-userlist",n.content).kendoTooltip({filter:"li[data-iduser]",content:$.proxy(n.renderUserTooltip,n),showOn:"mouseenter"}).data("kendoTooltip")},renderUserTooltip:function(n){var t=this,u=t.getTemplate("plan-users-tooltip"),i=n.target.data("iduser"),r=[];return r=i!==0?[t.usersMap["-"+i+"-"]]:$.map(t.usersMap,function(n){if(n.userType.join().indexOf("owner")===-1)return n}),u.render({users:r})}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.users",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.users],!0);
