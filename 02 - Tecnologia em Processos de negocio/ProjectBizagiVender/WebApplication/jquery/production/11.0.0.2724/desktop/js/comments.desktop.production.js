bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu.activity",{},{init:function(n,t,i){var r=this;r.params=i||{};r._super(n,t,i);r.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.activity").concat("#project-dashboard-menu1")})},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.params.contextsLeftSidebarCaseDashboard.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))})},updateView:function(n,t){var i=this,r,u,f;i.params=$.extend(i.params,t.args);i.params.plan.idActivitySelected=undefined;i.clean();r=i.getContent().empty();typeof n.type!="undefined"&&(i.params.showContextByMenuDashboard=n.type);u={showFormOverview:i.params.menuDashboard.showFormOverview,showFormActivity:i.params.menuDashboard.showFormActivity,showCommentsOptionMenu:i.params.menuDashboard.showCommentsOptionMenu,showFilesOptionMenu:i.params.menuDashboard.showFilesOptionMenu,showTimeLineOptionMenu:i.params.menuDashboard.showTimeLineOptionMenu,showPlanOptionMenu:i.params.menuDashboard.showPlanOptionMenu,contextPlanOptionMenu:i.params.menuDashboard.contextPlanOptionMenu,contextFormActivityOptionMenu:i.params.menuDashboard.contextFormActivityOptionMenu};f=i.getTemplate("project-dashboard-menu");f.render(u).appendTo(r);i.params.showContextByMenuDashboard&&$("li[data-context='"+i.params.showContextByMenuDashboard.toUpperCase()+"']",i.content).addClass("active").siblings().removeClass("active");i.handlerEvents()},loadContentById:function(n){var t=this,r,i;n.preventDefault();r=$(n.target).closest("li");r.hasClass("active")||(i=r.data("context"),i&&$.when(bizagi.util.autoSave()).done(function(){$(document).data("auto-save","");var f=t.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),n=parseInt(f[0]),r="",u=n;i=="PLANACTIVITIES"&&(u=n+1,r=bizagi.localization.getResource("workportal-project-casedashboard-plan"));t.params.refreshLastItemBreadcrumb=!1;t.pub("notify",{type:i.toUpperCase(),args:$.extend(t.params,{showContextByMenuDashboard:i,histName:r,level:u})});$("li[data-context='"+t.params.showContextByMenuDashboard.toUpperCase()+"']",t.content).addClass("active").siblings().removeClass("active")}))},subMenuHandler:function(){var t=this,n=t.getContent(),i=$("[data-context='COMMENTS']",n),r=$("[data-context='FILES']",n),u=$("[data-context='TIMELINE']",n);$(".ui-bizagi-wp-project-tab-submenu a",n).on("click",function(){i.toggle();r.toggle();u.toggle()})},handlerEvents:function(){var n=this,t=n.getContent();n.subMenuHandler();$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(n.loadContentById,n));$(".ui-bizagi-wp-project-tab-links li .ui-bizagi-refresh-form",t).on("click",function(){var t={action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:n.params.idCase,idTask:n.params.idTask,idWorkflow:n.params.idWorkflow,idWorkItem:n.params.idWorkitem,referrer:n.params.referrer||"inboxGrid"};n.publish("executeAction",t)})},clean:function(){var n=this,t=n.getContent();n.params&&n.params.contextsLeftSidebarCaseDashboard&&n.params.contextsLeftSidebarCaseDashboard.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))});$(".ui-bizagi-wp-project-tab-links a",t).off();$(".ui-bizagi-wp-project-tab-links li .ui-bizagi-refresh-form",t).off()}});bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.activity",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu.activity],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var n=this,t=n.getTemplate("project-content-dashboard");return n.content=t.render({}),n.content},postRender:function(){var n=this;setTimeout(function(){$(window).trigger("resize")},1e3)}});bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0);
(function(n){var r=window.kendo,t=r.ui,i=t.Widget,u=i.extend({init:function(n,t){var r=this;i.fn.init.call(r,n,t);r._maxFilesSize=bizagi.currentUser.uploadMaxFileSize>r.options.maxFilesSize?bizagi.currentUser.uploadMaxFileSize:r.options.maxFilesSize;r._fileList=[];r._onlyValidateServerFileExtension=t.onlyValidateServerFileExtension||!0;r._supportFileExt=t.extensions;r._uploadMaxFilesSize=t.maxSize;r.upload=r._initUpload();r.loadNotifier=r._initLoadNotifier();r.notification=r._initNotification();r._eventsHandler();r._initLocalization(r.options.localization)},options:{name:"ProjectAttachments",wrapper:n('<div class="project-attachments"><\/div>'),multiple:!0,dropZone:!0,maxFilesSize:25e6,enabled:!0,localization:{}},_initUpload:function(){var n=this,t=n.options,i=t.localization||{},r=0;return n._initLocalization(i),this.element.kendoUpload({async:{saveUrl:t.saveUrl,autoUpload:!0},select:function(t){n._filterMaxFilesSize(t);r=0},complete:function(){var t=setInterval(function(){n.loadNotifier.wrapper.find("li.k-file-progress").length===0&&(n._showNotificationCompleteUpload(n.loadNotifier.wrapper,r),clearInterval(t))},300)},upload:t.upload,progress:function(t){n._onProgressFile(t)},success:function(i){n._fileList.push(i.files[0]);r+=1;t.success(i)},error:function(t){n.onErrorFile(t)},localization:{select:i.selectFiles,dropFilesHere:i.dropFilesHere},multiple:t.multiple,enabled:t.enabled,dropZone:t.dropZone,showFileList:!1}).data("kendoUpload")},_initNotification:function(){return n("<div><\/div>").kendoNotification({position:{pinned:!0}}).data("kendoNotification")},_initLoadNotifier:function(){var n=this,t=n.options.localization,i=n.options.wrapper;return i.kendoWindow({title:t.notifierTitle,actions:["Close"],animation:{open:{duration:100},close:{duration:100}},open:function(){this.wrapper.addClass("project-attachments-wrapper-window")},visible:!1,resizable:!1,draggable:!1,maxHeight:"300px",minWidth:"430px"}).data("kendoWindow")},_initLocalization:function(t){var i=this,r={selectFiles:bizagi.localization.getResource("workportal-project-attachments-addfiles"),notifierTitle:bizagi.localization.getResource("workportal-project-attachments-notifiertitle"),errorUpload:bizagi.localization.getResource("workportal-project-attachments-file-error-type"),errorSecurity:bizagi.localization.getResource("workportal-project-attachments-blockedext"),errorSize:bizagi.localization.getResource("workportal-project-attachments-blockedsize"),errorMaxFilesSize:bizagi.localization.getResource("workportal-project-discussion-maxfilessize").replace("%s",i._maxSize/1e6),dropFilesHere:bizagi.localization.getResource("workportal-project-attachments-drophere"),cancel:bizagi.localization.getResource("workportal-widget-reports-confirm-cancel"),retry:bizagi.localization.getResource("workportal-project-attachments-retry"),close:bizagi.localization.getResource("workportal-widget-dialog-box-close")};n.extend(t,r)},_onProgressFile:function(t){var u=this,i=u._getFileItemByUID(t.files[0].uid),r=t.percentComplete;n(".k-progress",i).css({width:r+"%"});n(".k-upload-pct",i).removeClass("k-icon k-loading").text(r+"%");r===100&&n(".k-upload-action .k-icon",i).hide()},_onShowUploadNotifier:function(n){var t=this,i=n.files,r=t.options.template;t.loadNotifier.content(r.render({files:i}));t.loadNotifier.wrapper.css({top:"auto",left:"auto",bottom:"1em",right:"1em"});t.loadNotifier.open()},_showNotificationCompleteUpload:function(n,t){var i=this;n.find("li.k-file-success").length===t&&n.find("li.k-file-error").length===0&&i._autoHideMessage(n)},_autoHideMessage:function(n){var t=this;setTimeout(function(){n.fadeOut(function(){t.loadNotifier.close()})},2e3)},_onCancelFile:function(n){var i=this,t=n.closest("li"),r=i.upload.wrapper,u=t.data("guid");r.find("li[data-uid="+u+"] .k-upload-action").trigger("click");t.remove()},_onRemoveFile:function(n){var t=n.closest("li");t.remove()},_onRetryFile:function(t){var i=this,r=t.closest("li"),u=r.data("guid"),f=n.grep(i._fileList,function(n){return n.uid===u});i.options.retry(f[0])},onErrorFile:function(n){var t=this,u=t.options.localization,i=n.files[0],r=t._isValidFile(i),f=r.message!==""?r.message:u.errorUpload;t.setStatus("ERROR",i.uid,f)},_isValidFile:function(t){var i=this,f=i.options.localization,r=!0,u="";return t.size>i._uploadMaxFilesSize&&(u=f.errorSize,r=!1),i._onlyValidateServerFileExtension||n.inArray(t.extension,i._supportFileExt)===-1&&(u=f.errorSecurity,r=!1),{valid:r,message:u}},_filterMaxFilesSize:function(n){for(var t=this,r=0,i=0,u=n.files.length;i<u;i++)r+=n.files[i].size;r>t._maxFilesSize?(t._notifySizeExceeded(),n.preventDefault()):t._onShowUploadNotifier(n)},_notifySizeExceeded:function(){var n=this;n.notification.show(n.options.localization.errorMaxFilesSize,"error")},_getFileItemByUID:function(t){var i=this;return n("li[data-guid="+t+"]",i.loadNotifier.element)},_switchEvents:function(t){var r=this,i=n(".k-icon",t.currentTarget);i.hasClass("k-update")||i.hasClass("k-remove")?r._onRemoveFile(i):i.hasClass("k-retry")?r._onRetryFile(i):i.hasClass("k-cancel")&&r._onCancelFile(i)},_eventsHandler:function(){var n=this;n.loadNotifier.element.on("click","button.k-upload-action",function(t){n._switchEvents(t)})},cancelFilesUpload:function(){var n=this,t=n.upload.wrapper;t.find("li .k-upload-action").trigger("click");n.close()},close:function(){this.loadNotifier.close()},destroy:function(){this.loadNotifier.destroy();this.upload.destroy()},setStatus:function(t,i,r){var u=this._getFileItemByUID(i),f=this.options.localization;switch(t){case"SUCCESS":u.removeClass("k-file-progress k-file-error").addClass("k-file-success");n(".k-upload-action .k-icon",u).removeClass("k-cancel k-i-refresh k-retry").addClass("k-update").prop("title",f.close).show();n(".k-errormsg",u).text("");break;case"ERROR":u.removeClass("k-file-progress").addClass("k-file-error");n(".k-upload-action .k-icon",u).removeClass("k-i-refresh k-retry").addClass("k-remove").show();n(".k-upload-status .k-upload-pct",u).removeClass("k-upload-pct k-loading").addClass("k-icon k-warning");n(".k-errormsg",u).text(r).prop("title",r);break;case"RETRY":u.removeClass("k-file-progress").addClass("k-file-error");n(".k-upload-status .k-upload-pct",u).removeClass("k-upload-pct k-loading").addClass("k-warning").text("");n(".k-upload-action .k-icon",u).removeClass("k-cancel k-remove").addClass("k-i-refresh k-retry").prop("title",f.retry).show();n(".k-errormsg",u).text(f.errorUpload).prop("title",f.errorUploadiis)}}});t.plugin(u)})(jQuery);
bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.discussions",{},{init:function(n,t,i,r){var u=this;u.typeResource="Discussion";u.plugins={};u.dialogBoxDiscussion={};u.attchComments={};u.attchDiscussions={remove:[],addition:[]};u.listDataDiscussion=[];u.userPictures=[];u.commentsList={};u.globalTags=[];u.tempTagsBeforeDelete=[];u.tempTagsToDelete=[];u.keySentenceAddTag=bizagi.localization.getResource("workportal-project-discussion-add-new-tag")+": ";u.notifier=i;u._super(n,t,r);u.loadTemplates({"project-discussions":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-wrapper"),"project-discussions-popup":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-popup-wrapper"),"project-discussions-list":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-list-wrapper"),"project-discussions-comments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-comments-list"),"project-discussions-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-attachments-list"),"project-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.attachments").concat("#project-attachments")})},renderContent:function(){var n=this,t=n.getTemplate("project-discussions");return n.content=t.render({}),n.content},postRender:function(){var n=this,i=n.getContent(),t;n.plugins.popupDiscussion=n.initPluginPopupDiscussion();t=n.plugins.popupDiscussion;n.form={buttonShowFormNewDiscussion:$(".ui-bizagi-wp-action-new",i),title:$(".ui-bizagi-wp-project-popupform-h4",t),subject:$("#ui-bizagi-wp-project-discussions-popup-subject-input",t),description:$("#ui-bizagi-wp-project-discussions-popup-description-textarea",t),buttonShowPopupDiscussionToAdd:$("#ui-bizagi-wp-project-discussions-button-action-show-popup-to-add",i),buttonAddDiscussion:$("#ui-bizagi-wp-project-discussions-popup-action-add-discussion",t),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",t),formDiscussion:$(".ui-bizagi-wp-project-discussions-popup",t),attachments:$(".ui-bizagi-wp-project-discussions-attachments-cmnwrapper",t),edition:!1};n.plugins.tagsFilter=n.initPluginTagsFilter();n.plugins.tagsMultiSelect=n.initPluginTagsMultiSelect(t);n.getDataDiscussions().done(function(){function r(n){for(var t,r={},u=[],f=n.length,e=0,i=0;i<f;i++)t=n[i],r[t]!==1&&(r[t]=1,u[e++]=t);return u}var t=$.map(n.listDataDiscussion,function(n){return n.user}),i=$.map(n.commentsList,function(n){return $.map(n.comments,function(n){return n.user})}),u=r(t.concat(i).concat(bizagi.currentUser.idUser)).join(",");n.getDataUsers(u).then(function(){n.renderUserProfilesAndImages()});n.setClassesTagsByDiscussion()});n.eventsHandler();n.restrictedEventsHandler()},onNotifyOpenPopup:function(){var n=this;n.form.edition=!1;n.showFormAddDiscussion("workportal-project-discussion-adddiscussion");n.renderUserProfile()},initPluginPopupDiscussion:function(){var n=this,t=n.getTemplate("project-discussions-popup");return n.dialogBoxDiscussion.formContent=t.render({attachments:[]}),n.dialogBoxDiscussion.formContent},initPluginTagsMultiSelect:function(n){var t=this,f=n.find("#ui-bizagi-wp-project-discussions-options-multiselect-tags"),i,r=!1,u=!1;return f.kendoMultiSelect({change:function(){var n=this.value().slice(0),f=this.dataSource.data(),i,e,o;n.length>0&&f[0].tag.replace(t.keySentenceAddTag,"").indexOf(n[n.length-1])!==-1&&(n[n.length-1]=f[0].tag.replace(t.keySentenceAddTag,""));n=n.filter(Boolean);n=n.filter(function(n,t,i){return i.indexOf(n)===t});i="";f.length>0&&f[0].tag.indexOf(t.keySentenceAddTag)!==-1&&(i=f[0].tag.replace(t.keySentenceAddTag,""),e={},n.indexOf(i)!==-1?(e=this.dataSource.at(0),r=!0,this.dataSource.remove(e),r=!1,this.refresh(),u=!0):i&&($("li:first",this.list).hasClass("k-state-focused")&&(u=!0,n.push(i)),e=this.dataSource.at(0),r=!0,this.dataSource.remove(e),r=!1));i&&u&&(o=this.dataSource.data().filter(function(n){return n.tag===i}),o.length===0&&this.dataSource.add({guid:i,tag:i}),u=!1);this.dataSource.filter({});this.value(n)},dataBound:function(){if((i||this._prev)&&i!==this._prev&&!r){i=this._prev;var n=this.dataSource.data(),u=!1;n.length>0&&n[0].tag.indexOf(t.keySentenceAddTag)!==-1&&(n[0].tag=t.keySentenceAddTag+i,this.refresh(),u=!0,$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused"));u||this.dataSource.insert(0,{tag:t.keySentenceAddTag+i,guid:i});this.dataSource.total()==0&&(this.search(),this.open(),this.refresh(),$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused"))}},dataSource:[],dataTextField:"tag",dataValueField:"guid",filter:"contains",animation:!1}).data("kendoMultiSelect")},initPluginTagsFilter:function(){var n=this,t=n.getContent();return $("#ui-bizagi-wp-project-discussions-options-tags-filter",t).kendoMultiSelect({change:function(){n.hideOrShowDiscussionsByFilter()},autoClose:!1,tagMode:"single",dataTextField:"tag",dataValueField:"guid"}).data("kendoMultiSelect")},hideOrShowDiscussionsByFilter:function(){var n=this,t=n.plugins.tagsFilter.value();t.length>0?($(".ui-bizagi-wp-project-discussions-item",n.getContent()).hide(),t.forEach(function(t){$(".ui-bizagi-wp-project-discussions-item."+t,n.getContent()).show()})):$(".ui-bizagi-wp-project-discussions-item",n.getContent()).show()},validateAddCommentForm:function(n){var i=!1,t=$("textarea",n),r;return t.val().trim()===""?(r=bizagi.localization.getResource("workportal-project-discussion-requiredcomment"),t.parent().next().find("span").html(r)):(t.parent().next().find("span").empty(),i=!0),i},validateAddDiscussionForm:function(n){var r=!1,t=$("#ui-bizagi-wp-project-discussions-popup-subject-input",n),i=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",n),u,f;return t.val().trim()!==""&&i.val().trim()!==""&&(r=!0),t.val().trim()===""?(u=bizagi.localization.getResource("workportal-project-discussion-subjectrequired"),t.parent().find("span").html(u)):t.parent().find("span").empty(),i.val().trim()===""?(f=bizagi.localization.getResource("workportal-project-discussion-requireddescription"),i.parent().next().find("span").html(f)):i.parent().next().find("span").empty(),r},applyFileAttachments:function(n){var t=this,i=n==="DISCUSSIONS"?t.plugins.popupDiscussion:t.getContent();return $(".ui-bizagi-wp-project-discussions-attachment-upload",i).kendoProjectAttachments({saveUrl:t.dataService.serviceLocator.getUrl("project-comments-uploadfiles"),template:t.getTemplate("project-attachments"),success:function(i){t.onSuccessFile(i,n)},upload:$.proxy(t.addFileData,t),dropZone:!1,extensions:t.supportFileExt,maxSize:t.uploadMaxFilesSize}).data("kendoProjectAttachments")},addFileData:function(n){var t=n.files[0].uid;n.files[0].guid=t;n.data={guid:t}},getDataDiscussions:function(){var n=this,t=$.Deferred(),i={globalParent:n.radNumber,typeResource:n.typeResource};return n.params.flowContext==="FLOW-DECONTEXTUALIZED-PLANS"&&(i.globalParent=n.params.plan.id),n.dataService.getDiscussionsData(i).pipe(function(t){return n.callForListComments(t)}).done(function(i){n.listDataDiscussion=n.sortDiscussions(i);n.updateTemplateListDiscussion();t.resolve()}),t.promise()},getDataUsers:function(n){var t=this,i=$.Deferred(),r={userIds:n,width:50,height:50};return r.userIds?t.dataService.getUsersData(r).always(function(n){function r(n){for(var i,t=n.concat(),r=0;r<t.length;++r)for(i=r+1;i<t.length;++i)t[r]===t[i]&&t.splice(i--,1);return t}t.userPictures=r(t.userPictures.concat(n));i.resolve()}):i.resolve(),i.promise()},callForListComments:function(n){for(var r,e,t=this,u=$.Deferred(),f=[],i=0,o=n.length-1;i<=o;i++)t.addGlobalTags(n[i].tags,!1),r={idParent:n[i].guid,dateTime:t.getDateServer(),count:6},t.commentsList[r.idParent]={comments:[],count:0,total:0},e=$.when(t.dataService.getCommentsData(r)).done(function(n){n.length>0&&(t.commentsList[n[0].parent]={comments:n,count:n.length,total:0})}),f.push(e);return $.when.apply($,f).done(function(){u.resolve(n)}),u.promise()},sortDiscussions:function(n){var t=[];return n.length&&(t=n.sort(function(n,t){var i=n.date,r=t.date;return r-i}),t.length>0&&t.unshift(t.pop())),t},resetDiscussionAttachments:function(){var n=this,t=n.plugins.popupDiscussion;$(".ui-bizagi-wp-project-attachments-list",t).empty();n.plugins.tagsMultiSelect.value([]);n.attchDiscussions.addition=[];n.attchDiscussions.remove=[]},sendDataUpdateDiscussion:function(n){var t=this,r=t.prepareFilesToSave();t.form.buttonAddDiscussion.prop("disabled",!0);var u=t.getTagsDiscussionBySave(),f=t.getGuidsTagsDiscussionToDelete(),i={content:{name:t.form.subject.val(),description:t.form.description.val(),globalParent:t.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:r.attachments,guid:n,tags:u,typeResource:"Discussion",general:!1,date:t.getDateServer()},attachmentsToCreate:r.attachmentsToCreate,attachmentsToDelete:r.attachmentsToDelete};t.plugins.attchDiscussions.close();t.dataService.editDiscussion(i).always(function(r){if(r.status===200||r.status===201||r.status===undefined){t.addGlobalTags(u,!0);var e=t.getDiscussionDataByGUID(n);e.name=i.content.name;e.description=i.content.description;e.attachments=i.content.attachments;e.tags=i.content.tags;t.onClosePopupDiscussion();t.resetDiscussionAttachments();t.updateTemplateListDiscussion();t.removeGlobalTags(f);t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-edited"),""))}else t.form.buttonAddDiscussion.prop("disabled",!1),t.onClosePopupDiscussion(),t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-edition"),""));t.renderUserProfilesAndImages();t.setClassesTagsByDiscussion();t.hideOrShowDiscussionsByFilter()})},validateStringIsGuid:function(n){return/^({|()?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}(}|))?$/.test(n)&&!/^({|()?0{8}-(0{4}-){3}0{12}(}|))?$/.test(n)},sendDataInsertDiscussion:function(n){var t=this,r=t.prepareFilesToSave(),u,i;t.form.buttonAddDiscussion.prop("disabled",!0);u=t.getTagsDiscussionBySave();i={content:{name:t.form.subject.val(),description:t.form.description.val(),globalParent:t.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:r.attachments,guid:n,tags:u,typeResource:"Discussion",general:!1,date:t.getDateServer()},attachmentsToCreate:r.attachmentsToCreate,attachmentsToDelete:r.attachmentsToDelete};t.plugins.attchDiscussions.close();t.dataService.postDiscussion(i).always(function(n){if(n.status===200||n.status===201||n.status===undefined){t.addGlobalTags(u,!0);t.form.buttonAddDiscussion.prop("disabled",!1);var r={name:i.content.name,description:i.content.description,date:i.content.date,user:i.content.user,attachments:i.content.attachments,radNumber:i.content.globalParent,general:i.content.general,guid:i.content.guid,tags:i.content.tags,typeResource:i.content.typeResource};t.commentsList[i.content.guid]={comments:[],count:0,total:0};t.listDataDiscussion.length===0?t.listDataDiscussion.push(r):t.listDataDiscussion.splice(1,0,r);t.resetDiscussionAttachments();t.onClosePopupDiscussion();t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-created"),""));t.updateTemplateListDiscussion()}else t.form.buttonAddDiscussion.prop("disabled",!1),t.onClosePopupDiscussion(),t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-creation"),""));t.renderUserProfilesAndImages();t.setClassesTagsByDiscussion();t.hideOrShowDiscussionsByFilter()})},getTagsDiscussionBySave:function(){var n=this,r=n.plugins.tagsMultiSelect.value(),t=n.plugins.tagsMultiSelect.dataSource.data(),i=[];return r.forEach(function(r){var f=n.validateStringIsGuid(r),u;u=f?t.filter(function(n){return n.guid===r}):t.filter(function(t){var i=n.validateStringIsGuid(t.guid);return t.tag===r&&!i});u.length===1&&i.push({guid:f?u[0].guid:u[0].uid,tag:u[0].tag})}),i},differenceArrays:function(n,t){return n.filter(function(n){return t.indexOf(n)<0})},getGuidsTagsDiscussionToDelete:function(){var n=this,t=n.plugins.tagsMultiSelect.value();return n.differenceArrays(n.tempTagsBeforeDelete,t)},setStateUIShowMoreComments:function(n,t){var i=n.siblings(".ui-bizagi-wp-project-discussion-showmore-comments"),r=i.find(".ui-bizagi-wp-project-discussion-showmore-comments-button"),u=i.find(".ui-bizagi-wp-project-discussion-showmore-no-more-comments"),f=i.find(".ui-bizagi-wp-project-discussion-showmore-loading-comments");t==="ALLOW_MORE_COMMENTS"&&(r.show(),u.hide(),f.hide());t==="LOADING_MORE_COMMENTS"&&(r.hide(),u.hide(),f.show());t==="NO_MORE_COMMENTS"&&(r.hide(),u.show(),f.hide())},getCurrentUserInfo:function(){return{name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser,picture:""}},addGlobalTags:function(n,t){for(var u,i=this,r=0;r<n.length;r+=1)u=i.globalTags.filter(function(t){return t.tag===n[r].tag}),u.length===0&&(n[r].globalParent=i.radNumber,i.globalTags.push(n[r]),t&&i.dataService.postTag(n[r]));i.plugins.tagsFilter.dataSource.data(i.globalTags);i.plugins.tagsMultiSelect.dataSource.data(i.globalTags)},removeGlobalTags:function(n){var t=this,r=$.map(t.listDataDiscussion,function(n){return $.map(n.tags,function(n){return n.guid})}),u=r.concat(n),i=[];n.forEach(function(n){var t=u.filter(function(t){return t===n});t.length===1&&i.push(n)});i.forEach(function(n){var r={idTag:n},i;for(t.dataService.deleteTag(r),i=t.globalTags.length-1;i>=0;i-=1)t.globalTags[i].guid===n&&t.globalTags.splice(i,1)});t.plugins.tagsFilter.dataSource.data(t.globalTags);t.plugins.tagsMultiSelect.dataSource.data(t.globalTags)},setClassesTagsByDiscussion:function(){for(var i,r,n=this,t=0;t<n.listDataDiscussion.length;t+=1)i=$.map(n.listDataDiscussion[t].tags,function(n){return n.guid}),r=i.join(" "),$(".ui-bizagi-wp-project-discussions-item[data-guid='"+n.listDataDiscussion[t].guid+"']",n.getContent()).addClass(r)},updateTemplateListDiscussion:function(){var n=this,t=n.getContent(),i=n.getTemplate("project-discussions-list"),r=n.getCurrentUserInfo(),u=i.render({listDataDiscussions:n.listDataDiscussion,user:r,isOpen:!bizagi.util.parseBoolean(n.params.isClosedForAllUsers),returnServedCommentByParentId:function(t){return n.returnServedCommentByParentId(t)}});$("#ui-bizagi-wp-project-discussions-list-wrapper",t).empty().append(u);n.plugins.attchComments=n.applyFileAttachments("COMMENTS")},showFormAddDiscussion:function(n){var t=this;t.plugins.attchComments&&t.plugins.attchComments.close();t.dialogBoxDiscussion.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"650px",modal:!0,zIndex:1,title:bizagi.localization.getResource(n),maximize:!0,open:$.proxy(t.onOpenPopupDiscussion,t),close:function(){t.resetDiscussionAttachments();t.onClosePopupDiscussion()}})},resetFormDiscussion:function(){var n=this,t,i;n.form.buttonAddDiscussion.prop("disabled",!1);n.form.subject.val("");n.form.description.val("");t=$("#ui-bizagi-wp-project-discussions-popup-subject-input",n.dialogBoxDiscussion.formContent);i=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",n.dialogBoxDiscussion.formContent);t.parent().find("span").empty();i.parent().next().find("span").empty()},renderUserProfile:function(){var r=this,n=$.grep(r.userPictures,function(n){return n.id===bizagi.currentUser.idUser})[0],t=$(".ui-bizagi-wp-project-popupform-user"),i=t.find(".bz-wp-avatar-img"),u=t.find(".bz-wp-avatar-label");n&&(n.picture?i.attr("src","data:image/png;base64,"+n.picture):(i.hide(),u.html(n.name.getInitials()).show()))},renderUserProfilesAndImages:function(){var t=this,i=$.grep(t.userPictures,function(n){return n.id===bizagi.currentUser.idUser})[0],r="data:image/png;base64,",n;for(i&&($(".ui-bizagi-wp-project-discussions-create-comment .bz-wp-discussion-username").html(i.name),i.picture?($(".ui-bizagi-wp-project-discussions-item-user img").attr("src",r+i.picture),$(".ui-bizagi-wp-project-popupform-image-current-user").attr("src",r+i.picture)):($(".ui-bizagi-wp-project-discussions-item-user label.bz-wp-avatar-label").html(i.name.getInitials()).show(),$(".ui-bizagi-wp-project-discussions-item-user img").hide())),n=0;n<t.userPictures.length;n++)$("div[data-iduser='"+t.userPictures[n].id+"'] .bz-wp-discussion-username").html(t.userPictures[n].name),t.userPictures[n].picture?$("div[data-iduser='"+t.userPictures[n].id+"'] .bz-wp-avatar-img").attr("src",r+t.userPictures[n].picture):($("div[data-iduser='"+t.userPictures[n].id+"'] .bz-wp-avatar-img").hide(),$("div[data-iduser='"+t.userPictures[n].id+"'] label.bz-wp-avatar-label").html(t.userPictures[n].name.getInitials()))},switchCommentsEvents:function(n){var i=this,t=$(n.target),r=t.parent(),u,f;if(t.is("textarea"))i.onShowButtonsPanel(t);else if(t.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-cancel"))i.onCancelComment(t);else if(t.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-share")){if(u=t.closest(".ui-bizagi-wp-project-discussions-add-comment"),i.validateAddCommentForm(u)){f=Math.guid();i.onCreateComment(t,f)}}else if(t.hasClass("ui-bizagi-wp-project-discussions-comment-view"))i.onViewComment(t);else if(t.hasClass("ui-bizagi-wp-project-discussion-showmore-comments-button"))i.onViewMoreComments(t);else if(t.hasClass("bz-bizagi-wp-project-discussions-attachment-delete"))i.onRemoveFiles(t);else if(r.hasClass("biz-wp-user-icon-admin")&&r.hasClass("biz-wp-action-edit-discussion"))i.onEditDiscussion(t);else if(r.hasClass("ui-bizagi-wp-project-discussion-delete"))$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-discussion-querydelete"),"","info")).done(function(){i.onDeleteComment(r)});else if(r.hasClass("bz-bizagi-wp-project-discussions-attachment-itemwrapper"))i.onDownloadAttachment(t.closest("li"));n.stopPropagation()},onEditDiscussion:function(n){var t=this,i=n.closest(".ui-bizagi-wp-project-discussions-item"),r=i.data("guid");t.setDiscussionsDataByGUID(r);t.showFormAddDiscussion("workportal-project-discussion-edit")},setDiscussionsDataByGUID:function(n){var t=this,i=t.getDiscussionDataByGUID(n),u=$(".ui-bizagi-wp-project-attachments-list",t.form.attachments),r;t.form.edition={guid:n};t.attchDiscussions={addition:i.attachments,remove:[]};t.form.title.text(bizagi.localization.getResource("workportal-project-discussion-edit"));t.form.subject.val(i.name);t.form.description.val(i.description);r=$.map(i.tags,function(n){return n.guid});t.plugins.tagsMultiSelect.value(r);t.tempTagsBeforeDelete=[];t.tempTagsBeforeDelete=t.tempTagsBeforeDelete.concat(t.plugins.tagsMultiSelect.value());t.renderAttachments(i.attachments,"DISCUSSIONS",u)},getDiscussionDataByGUID:function(n){for(var i=this,r,t=i.listDataDiscussion.length-1;t>=0;t--)i.listDataDiscussion[t].guid===n&&(r=i.listDataDiscussion[t],t=0);return r},onViewComment:function(n){var t=n.closest(".ui-bizagi-wp-project-discussions-comment-truncatewrapper");t.toggleClass("ui-bizagi-wp-project-discussions-comment-shortcomment");t.toggleClass("ui-bizagi-wp-project-discussions-comment-longcomment")},onViewMoreComments:function(n){var t=this,u=n.closest(".ui-bizagi-wp-project-discussion-showmore-comments"),r=u.siblings(".ui-bizagi-wp-project-discussion-comment-list"),i=r.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid");t.commentsList[i].total?t.getMoreComments(i,r):t.dataService.getCommentsCountByParent(i).done(function(n){t.commentsList[i].total=n.count;t.getMoreComments(i,r)})},getMoreComments:function(n,t){var i=this,r;i.commentsList[n].total>i.commentsList[n].comments.length?(i.setStateUIShowMoreComments(t,"LOADING_MORE_COMMENTS"),r=i.commentsList[n].comments.length===0?i.getDateServer():i.commentsList[n].comments[i.commentsList[n].comments.length-1].date,r-=1,i.dataService.getCommentsData({dateTime:r,idParent:n,count:6}).done(function(r){if(r.length){Array.prototype.push.apply(i.commentsList[n].comments,r);i.commentsList[n].count+=r.length;i.renderCommentByDiscussion(t,n,r);i.renderUserProfilesAndImages();r.length>5?i.setStateUIShowMoreComments(t,"ALLOW_MORE_COMMENTS"):i.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS");var u=$.map(i.userPictures,function(n){return n.id}),f=$.map(i.commentsList,function(n){return $.map(n.comments,function(n){return n.user})}),e=$(f).not(u).get(),o=e.join(",");i.getDataUsers(o).then(function(){i.renderUserProfilesAndImages()})}else i.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS")}).fail(function(){i.setStateUIShowMoreComments(t,"ALLOW_MORE_COMMENTS")})):i.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS")},renderCommentByDiscussion:function(n,t,i){var r=this,e=r.getTemplate("project-discussions-comments"),u,f={comments:[],user:r.getCurrentUserInfo(),isOpen:!bizagi.util.parseBoolean(r.params.isClosedForAllUsers)};i.length?(f.comments=i,u=e.render(f),n.append(u)):(f.comments=r.commentsList[t].comments,u=e.render(f),n.html(u))},getCommentByGuid:function(n,t){for(var f,u,e,o=this,r=o.commentsList[n].comments,i=0,s=r.length;i<s;i++)if(r[i].guid===t){for(f=[],u=0,e=r[i].attachments.length;u<e;u++)f.push(r[i].attachments[u].guid);return{attachments:f,index:i}}return{}},returnServedCommentByParentId:function(n){var t=this;if(typeof t.commentsList[n]!="undefined")return t.commentsList[n]},onShowButtonsPanel:function(n){var t=n.closest(".ui-bizagi-wp-project-discussions-add-comment").find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper");t.show()},onRemoveFiles:function(n){var r=this,u=n.closest("li"),h=u.closest(".ui-bizagi-wp-project-attachments-list").data("type"),c=u.data("fileguid"),i,f,s,e,t,o;for(h==="COMMENT"?(e=u.closest(".ui-bizagi-wp-project-discussions-add-comment").data("guid"),i=r.attchComments[e].addition,f=r.attchComments[e].remove):(i=r.attchDiscussions.addition,f=r.attchDiscussions.remove),t=0,o=i.length-1;t<=o;t++)i[t].guid===c&&(s=i.splice(t,1),f.push(s[0].guid),t=o);u.remove()},onDeleteComment:function(n){var t=this,i=n.closest(".ui-bizagi-wp-project-discussions-item-comment"),r=i.data("cmmtguid"),u=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid"),f=t.getCommentByGuid(u,r),e={content:{guid:r},attachmentsToDelete:f.attachments};$.when(t.dataService.deleteComment(e)).always(function(n){n.status===200||typeof n.status=="undefined"?(t.commentsList[u].comments.splice(f.index,1),i.remove()):t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-errordelete"),""))})},onSuccessFile:function(n,t){var i=this,r=n.files,o=n.XMLHttpRequest.response?JSON.parse(n.XMLHttpRequest.response):{},f,e,u;if(o.error)if(t==="DISCUSSIONS")i.plugins.attchDiscussions.onErrorFile(n);else i.plugins.attchComments.onErrorFile(n);else{if(f=$(n.sender.element).closest(".ui-bizagi-wp-project-discussion-textwrapper"),e=f.find(".ui-bizagi-wp-project-attachments-list"),t==="DISCUSSIONS")i.plugins.attchDiscussions.setStatus("SUCCESS",r[0].guid),Array.prototype.push.apply(i.attchDiscussions.addition,r);else{i.plugins.attchComments.setStatus("SUCCESS",r[0].guid);u=f.data("guid");i.attchComments[u]?Array.prototype.push.apply(i.attchComments[u].addition,r):i.attchComments[u]={addition:r,remove:[]};i.onShowButtonsPanel(e.parent())}i.renderAttachments(r,t,e)}},onDownloadAttachment:function(n){var r=this,t=n.data("fileguid"),i;t!==""&&(i=n.find(".bz-bizagi-wp-project-discussions-attachment-filename").text(),r.dataService.getDownloadAttachment(t,i))},onCancelComment:function(n){var i=this,t=n.closest(".ui-bizagi-wp-project-discussions-add-comment"),r=t.find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),u=t.find("textarea"),f=t.find(".ui-bizagi-wp-project-discussions-add-attachments form"),e=t.find(".k-tooltip-validation"),o=t.find(".ui-bizagi-wp-project-attachments-list"),s=t.data("guid");i.attchComments[s]={addition:[],remove:[]};i.plugins.attchComments.cancelFilesUpload();f[0].reset();o.empty();u.val("");e.hide();r.hide()},onCreateComment:function(n,t){var i=this,s=n.closest(".ui-bizagi-wp-project-discussions-item-comment"),h=n.closest(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),u=n.closest(".ui-bizagi-wp-project-discussions-add-comment"),e=u.find("textarea"),c=u.find(".ui-bizagi-wp-project-attachments-list"),o=u.data("guid"),f=i.prepareFilesToSave("COMMENTS",o),r={content:{guid:t,attachments:f.attachments,text:e.val(),parent:o,date:i.getDateServer(),user:bizagi.currentUser.idUser},attachmentsToCreate:f.attachmentsToCreate,attachmentsToDelete:f.attachmentsToDelete};$.when(i.dataService.postComment(r)).always(function(n){if(n.status===200||n.status===201||n.status===undefined){var u=s.siblings(".ui-bizagi-wp-project-discussion-comment-list"),t={user:r.content.user,attachments:r.content.attachments,text:r.content.text,guid:r.content.guid,parent:r.content.parent,date:r.content.date};i.attchComments[r.content.parent]={addition:[],remove:[]};e.val("");c.empty();h.hide();i.commentsList[t.parent].comments.unshift(t);i.renderCommentByDiscussion(u,t.parent,[]);i.plugins.attchComments.close();i.renderUserProfilesAndImages()}})},renderAttachments:function(n,t,i){var r=this,u=r.getTemplate("project-discussions-attachments"),f=u.render({attachments:n,type:t});i.append(f)},prepareFilesToSave:function(n,t){var u=this,f=[],i=n==="COMMENTS"?u.attchComments[t]:u.attchDiscussions,e=[],r,o;for(i=i||{addition:[],remove:[]},r=0,o=i.addition.length-1;r<=o;r++)f.push({guid:i.addition[r].guid,name:i.addition[r].name}),e.push(i.addition[r].guid);return{attachments:f,attachmentsToCreate:e,attachmentsToDelete:i.remove}},onClickCancel:function(n){n.preventDefault();var t=this;t.resetDiscussionAttachments();t.onClosePopupDiscussion();t.plugins.attchDiscussions.cancelFilesUpload()},onClosePopupDiscussion:function(){var n=this;n.resetFormDiscussion();n.plugins.attchDiscussions.destroy();n.dialogBoxDiscussion.formContent.dialog("destroy");n.dialogBoxDiscussion.formContent.detach()},onOpenPopupDiscussion:function(){var n=this;n.plugins.attchDiscussions=n.applyFileAttachments("DISCUSSIONS");n.dialogBoxDiscussion.formContent.parent().css("z-index",10001);n.dialogBoxDiscussion.formContent.parent().parent().find(".ui-widget-overlay").css("z-index",10001);setTimeout(function(){n.form.subject.focus()},50)},onSubmitFormDiscussion:function(n){n.preventDefault();var t=this,i;t.validateAddDiscussionForm(t.dialogBoxDiscussion.formContent)&&(t.form.edition.guid?(i=t.form.edition.guid,$.proxy(t.sendDataUpdateDiscussion(i),t)):(i=Math.guid(),$.proxy(t.sendDataInsertDiscussion(i),t)))},restrictedEventsHandler:function(){var n=this,t=n.getContent();$("#ui-bizagi-wp-project-discussions-list-wrapper",t).on("click",".bz-bizagi-wp-project-discussions-attachment-itemwrapper",$.proxy(n.switchCommentsEvents,n))},eventsHandler:function(){var n=this,t=n.getContent();n.form.buttonShowFormNewDiscussion.on("click",$.proxy(n.onNotifyOpenPopup,n));n.form.buttonCancel.on("click",$.proxy(n.onClickCancel,n));n.form.buttonAddDiscussion.on("click",$.proxy(n.onSubmitFormDiscussion,n));n.form.attachments.on("click",".bz-bizagi-wp-project-discussions-attachment-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper",function(t){if($(t.target).hasClass("bz-bizagi-wp-project-discussions-attachment-delete"))n.onRemoveFiles($(t.target));else n.onDownloadAttachment($(t.target).closest("li"));t.stopPropagation()});$("#ui-bizagi-wp-project-discussions-list-wrapper",t).on("click",".ui-bizagi-wp-project-discussions-add-comment textarea, .ui-bizagi-wp-project-discussions-comment-buttons-cancel, .ui-bizagi-wp-project-discussions-comment-buttons-share, .ui-bizagi-wp-project-discussion-showmore-comments button, .bz-bizagi-wp-project-discussions-attachment-delete, .ui-bizagi-wp-project-discussion-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper, .ui-bizagi-wp-project-discussions-comment-view, .ui-bizagi-wp-project-discussions-items-edition, .biz-wp-action-edit-discussion",$.proxy(n.switchCommentsEvents,n));n.sub("changeProjectWidget",function(){n.resetWidget()});n.sub("OPEN_POPUP_DISCUSSION",$.proxy(n.onNotifyOpenPopup,n))},resetWidget:function(){var n=this;n.userPictures=[];n.plugins.attchComments&&n.plugins.attchComments.close()},clean:function(){var n=this,t;n.resetWidget();n.form&&n.form.buttonShowFormNewDiscussion&&n.form.buttonShowFormNewDiscussion.off("click",$.proxy(n.onNotifyOpenPopup,n));for(t in n.plugins)n.plugins[t]&&n.plugins[t].hasOwnProperty("destroy")&&n.plugins[t].destroy&&n.plugins[t].destroy()}});bizagi.injector.register("bizagi.workportal.widgets.project.discussions",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.discussions],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.discussion.sidebar",{},{init:function(n,t,i){var r=this;r._super(n,t,i);i=i||{};i.supportNav=!1;r.loadTemplates({"project-discussion-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussion.sidebar").concat("#project-discussion-sidebar")})},renderContent:function(){var n=this,t=n.getTemplate("project-discussion-sidebar");return n.content=t.render({isOpen:!bizagi.util.parseBoolean(n.params.isClosedForAllUsers)}),n.content},postRender:function(){var n=this,t=n.getContent();$(".ui-bizagi-wp-project-discussions-sidebar-action-add > a",t).on("click",$.proxy(n.onShowPopupDiscussion,n))},onShowPopupDiscussion:function(){var n=this;n.pub("notify",{type:"OPEN_POPUP_DISCUSSION",args:{}})}});bizagi.injector.register("bizagi.workportal.widgets.project.discussion.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.discussion.sidebar],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.caseState",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.contextsSidebarActivity=i.contextsSidebarActivity;r.datePickerRegional=bizagi.localization.getResource("datePickerRegional");r.loadTemplates({"project-caseState":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.caseState").concat("#project-caseState-wrapper"),"project-caseState-popup-release":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.caseState").concat("#project-caseState-popup-release"),"project-caseState-remaining":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.caseState").concat("#project-caseState-remaining")});r.releaseDialogBox={}},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.releaseDialogBox.formContent=n.getTemplate("project-caseState-popup-release").render({}),n.content},postRender:function(){var n=this,t=n.contextsSidebarActivity||[];t.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))});n.plugins={};n.plugins.popupRelease={form:{buttonAccept:$("#button-accept-release",n.releaseDialogBox.formContent),buttonCancel:$("#button-cancel-release",n.releaseDialogBox.formContent)}};n.plugins.popupRelease.form.buttonAccept.on("click",$.proxy(n.onClickAcceptRelease,n));n.plugins.popupRelease.form.buttonCancel.on("click",$.proxy(n.onClickCancelRelease,n))},updateView:function(n,t){var i=this,r,u,f,s;if($.extend(i.params,t.args),r=t.args,i.getContent().empty(),u={},u.isFavoriteCase="off",u.isFavoriteCase=r.isFavorite&&JSON.parse(r.isFavorite)?"bz-icon-star":"bz-icon-star-outline",i.showCaseNumber(r,u),r.creationDate){var e="MM/dd/yyyy H:mm",h=r.creationDate,o=bizagi.util.dateFormatter.getDateFromFormat(h,e);u.creationDateFormat=i.getFormattedDate(o);f=bizagi.util.dateFormatter.getDateFromFormat(r.solutionDate,e);u.solutionDateFormat=i.getFormattedDate(f);s=new Date;i.calculateDataForTemplate(u,o,s,f,r)}$(i.getContent()).on("click",".show-diagram-case",function(){i.showGraphicQuery({idCase:i.params.idCaseForGraphicQuery||i.params.idCase,idWorkflow:i.params.idWorkflow})})},calculateDataForTemplate:function(n,t,i,r,u){var e=this,o=e.getContent(),f={};f.idUser=bizagi.currentUser.idUser;bizagi.util.parseBoolean(u.isOpen)?(f.fromDate=t.getTime(),f.toDate=i.getTime()):(f.fromDate=r.getTime(),f.toDate=i.getTime());$.when(e.callGetEffectiveDuration(f)).done(function(t){var i=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-t.minutes*6e4),null,!1),r;bizagi.util.parseBoolean(u.isOpen)?(n.relativeTimeState=bizagi.localization.getResource("workportal-project-case-state-opened").replace("%s",i),n.colorStateCase="Opened"):(n.relativeTimeState=bizagi.localization.getResource("workportal-project-case-state-closed").replace("%s",i),n.colorStateCase="Closed");n.percentCompleteBar=100;n.isOpen=bizagi.util.parseBoolean(u.isOpen);r=e.getTemplate("project-caseState-remaining");r.render($.extend(u,n)).appendTo($("#ui-bizagi-remaining",o));u.currentState.length>0&&e.initilizeActionMenu(u.currentState)})},showCaseNumber:function(n,t){var i=this,r=i.getContent(),u=i.getTemplate("project-caseState");u.render($.extend(n,t,{security:bizagi.menuSecurity})).appendTo(r);$(".case-summary-favorite",r).on("click",$.proxy(i.onClickFavorite,i));$(".case-summary-back",i.content).on("click",$.proxy(i.goToCase,i,"back"));$(".case-summary-next",i.content).on("click",$.proxy(i.goToCase,i,"next"));i.showBackNextNavigation()},getFormattedDate:function(n){var t=this,i=t.datePickerRegional.monthNames,r=n.getMonth();return i[r]+" "+$.datepicker.formatDate("dd",n)},onClickFavorite:function(n){n.preventDefault();var t=this,i={};$(n.target).hasClass("bz-icon-star-outline")?(i={idObject:t.params.idCase,favoriteType:"CASES"},$.when(t.dataService.addFavorite(i)).done(function(i){t.params.guidFavorite=i.idFavorites;$(n.target).removeClass("bz-icon-star-outline");$(n.target).addClass("bz-icon-star")})):(i={idObject:t.params.guidFavorite,favoriteType:"CASES"},$.when(t.dataService.delFavorite(i)).done(function(){$(n.target).addClass("bz-icon-star-outline");$(n.target).removeClass("bz-icon-star")}))},initilizeActionMenu:function(n){var t=this,i=bizagi.util.parseBoolean(n[0].allowsReassign)||!1,r=bizagi.util.parseBoolean(n[0].allowReleaseActivity)||!1,u=$("#bt-case-action-reassing",t.content),f=$("#bt-case-action-release",t.content);i&&u.show();r&&f.show();(i||r)&&($(".ui-bizagi-wp-project-plan-action-menu",t.content).show(),$(".ui-bizagi-wp-project-plan-action-menu",t.content).menu({select:$.proxy(t.onSelectMenu,t)}).removeClass("ui-widget-content"))},onSelectMenu:function(n,t){var i=this,r;if($(n.currentTarget).find("i").length===0){r=$(t.item).data("item");switch(r){case"reassing":i.onClickMenuReasign();break;case"release":i.onClickMenuRelease()}}},onClickMenuReasign:function(){var n=this,t=n.params.idCase,i=n.params.idWorkitem;$.when(n.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_REASSIGN_CASE,data:{idCase:t,idWorkItem:i},closeVisible:!1,maximize:!0,modalParameters:{title:bizagi.localization.getResource("render-actions-reassign"),width:"910px",id:"CaseAdmin"}}))},onClickMenuRelease:function(){var n=this;n.releaseDialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"660px",modal:!0,title:bizagi.localization.getResource("workportal-widget-dialog-box-release-ok"),maximize:!0,close:function(){n.releaseDialogBox.formContent.dialog("destroy");n.releaseDialogBox.formContent.detach()}})},onClickAcceptRelease:function(){var n=this,t={idCase:n.params.idCase,idWorkItem:n.params.idWorkitem};$.when(n.dataService.releaseActivity(t)).done(function(i){var u=i.status?i.status:"",r;switch(u){case"Success":n.publish("changeWidget",{widgetName:bizagi.workportal.currentInboxView});break;case"ConfigurationError":r=n.getResource("workportal-widget-dialog-box-release-configuration-error-message").replace("{0}",t.idWorkItem);bizagi.showMessageBox(r,n.getResource("workportal-widget-dialog-box-release-error"),"error",!1);break;default:r=n.getResource("workportal-widget-dialog-box-release-error-message").replace("{0}",t.idWorkItem);bizagi.showMessageBox(r,n.getResource("workportal-widget-dialog-box-release-error"),"error",!1)}}).fail(function(){var i=n.getResource("workportal-widget-dialog-box-release-error-message").replace("{0}",t.idWorkItem);bizagi.showMessageBox(i,n.getResource("workportal-widget-dialog-box-release-error"),"error",!1)});n.releaseDialogBox.formContent.dialog("destroy");n.releaseDialogBox.formContent.detach()},onClickCancelRelease:function(){var n=this;n.releaseDialogBox.formContent.dialog("destroy");n.releaseDialogBox.formContent.detach()},callGetEffectiveDuration:function(n){var i=this,t=$.Deferred();return n.fromDate?$.when(i.dataService.getEffectiveDuration(n)).done(function(n){t.resolve(n)}):t.resolve(null),t.promise()},clean:function(){var n=this,t;$(".show-diagram-case",n.getContent()).off();t=n.contextsSidebarActivity||[];this.params={};t.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))})},goToCase:function(n){var t=this,i=n=="back"?t.getBackCase():t.getNextCase();i>0&&t.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:i})},getListKey:function(){var t=this,n;if(bizagi.lstIdCases=bizagi.lstIdCases||{},bizagi.lstIdCases.length>1)for(n=0;n<bizagi.lstIdCases.length;n++)if(t.params.idCase==bizagi.lstIdCases[n])return n;return-1},getNextCase:function(){var t=this,n=t.getListKey();return bizagi.lstIdCases.length==n+1||bizagi.lstIdCases.length==1?-1:bizagi.lstIdCases[n+1]},getBackCase:function(){var t=this,n=t.getListKey();return n==0?-1:bizagi.lstIdCases[n-1]||-1},showBackNextNavigation:function(){var n=this,t=n.getNextCase(),i=n.getBackCase();t<=0?$(".case-summary-next").hide():$(".case-summary-next").show();i<=0?$(".case-summary-back").hide():$(".case-summary-back").show();t<=0&&i<=0?($(".content-right-sidebar").removeClass("bz-state-number--active-case"),$(".bz-case-navigation").hide()):($(".content-right-sidebar").addClass("bz-state-number--active-case"),$(".bz-case-navigation").show())}});bizagi.injector.register("bizagi.workportal.widgets.project.caseState",["workportalFacade","dataService",bizagi.workportal.widgets.project.caseState]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.activityState",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.contextsSidebarActivity=i.contextsSidebarActivity;r.datePickerRegional=bizagi.localization.getResource("datePickerRegional");r.loadTemplates({"project-activityState-wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.activityState").concat("#project-activityState-wrapper")})},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.contextsSidebarActivity.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))})},updateView:function(n,t){var u=this,e=t.args,o,f,h,s;u.params=e;u.getContent();var r={},c=e.currentState||[],i=c.filter(function(n){return n.idWorkItem===e.idWorkitem})[0];i&&(r.activityName=i.state,r.activityIsEvent=bizagi.util.parseBoolean(i.isEvent),o="MM/dd/yyyy H:mm",f=bizagi.util.dateFormatter.getDateFromFormat(i.entryDateWorkItem,o),f.getTime&&(r.initDateFormat=u.getFormattedDate(f)),h=new Date,s=bizagi.util.dateFormatter.getDateFromFormat(i.estimatedSolutionDate,o),r.estimatedSolutionDateFormat="",f.getTime&&s.getTime&&i?u.calculateDataForTemplate(i,r,f,h,s):u.updateTemplateWidget(r))},calculateDataForTemplate:function(n,t,i,r,u){var f=this,a=new Date(Date.now()-i.getTime()),h=r.getTime()-u.getTime(),c=i.getTime()-u.getTime(),l={idUser:bizagi.currentUser.idUser,fromDate:i.getTime(),toDate:Date.now()},s=!1,o={idUser:bizagi.currentUser.idUser,fromDate:r.getTime(),toDate:u.getTime()},e={};h>0?(o.fromDate=u.getTime(),o.toDate=r.getTime(),s=!0):(e.idUser=bizagi.currentUser.idUser,e.fromDate=i.getTime(),e.toDate=u.getTime());$.when(f.callGetEffectiveDuration(l),f.callGetEffectiveDuration(o),f.callGetEffectiveDuration(e)).done(function(i,r,e){var h=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-i.minutes*6e4),null,!1),o;t.colorState=n.colorState;t.relativeTimeState=bizagi.localization.getResource("workportal-project-activity-state-opened").replace("%s",h);t.percentCompleteBar=100;c===0?t.showEstimatedSolutionDate=!1:(t.showEstimatedSolutionDate=!0,s===!1&&(o=f.getPercentBar(e.minutes,r.minutes),t.percentCompleteBar=o.percent));n&&(t.isEvent=bizagi.util.parseBoolean(n.isEvent));t.estimatedSolutionDateFormat=f.getFormattedDate(u);f.updateTemplateWidget(t)})},getPercentBar:function(n,t){var i={};return i.percent=Math.round((1-t/n)*100),i},updateTemplateWidget:function(n){var t=this,i=t.getContent().empty(),r=t.getTemplate("project-activityState-wrapper");r.render(n).appendTo(i)},getFormattedDate:function(n){var t=this,i=t.datePickerRegional.monthNames,r=n.getMonth();return i[r]+" "+$.datepicker.formatDate("dd",n)},clean:function(){var n=this,t=n.contextsSidebarActivity||[];this.params={};t.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))})},callGetEffectiveDuration:function(n){var i=this,t=$.Deferred();return setTimeout(function(){n.fromDate?$.when(i.dataService.getEffectiveDuration(n)).done(function(n){t.resolve(n)}):t.resolve(null)},200),t.promise()}});bizagi.injector.register("bizagi.workportal.widgets.project.activityState",["workportalFacade","dataService",bizagi.workportal.widgets.project.activityState]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.processState",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.contextsSidebarActivity=i.contextsSidebarActivity;r.loadTemplates({"project-process-state":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.processState").concat("#project-process-state")})},renderContent:function(){var n=this,t=n.getTemplate("project-process-state");return n.content=t.render({}),n.content},postRender:function(){var n=this;n.contextsSidebarActivity.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))})},updateView:function(n,t){var r=this,i=t.args,f=r.getContent().empty(),u,e;r.params=i;u={};u.showParentProcess=i.idParentCase>=1?!0:!1;u.parentProcess={displayName:i.parentDisplayName,idCase:i.idParentCase,idWorkItem:i.idWorkItem,idTask:i.idTask=="0"?"":i.idTask,idWorkflow:i.idWorkflowParentCase};e=r.getTemplate("project-process-state");e.render($.extend(i,u)).appendTo(f);$("#go-to-parent-case",f).on("click",$.proxy(r.onClickGoToParentCase,r))},onClickGoToParentCase:function(n){n.preventDefault();var t=this;t.routingExecute($(n.target).closest("#go-to-parent-case"))},clean:function(){var n=this;n.params={};n.contextsSidebarActivity.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))})}});bizagi.injector.register("bizagi.workportal.widgets.project.processState",["workportalFacade","dataService",bizagi.workportal.widgets.project.processState]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.users",{},{init:function(n,t,i,r){var u=this;u.relatedusers=i;u._super(n,t,r);u.contextsSidebarActivity=r.contextsSidebarActivity;u.plugins={};u.users=[];u.loadTemplates({"project-users":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.users").concat("#project-users-main")})},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.contextsSidebarActivity.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))})},updateView:function(n,t){var i=this,r=t.args,f=i.getContent().empty(),e=i.getTemplate("project-users"),u;e.render().appendTo(f);u=[{id:r.createdBy.userId,typeName:"owner"}];i.relatedusers.render(i.content,".relatedusers-wrapper",r.idCase,u)},clean:function(){var n=this;n.contextsSidebarActivity.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))})}});bizagi.injector.register("bizagi.workportal.widgets.project.users",["workportalFacade","dataService","relatedusers",bizagi.workportal.widgets.project.users]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.events",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.contextsSidebarActivity=i.contextsSidebarActivity;r.loadTemplates({"project-events":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.events").concat("#project-events-wrapper")})},renderContent:function(){var n=this,t=n.getTemplate("project-events");return n.content=t.render({}),n.content},postRender:function(){var n=this;n.contextsSidebarActivity.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))})},updateView:function(n,t){var i=this,r=t.args,u=i.getContent().empty();i.params=r;$.when(i.getArgsTemplate(r)).done(function(n){var t=i.getTemplate("project-events");t.render($.extend(r,n)).appendTo(u);$(".list-events li.event a",u).on("click",$.proxy(i.onClickGoEvent,i))})},getArgsTemplate:function(n){var r=$.Deferred(),t={},u=this,i;if(n.countEvents>=1)for(i=0;i<n.currentState.length;i++)n.currentState[i].isEvent=="true"&&n.currentState[i].idWorkItem==n.idWorkitem&&(n.countEvents=n.countEvents-1);return t.showEvents=n.countEvents>=1?!0:!1,t.showEvents?$.when(u.callSummaryCaseEvents(n.idCase)).done(function(i){n.showEvents=i.events.length>=1?!0:!1;n.showEvents&&(t.events=[],i.events.forEach(function(n){t.events.push($.extend(n[Object.keys(n)[0]],{idWorkFlow:i.idWorkFlow}))}));r.resolve(t)}):r.resolve(t),r.promise()},onClickGoEvent:function(n){n.preventDefault();var t=this;$("[data-bizagi-component='workarea']").empty();t.routingExecute($(n.target).closest("li"))},callSummaryCaseEvents:function(n){var i=this,t=$.Deferred();return $.when(i.dataService.summaryCaseEvents({idCase:n})).done(function(n){t.resolve(n)}),t.promise()},clean:function(){var n=this;this.params={};n.contextsSidebarActivity.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))})}});bizagi.injector.register("bizagi.workportal.widgets.project.events",["workportalFacade","dataService",bizagi.workportal.widgets.project.events],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.subprocesses",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.contextsSidebarActivity=i.contextsSidebarActivity;r.loadTemplates({"project-subprocesses":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.subprocesses").concat("#project-subprocesses-wrapper"),"project-subprocesses-tootip-custom-properties":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.subprocesses").concat("#project-subprocesses-tooltip-custom-properties-wrapper")})},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.contextsSidebarActivity.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))})},updateView:function(n,t){var i=this,u=t.args,r=i.getContent().empty();i.params=u;$.when(i.dataService.summarySubProcess({idCase:i.params.idCase})).done(function(n){var o,e,f,t,s,h;if(n.showSubProcess){for($.each(n.subProcesses,function(t){var i=n.subProcesses[t].custData,r;if(i&&i.length)for(r=0;r<i.length;r+=1)i[r]===null&&(i[r]="")}),o=n.subProcesses||n.subProcPersonalized,e=[],f=0;f<Object.keys(o).length;f+=1)t=o[f],e.push({isOpen:t.isOpen,radNumber:t.radNumber,displayName:t.displayName,idCase:t.idCase,indexSubprocess:f,idCustData:t.idCustData}),t.subProcesses&&Object.keys(t).forEach(function(n){e.push({isOpen:t[n].isOpen,radNumber:t[n].radNumber,displayName:t[n].displayName,idCase:t[n].idCase,indexSubprocess:f,idCustData:t[n].idCustData})});s=i.getTemplate("project-subprocesses");s.render($.extend(u,{auxArrayListSubprocesses:e})).appendTo(r);$(".list-subprocesses a",r).on("click",$.proxy(i.onClickGoSubprocess,i));h=".list-subprocesses li";$(h,r).tooltip({position:{collision:"flipfit",my:"right center",at:"left-10 center"},show:null,content:function(){return i.getContentTooltip($(this),n,i.getTemplate("project-subprocesses-tootip-custom-properties"))},open:function(n,t){if(typeof n.originalEvent=="undefined")return!1;var i=$(t.tooltip).attr("id");$("div.ui-tooltip").not("#"+i).remove()},close:function(n,t){t.tooltip.hover(function(){$(this).stop(!0).fadeTo(400,1)},function(){$(this).fadeOut("400",function(){$(this).remove()})})}})}})},getContentTooltip:function(n,t,i){var y=this,p=$(n).closest("li").find("#indexSubprocess").val(),s=$(n).closest("li").find("#idCustData").val(),u,o,v,l;s=="-1"&&(s="0");var a=function(n,t){return{nameProperty:n,valueProperty:t}},h=[],r="",e=y.getSubprocessData(t,p,s),c=e.custData,f=e.custDataTypes,w=e.custFields,b=e.displayName;if(h.push(new a("subproceso",b)),c.length)for(u=0;u<c.length;u+=1)r=c[u],f&&(f[u]=="Money"?r=bizagi.util.formatMonetaryCell(r):f[u]=="Boolean"?r=bizagi.util.formatBoolean(r):f[u]=="Float"||f[u]=="Real"?r=bizagi.util.formatDecimalCell(r):typeof r=="function"&&(r="")),h.push(new a(w[u],r));return o={},o.arrayCustomsProperties=h,o.nameSubprocess=$(n).text(),v=i,l=$('<div class="bizagi-custom-tooltip-subprocesses"><\/div>'),v.render(o).appendTo(l),l.html()},getSubprocessData:function(n,t,i){var r={},f=n.subProcesses,u=n.subProcPersonalized,e;return f&&f.length>0?(r.custData=f[t].custData,r.custDataTypes=f[t].custDataTypes,e=n.CustFields[i],r.custFields=e[Object.keys(e)[0]],r.displayName=f[t].displayName):u&&Object.keys(u).length>0&&(r.custData=u[0].subProcesses[t].custData,r.custDataTypes=u[0].subProcesses[t].custDataTypes,r.custFields=u[0].CustFields[0],r.displayName=u[0].subProcesses[t].displayName),r},onClickGoSubprocess:function(n){n.preventDefault();var t=this;t.routingExecute($(n.target).closest("li"))},clean:function(){var n=this;n.params={};n.pluginTooltip=null;n.contextsSidebarActivity.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))})}});bizagi.injector.register("bizagi.workportal.widgets.project.subprocesses",["workportalFacade","dataService",bizagi.workportal.widgets.project.subprocesses]);
