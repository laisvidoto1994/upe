bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.newCase",{},{getWidgetName:function(){return bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_NEWCASE},renderContent:function(){var n=this,t=n.getTemplate("newCase");return n.content=$.tmpl(t)},createNewCase:function(n,t){var i=this,r=new $.Deferred;return bizagi.loader.start("rendering").then(function(){bizagi.loader.start("plans-view").then(function(){$.when(i.dataService.startProcess({idProcess:n,isAdhocProcess:t})).then(function(n){i.onStartProcessDone(n);r.resolve(n)})})}),r.promise()},onStartProcessDone:function(n){var t=this;t.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:n.caseInfo.idCase,radNumber:n.radNumber,formsRenderVersion:typeof n.caseInfo.isOfflineForm!="undefined"?n.caseInfo.formsRenderVersion:0,isOfflineForm:typeof n.caseInfo.isOfflineForm!="undefined"?n.caseInfo.isOfflineForm:!1,data:n})}});
bizagi.workportal.widgets.newCase.extend("bizagi.workportal.widgets.newCase",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.loadTemplates({"error-message":bizagi.getTemplate("common.bizagi.desktop.error-message"),newCase:bizagi.getTemplate("bizagi.workportal.desktop.widget.newCase").concat("#ui-bizagi-workportal-widget-newcase"),"newCase-categories":bizagi.getTemplate("bizagi.workportal.desktop.widget.newCase").concat("#ui-bizagi-workportal-widget-newcase-categories"),"newCase-categories-tree":bizagi.getTemplate("bizagi.workportal.desktop.widget.newCase").concat("#ui-bizagi-workportal-widget-newcase-categories-tree"),"newCase-categories-recent-process":bizagi.getTemplate("bizagi.workportal.desktop.widget.newCase").concat("#ui-bizagi-workportal-widget-recent-process"),"newCase-categories-organization-list":bizagi.getTemplate("bizagi.workportal.desktop.widget.newCase").concat("#ui-bizagi-workportal-widget-newcase-organization-list"),useNewEngine:!1})},postRender:function(){var t=this,n=t.getContent();t.configureBackButton();bizagi.idCategory=undefined;t.scrollVertical({autohide:!1});t.configureTreeNavigation();$("#frecuentCases",n).click(function(){(t.removeOrganizationList(),$(this).hasClass("frecuentCasesOn"))||($(".searchNewCase",n).hide(),$("#modalTitle",n).html(t.getResource("workportal-widget-newcase-recent")),t.renderRecentProcess(),$(this).addClass("frecuentCasesOn"),$("#casesList",n).removeClass("casesListOn"))}).tooltip();$("#casesList",n).click(function(){(t.removeOrganizationList(),$(this).hasClass("casesListOn"))||($(".searchNewCase",n).show(),$("#searchNewCase",n).focus(),$("#searchNewCase",n).val(""),$("#modalTitle",n).html(t.getResource("workportal-widget-newcase-create")),t.renderCategories(),$(this).addClass("casesListOn"),$("#frecuentCases",n).removeClass("frecuentCasesOn"))}).tooltip();$("#search",n).click(function(){$(this).hasClass("searchOn")?$(this).removeClass("searchOn"):$(this).addClass("searchOn")});$("#frecuentCases",n).click()},renderCategories:function(n,t){var i=this,f=i.getContent(),o=i.getTemplate("newCase-categories"),e=$("#categories",f),c=$("#categoryTree",f),s=!1,r,u={},h=100;bizagi.criticSection=bizagi.criticSection==1?1:0;$.when(i.dataService.getCategories({idCategory:n,idApp:t||""})).done(function(n){var a,l,t;if(e.empty(),c.show(),n.totalApps>1&&(a={category:[]},$.each(n.category,function(n,t){a.category.push({appId:t.appId,idCategory:"",categoryName:t.appName,isProcess:"false",isAdhocProcess:"false",description:" "})}),n=a),n.category.length>h){for(u.category={},t=0;t<=h;t++)u.category[t]=n.category[t];u.truncate=!0;r=$.tmpl(o,u);r.appendTo(e);i.loadAllElementEvent(n)}else u=n,r=$.tmpl(o,u),r.appendTo(e);i.scrollVertical({autohide:!1});l={};l.category=[];t=0;$.each(n.category,function(t,i){n.category[t].label=i.categoryName;n.category[t].value=i.idCategory});$("#searchNewCase",f).focus();$(f).delegate("#searchNewCase","keyup",function(t){t.stopPropagation();$("#searchNewCase",f).val().length===0&&s&&(r=$.tmpl(o,u),r.appendTo(e),i.assignEvent(),i.loadAllElementEvent(n),s=!1)});$("#searchNewCase",f).autocomplete({messages:{noResults:null,results:function(){}},minLength:3,source:n.category,autoFocus:!0,position:{my:"left top",at:"left top",of:"body",offset:"-10 -10",collision:"none",delay:800},open:function(){t=0;l.category=[]},select:function(){return $("#categories ul").length==1&&$("#categories ul").trigger("click"),!1}}).data("ui-autocomplete")._renderItem=function(u,f){return t>=15?!0:(l.category[t++]=f,r=$.tmpl(o,l),r.appendTo(e),s=!0,i.assignEvent(r),i.loadAllElementEvent(n),r)};i.assignEvent()})},loadAllElementEvent:function(n){var t=this,r=t.getContent(),u=t.getTemplate("newCase-categories"),i=$("#categories",r);$(".loadMoreElements",i).click(function(r){r.stopPropagation();$(this).find("#loadMoreElementsIcon").removeClass("plus_load_icon").addClass("loading_icon");i.empty();var f=$.tmpl(u,n);f.appendTo(i);t.assignEvent()})},assignEvent:function(n){var i=this,t=i.getContent(),r=$("#categories",t),u=$("#categoryTree",t),f=n||$("ul",r);$(f).click(function(n){var h,c;n.stopPropagation();var f=$(this).children("#idCategory").val(),l=f,e=$(this).children("#isProcess").val(),o=$(this).children("#categoryName").val(),a=$(this).children("#isAdhocProcess").val(),s=$(this).data("appid");if((bizagi.criticSection==1||f==bizagi.idCategory)&&!bizagi.util.parseBoolean(e))return!0;bizagi.idCategory=f;$("#searchNewCase",t).val("");bizagi.criticSection=1;bizagi.util.parseBoolean(e)===!0?(h=$(this).find(".processIco"),$(h).addClass("wait"),$(this).prevAll("ul").fadeTo(650,0,"easeInOutCirc").slideUp({duration:300,easing:"easeInOutCirc"}),$(this).nextAll("ul").fadeTo(650,0,"easeInOutCirc").slideUp({duration:300,easing:"easeInOutCirc"}),bizagi.currentUser.isMultiOrganization&&bizagi.currentUser.isMultiOrganization=="true"?$.when(i.dataService.getOrganizationsList()).done(function(n){i.createOrganizationList(l,n.response,$(r).parent().outerWidth(),$("#modalMenuBtList",i.getContent()).position().top)}):($("#modalNewCaseOverlay",t).removeClass("modalNewCaseOverlay").addClass("modalNewCaseOverlayShow"),$("#modalNewCaseMessage",t).addClass("show"),$("#modalNewCaseMessage",t).css("left",$(document).width()/2-$("#modalNewCaseMessage",t).width()/2),$("#modalNewCaseMessage",t).css("top",$(document).height()/2-$("#modalNewCaseMessage",t).height()/2),$("#case",t).html(o),$.when(i.createNewCase(f,a)).done(function(n){bizagi.referrerParams&&(bizagi.referrerParams.idWorkItem="");n.caseInfo.workItems&&n.caseInfo.workItems.length>=1&&(bizagi.referrerParams.idWorkItem=n.caseInfo.workItems.length>=1?n.caseInfo.workItems[0].idWorkItem:"");bizagi.workportal.desktop.popup.closePopupInstance();$("#modalNewCaseOverlay",t).addClass("modalNewCaseOverlay").removeClass("modalNewCaseOverlayShow");$("#modalNewCaseMessage",t).removeClass("show")}))):(c=i.getTemplate("newCase-categories-tree"),$.tmpl(c,{idParentCategory:f,categoryName:o,appId:s}).appendTo(u),i.configureTreeNavigation(),i.renderCategories(f,s));bizagi.criticSection=0;bizagi.idCategory=undefined})},renderRecentProcess:function(){var t=this,i=t.getContent(),n=$("#categories",i),r=$("#categoryTree",i),u=$("#bt-back",i),f=t.getTemplate("newCase-categories-recent-process");n.empty();$("li:first",r).nextAll().remove();r.hide();u.hide();$.when(t.dataService.getRecentProcesses({numberOfProcesses:7})).done(function(i){$.tmpl(f,i).appendTo(n);i.processes.length===0&&$.browser.msie&&(n.blur(),t.busyLoop(),n.hide(),n.remove());$("ul",n).click(function(){$("ul",n).unbind("click");var i=$(this).children("#idWFClass").val(),r=$(this).find(".processIco");$(r).addClass("wait");$(this).prevAll("ul").fadeTo(650,0,"easeInOutCirc").slideUp({duration:300,easing:"easeInOutCirc"});$(this).nextAll("ul").fadeTo(650,0,"easeInOutCirc").slideUp({duration:300,easing:"easeInOutCirc"});bizagi.currentUser.isMultiOrganization&&bizagi.currentUser.isMultiOrganization=="true"?$.when(t.dataService.getOrganizationsList()).done(function(r){t.createOrganizationList(i,r.response,$(n).parent().outerWidth(),$("#modalMenuBtList",t.getContent()).position().top)}):($.when(bizagi.util.autoSave()).done(function(){$(document).data("auto-save","");$.when(t.createNewCase(i)).done(function(n){n&&!n.hasStartForm&&bizagi.referrerParams&&(bizagi.referrerParams.idWorkItem=n.caseInfo.workItems.length>=1?n.caseInfo.workItems[0].idWorkItem:"")})}),bizagi.workportal.desktop.popup.closePopupInstance());setTimeout(function(){$("ul",n).bind("click")},1e3)})})},createOrganizationList:function(n,t){var i=this,f=i.getContent(),u=$("#modalMenuBtList",f),e=i.getTemplate("newCase-categories-organization-list"),r;$("#organization-list",u).length===0&&(r=$.tmpl(e,{organizationList:t}).appendTo(u),$("#new-case",r).click(function(t){t.preventDefault();$.when(i.createNewCase(n,$("#organization-list",r).val())).done(function(n){n&&bizagi.referrerParams&&(bizagi.referrerParams.idWorkItem=n.caseInfo.workItems.length>=1?n.caseInfo.workItems[0].idWorkItem:"");bizagi.workportal.desktop.popup.closePopupInstance()})}))},removeOrganizationList:function(){var n=this,t=n.getContent();$(".new-case-organization-list-content",t).remove()},configureBackButton:function(){var t=this,i=t.getContent(),r=$("#bt-back",i),n=$("#categoryTree",i);r.click(function(){if(bizagi.idCategory=undefined,$("li",n).length==2&&r.hide(),$("li",n).length>1){$("li:last-child",n).remove();var i=$("li:last-child",n).children("#idParentCategory").val(),u=$("li:last-child",n).data("appid");t.renderCategories(i,u)}})},configureTreeNavigation:function(){var i=this,r=i.getContent(),n=$("#bt-back",r),t=$("#categoryTree",r);$("li",t).length<=1?n.hide():n.show();$("li:last-child",t).click(function(){$(this).nextAll().remove();var u=$(this).children("#idParentCategory").val(),r=$(this).data("appid");$("li",t).length==1&&(bizagi.idCategory=undefined,n.hide());r&&(bizagi.idCategory=undefined);i.renderCategories(u,r)})},scrollVertical:function(n){var t=this,i=t.getContent();n=n||{};$("#categories",i).bizagiScrollbar(n)},busyLoop:function(){var n=1,t=null;setTimeout(function(){n=n*3+2;t=n/2},100)}});
