bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu.plan",{},{init:function(n,t,i,r){var u=this;u.params=r||{};u.projectDashboard=i;u._super(n,t,r);u.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.plan").concat("#project-dashboard-menu")})},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.params&&n.params.contextsLeftSidebarCaseDashboard&&n.params.contextsLeftSidebarCaseDashboard.forEach(function(t){n.sub(t,$.proxy(n.updateView,n))})},updateView:function(n,t){var i=this,r,u,f;i.params=$.extend(i.params,t.args);i.clean();r=i.getContent().empty();u=i.getTemplate("project-dashboard-menu");i.params.menuPlanDashboard=i.params.menuPlanDashboard||{};$.extend(i.params.menuPlanDashboard,i.params.menuDashboard);i.planState=i.getPlanState(i.params.plan,i.params.planChild);f={planState:i.planState,showCommentsOptionMenu:i.params.menuPlanDashboard.showCommentsOptionMenu,showFilesOptionMenu:i.params.menuPlanDashboard.showFilesOptionMenu,showTimeLineOptionMenu:i.params.menuPlanDashboard.showTimeLineOptionMenu&&i.isVisibleShowTimeLine(i.planState)};u.render(f).appendTo(r);$("li[data-context='"+i.params.showContextByMenuDashboard.toUpperCase()+"']",i.content).addClass("active").siblings().removeClass("active");i.handlerEvents()},getPlanState:function(n,t){var i;return t&&t.currentState?i=t.currentState:n&&n.currentState&&(i=n.currentState),i},isVisibleShowTimeLine:function(n){var i=this,t=!0;return n==="PENDING"&&(t=!1),t},loadContentById:function(n){var t=this,i,r;n.preventDefault();i=$(n.target).closest("li");i.data("context")==="PLANBACK"?t.backParentPlan():i.hasClass("active")||(r=i.data("context"),r&&(t.pub("notify",{type:r.toUpperCase(),args:$.extend(t.params,{showContextByMenuDashboard:r})}),$("li[data-context='"+t.params.showContextByMenuDashboard.toUpperCase()+"']",t.content).addClass("active").siblings().removeClass("active")))},subMenuHandler:function(){var t=this,n=t.getContent(),i=$("[data-context='PLANCOMMENTS']",n),r=$("[data-context='PLANFILES']",n),u=$("[data-context='PLANTIMELINE']",n);$(".ui-bizagi-wp-project-tab-submenu a",n).on("click",function(){i.toggle();r.toggle();t.isVisibleShowTimeLine(t.planState)&&u.toggle()})},backParentPlan:function(){var n=this,i=n.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),r=parseInt(i[0]),t=n.projectDashboard.getParamsByBackFromPlan(n.params,r);n.pub("notify",{type:t.typeContext,args:$.extend(n.params,t.paramsNotify)})},handlerEvents:function(){var n=this,t=n.getContent();n.subMenuHandler();$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(n.loadContentById,n))},clean:function(){var n=this,t=n.getContent();$(".ui-bizagi-wp-project-tab-links a",t).off();n.params&&n.params.contextsLeftSidebarCaseDashboard&&n.params.contextsLeftSidebarCaseDashboard.forEach(function(t){n.unsub(t,$.proxy(n.updateView,n))})}});bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.plan",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard",bizagi.workportal.widgets.project.dashboard.menu.plan],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var n=this,t=n.getTemplate("project-content-dashboard");return n.content=t.render({}),n.content},postRender:function(){var n=this;setTimeout(function(){$(window).trigger("resize")},1e3)}});bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0);
(function(n){var r=window.kendo,t=r.ui,i=t.Widget,u=i.extend({init:function(n,t){var r=this;i.fn.init.call(r,n,t);r._maxFilesSize=bizagi.currentUser.uploadMaxFileSize>r.options.maxFilesSize?bizagi.currentUser.uploadMaxFileSize:r.options.maxFilesSize;r._fileList=[];r._onlyValidateServerFileExtension=t.onlyValidateServerFileExtension||!0;r._supportFileExt=t.extensions;r._uploadMaxFilesSize=t.maxSize;r.upload=r._initUpload();r.loadNotifier=r._initLoadNotifier();r.notification=r._initNotification();r._eventsHandler();r._initLocalization(r.options.localization)},options:{name:"ProjectAttachments",wrapper:n('<div class="project-attachments"><\/div>'),multiple:!0,dropZone:!0,maxFilesSize:25e6,enabled:!0,localization:{}},_initUpload:function(){var n=this,t=n.options,i=t.localization||{},r=0;return n._initLocalization(i),this.element.kendoUpload({async:{saveUrl:t.saveUrl,autoUpload:!0},select:function(t){n._filterMaxFilesSize(t);r=0},complete:function(){var t=setInterval(function(){n.loadNotifier.wrapper.find("li.k-file-progress").length===0&&(n._showNotificationCompleteUpload(n.loadNotifier.wrapper,r),clearInterval(t))},300)},upload:t.upload,progress:function(t){n._onProgressFile(t)},success:function(i){n._fileList.push(i.files[0]);r+=1;t.success(i)},error:function(t){n.onErrorFile(t)},localization:{select:i.selectFiles,dropFilesHere:i.dropFilesHere},multiple:t.multiple,enabled:t.enabled,dropZone:t.dropZone,showFileList:!1}).data("kendoUpload")},_initNotification:function(){return n("<div><\/div>").kendoNotification({position:{pinned:!0}}).data("kendoNotification")},_initLoadNotifier:function(){var n=this,t=n.options.localization,i=n.options.wrapper;return i.kendoWindow({title:t.notifierTitle,actions:["Close"],animation:{open:{duration:100},close:{duration:100}},open:function(){this.wrapper.addClass("project-attachments-wrapper-window")},visible:!1,resizable:!1,draggable:!1,maxHeight:"300px",minWidth:"430px"}).data("kendoWindow")},_initLocalization:function(t){var i=this,r={selectFiles:bizagi.localization.getResource("workportal-project-attachments-addfiles"),notifierTitle:bizagi.localization.getResource("workportal-project-attachments-notifiertitle"),errorUpload:bizagi.localization.getResource("workportal-project-attachments-file-error-type"),errorSecurity:bizagi.localization.getResource("workportal-project-attachments-blockedext"),errorSize:bizagi.localization.getResource("workportal-project-attachments-blockedsize"),errorMaxFilesSize:bizagi.localization.getResource("workportal-project-discussion-maxfilessize").replace("%s",i._maxSize/1e6),dropFilesHere:bizagi.localization.getResource("workportal-project-attachments-drophere"),cancel:bizagi.localization.getResource("workportal-widget-reports-confirm-cancel"),retry:bizagi.localization.getResource("workportal-project-attachments-retry"),close:bizagi.localization.getResource("workportal-widget-dialog-box-close")};n.extend(t,r)},_onProgressFile:function(t){var u=this,i=u._getFileItemByUID(t.files[0].uid),r=t.percentComplete;n(".k-progress",i).css({width:r+"%"});n(".k-upload-pct",i).removeClass("k-icon k-loading").text(r+"%");r===100&&n(".k-upload-action .k-icon",i).hide()},_onShowUploadNotifier:function(n){var t=this,i=n.files,r=t.options.template;t.loadNotifier.content(r.render({files:i}));t.loadNotifier.wrapper.css({top:"auto",left:"auto",bottom:"1em",right:"1em"});t.loadNotifier.open()},_showNotificationCompleteUpload:function(n,t){var i=this;n.find("li.k-file-success").length===t&&n.find("li.k-file-error").length===0&&i._autoHideMessage(n)},_autoHideMessage:function(n){var t=this;setTimeout(function(){n.fadeOut(function(){t.loadNotifier.close()})},2e3)},_onCancelFile:function(n){var i=this,t=n.closest("li"),r=i.upload.wrapper,u=t.data("guid");r.find("li[data-uid="+u+"] .k-upload-action").trigger("click");t.remove()},_onRemoveFile:function(n){var t=n.closest("li");t.remove()},_onRetryFile:function(t){var i=this,r=t.closest("li"),u=r.data("guid"),f=n.grep(i._fileList,function(n){return n.uid===u});i.options.retry(f[0])},onErrorFile:function(n){var t=this,u=t.options.localization,i=n.files[0],r=t._isValidFile(i),f=r.message!==""?r.message:u.errorUpload;t.setStatus("ERROR",i.uid,f)},_isValidFile:function(t){var i=this,f=i.options.localization,r=!0,u="";return t.size>i._uploadMaxFilesSize&&(u=f.errorSize,r=!1),i._onlyValidateServerFileExtension||n.inArray(t.extension,i._supportFileExt)===-1&&(u=f.errorSecurity,r=!1),{valid:r,message:u}},_filterMaxFilesSize:function(n){for(var t=this,r=0,i=0,u=n.files.length;i<u;i++)r+=n.files[i].size;r>t._maxFilesSize?(t._notifySizeExceeded(),n.preventDefault()):t._onShowUploadNotifier(n)},_notifySizeExceeded:function(){var n=this;n.notification.show(n.options.localization.errorMaxFilesSize,"error")},_getFileItemByUID:function(t){var i=this;return n("li[data-guid="+t+"]",i.loadNotifier.element)},_switchEvents:function(t){var r=this,i=n(".k-icon",t.currentTarget);i.hasClass("k-update")||i.hasClass("k-remove")?r._onRemoveFile(i):i.hasClass("k-retry")?r._onRetryFile(i):i.hasClass("k-cancel")&&r._onCancelFile(i)},_eventsHandler:function(){var n=this;n.loadNotifier.element.on("click","button.k-upload-action",function(t){n._switchEvents(t)})},cancelFilesUpload:function(){var n=this,t=n.upload.wrapper;t.find("li .k-upload-action").trigger("click");n.close()},close:function(){this.loadNotifier.close()},destroy:function(){this.loadNotifier.destroy();this.upload.destroy()},setStatus:function(t,i,r){var u=this._getFileItemByUID(i),f=this.options.localization;switch(t){case"SUCCESS":u.removeClass("k-file-progress k-file-error").addClass("k-file-success");n(".k-upload-action .k-icon",u).removeClass("k-cancel k-i-refresh k-retry").addClass("k-update").prop("title",f.close).show();n(".k-errormsg",u).text("");break;case"ERROR":u.removeClass("k-file-progress").addClass("k-file-error");n(".k-upload-action .k-icon",u).removeClass("k-i-refresh k-retry").addClass("k-remove").show();n(".k-upload-status .k-upload-pct",u).removeClass("k-upload-pct k-loading").addClass("k-icon k-warning");n(".k-errormsg",u).text(r).prop("title",r);break;case"RETRY":u.removeClass("k-file-progress").addClass("k-file-error");n(".k-upload-status .k-upload-pct",u).removeClass("k-upload-pct k-loading").addClass("k-warning").text("");n(".k-upload-action .k-icon",u).removeClass("k-cancel k-remove").addClass("k-i-refresh k-retry").prop("title",f.retry).show();n(".k-errormsg",u).text(f.errorUpload).prop("title",f.errorUploadiis)}}});t.plugin(u)})(jQuery);
bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.files",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.plugins={};r.prefixBase64="data:image/png;base64,";r.usersData={};r.currentFilesList=[];r.fileDateInterval;r.loadTemplates({"project-files":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.files").concat("#project-files-wrapper"),"project-files-uploaditem":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.files").concat("#project-files-uploaditem"),"project-files-list":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.files").concat("#project-files-list"),"project-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.attachments").concat("#project-attachments")})},renderContent:function(){var n=this,t=n.getTemplate("project-files");return n.content=t.render({isOpen:!bizagi.util.parseBoolean(n.params.isClosedForAllUsers)}),n.content},postRender:function(){var n=this;$.when(n.renderFilesList()).done(function(){n.plugins.uploadFiles=n.initializeUploadFiles();n.eventsHandler();n.restrictedEventsHandler()})},renderFilesList:function(){var n=this,t=$.Deferred(),i=n.currentFilesList.length,r={globalParent:n.radNumber,dateTime:i?n.currentFilesList[i-1].date:n.getDateServer(),count:12};return n.params.flowContext==="FLOW-DECONTEXTUALIZED-PLANS"&&(r.globalParent=n.params.plan.id),$.when(n.dataService.getFilesListByRadNumber(r)).done(function(i){n.currentFilesList=n.currentFilesList.concat(i);n.renderFiles(i);t.resolve()}),t.promise()},renderFiles:function(n){var t=this,r=t.getContent(),i=$("#project-files-showmore",r);t.displayFileList(n,"append");t.updateRelativeTime();n.length&&t.setAdditionalData(n);t.currentFilesList.length>=12&&(i.show(),n.length<12&&($("button",i).remove(),$("#project-files-nomore",i).show()));t.notifyFilesNumber(!1)},renderNoFiles:function(){var n=this,t=n.workportalFacade.getTemplate("info-message"),i=n.resources.getResource("workportal-project-files-noavailable"),r=$.tmpl(t,{message:i});n.content.html(r)},initializeUploadFiles:function(){var n=this,t=n.getContent();return $("#project-files-upload",t).kendoProjectAttachments({saveUrl:n.dataService.serviceLocator.getUrl("project-comments-uploadfiles"),template:n.getTemplate("project-attachments"),success:$.proxy(n.onSuccessFile,n),upload:$.proxy(n.addFileData,n),retry:$.proxy(n.onSaveFileData,n),enabled:!0,extensions:n.supportFileExt,maxSize:n.uploadMaxFilesSize}).data("kendoProjectAttachments")},setAdditionalData:function(n){for(var i=this,r=[],u=[],t=0,f=n.length-1;t<=f;t++)u.push(n[t].user),r.push(n[t].attachment.guid);i.setUserData(u.join());i.setThumbnails(r.join())},setUserData:function(n){var t=this,i=t.getContent(),r={userIds:n,width:50,height:50};$.when(t.dataService.getUsersData(r)).done(function(n){for(var r=0,u=n.length-1;r<=u;r++)n[r].picture&&(n[r].picture=t.prefixBase64+n[r].picture),t.usersData["id"+n[r].id]=n[r],$("#project-files-list .ui-bizagi-wp-project-files-user[data-userId="+n[r].id+"]",i).text(n[r].name)})},getFileInfoByGuid:function(n){for(var i=this,r,t=0,u=i.currentFilesList.length;t<u;t++)n===i.currentFilesList[t].guid&&(r=i.currentFilesList[t],t=u);return r},setThumbnails:function(n){var t=this,i=t.getContent(),r={guids:n,width:480,height:150};$.when(t.dataService.getFilesThumbnails(r)).done(function(n){var f,r,u;$.each(n,function(n,e){n=n.toLowerCase();f=t.prefixBase64+e;r=$("#project-files-list .ui-bizagi-wp-project-files-wrapitem[data-attchGuid="+n+"]",i);u=$(".ui-bizagi-wp-project-files-thumbnail",r);u.prop("src",f);$(".ui-bizagi-wp-project-files-icon",r).remove();u.css("display","block")})})},setFilePreview:function(n,t,i){var r=this,u="",f={guids:[t].join(),width:500,height:500};$.when(r.dataService.getFilesThumbnails(f)).done(function(t){var f=n.find(".ui-bizagi-wp-project-files-user"),e=f.data("userid");$.each(t,function(n,t){u=r.prefixBase64+t});r.pub("notify",{type:"FILEPREVIEW",args:{radNumber:r.radNumber,fileData:r.getFileInfoByGuid(i),userData:r.usersData["id"+e],isOpen:!bizagi.util.parseBoolean(r.params.isClosedForAllUsers),img:u}});r.pub("notify",{type:"OPEN_RIGHT_SIDEBAR"})})},onSuccessFile:function(n){var t=this,i=n.XMLHttpRequest.response?JSON.parse(n.XMLHttpRequest.response):{};if(i.error)t.plugins.uploadFiles.onErrorFile(n);else t.onSaveFileData(n.files[0])},onSaveFileData:function(n){var t=this;$.when(t.saveFileData(n)).done(function(){t.notifyFilesNumber();t.plugins.uploadFiles.setStatus("SUCCESS",n.uid)}).fail(function(){t.plugins.uploadFiles.setStatus("RETRY",n.uid)})},onRetryFile:function(n){var t=this,i=n.closest("li"),r=i.data("guid"),u=$.grep(t.currentFilesList,function(n){return n.uid===r});t.onSaveFileData(i,u[0])},addFileData:function(n){var t=this;n.data={guid:n.files[0].uid}},saveFileData:function(n){var t=this,r=$.Deferred(),f=Math.guid(),u=t.radNumber?t.radNumber.toString():"",i;return t.params.flowContext==="FLOW-DECONTEXTUALIZED-PLANS"&&(u=t.params.plan.id),i={content:{guid:f,description:"",name:n.name,attachment:{guid:n.uid,name:n.name},date:t.getDateServer(),user:bizagi.currentUser.idUser,globalParent:u},attachmentsToCreate:[n.uid]},t.currentFilesList.unshift(n),$.when(t.dataService.createProjectFile(i)).always(function(u){u.status===200||u.status===201||u.status===undefined?($.extend(n,{user:bizagi.currentUser.idUser,userName:bizagi.currentUser.userName,date:(new Date).getTime(),attachment:i.content.attachment,guid:i.content.guid,description:i.content.description}),t.usersData["id"+bizagi.currentUser.idUser]={picture:bizagi.currentUser.photo,name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser},t.displayFileList(n,"prepend"),t.updateRelativeTime(),t.setThumbnails(n.uid),r.resolve()):r.reject()}),r},displayFileList:function(n,t){var i=this,r=i.getTemplate("project-files-list"),n=n||i.currentFilesList,u=i.getContent(),f=r.render({files:n});$("#project-files-list",u)[t](f);$.equalizeHeights(".bz-card")},deleteFile:function(n,t){var i=this,r=i.getContent();$("div[data-fileguid='"+t.args.guid+"']",r).remove();i.currentFilesList=i.currentFilesList.filter(function(n){return n.guid!==t.args.guid});i.notifyFilesNumber(!0)},updateFileData:function(n,t){var i=this,r=i.getFileInfoByGuid(t.args.guid);r.description=t.args.description},updateRelativeTime:function(){var n=this;n.fileDateInterval&&clearInterval(n.fileDateInterval);n.fileDateInterval=setInterval($.proxy(n.changeRelativeTime,n),"7000")},changeRelativeTime:function(){var n=this,t=n.getContent();$("#project-files-list .ui-bizagi-wp-project-files-date",t).each(function(n,t){var i=$(t).data("date"),r=bizagi.util.dateFormatter.getRelativeTime(new Date(i),null,!1);$(t).text(r)})},onSelectFiles:function(n){for(var f,u=this,i=[],r=n.files,t=r.length-1;t>=0;t--)u.isValidFile(r[t]).valid||(f=r.splice(t,t+1),i.unshift(f[0]));i.length>0&&u.showFilesError(i)},resetWidget:function(){var n=this;n.plugins.uploadFiles&&n.plugins.uploadFiles.close();n.currentFilesList=[];clearInterval(n.fileDateInterval)},switchFilesEvents:function(n){var u,f,e;n.stopPropagation();var i=this,t=$(n.target),r=t.closest(".ui-bizagi-wp-project-files-wrapitem");r.length?(u=r.data("attchguid"),f=r.data("fileguid"),t.hasClass("ui-bizagi-wp-project-files-file")?(e=t.text(),i.dataService.getDownloadAttachment(u,e)):i.setFilePreview(r,u,f)):t.parent().prop("id")==="project-files-showmore"?i.renderFilesList():t.prop("id")!=="project-files-upload"&&i.notifyFilesNumber(!0)},notifyFilesNumber:function(n){var t=this;t.pub("notify",{type:"SETFILESNUMBER",args:{filesNumber:t.currentFilesList.length,mandatory:n}})},restrictedEventsHandler:function(){var n=this;n.content.on("click",$.proxy(n.switchFilesEvents,n))},eventsHandler:function(){var n=this,t=n.getContent();n.sub("changeProjectWidget",$.proxy(n.resetWidget,n));n.sub("UPDATEFILE",$.proxy(n.updateFileData,n));n.sub("DELETEFILE",$.proxy(n.deleteFile,n));t.on("click",$.proxy(n.switchFilesEvents,n))},clean:function(){var n=this,t;n.resetWidget();n.unsub("changeProjectWidget",$.proxy(n.resetWidget,n));n.unsub("UPDATEFILE",$.proxy(n.updateFileData,n));n.unsub("DELETEFILE",$.proxy(n.deleteFile,n));for(t in n.plugins)n.plugins[t]&&n.plugins[t].destroy();clearInterval(n.fileDateInterval);n._super()}});bizagi.injector.register("bizagi.workportal.widgets.project.files",["workportalFacade","dataService",bizagi.workportal.widgets.project.files],!0);
bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.filesPreview",{},{init:function(n,t,i,r){var u=this;u.datePickerRegional=bizagi.localization.getResource("datePickerRegional");u.dialogBox={};u._super(n,t,r);u.notifier=i;u.loadTemplates({"project-filespreview-wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.filesPreview").concat("#project-filespreview-wrapper"),"project-filespreview-preview":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.filesPreview").concat("#project-filespreview-preview"),"project-filespreview-popup":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.filesPreview").concat("#project-filespreview-popup"),"project-filespreview-thenumber":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.filesPreview").concat("#project-filespreview-thenumber")})},renderContent:function(){var n=this,t=n.getTemplate("project-filespreview-wrapper");return n.content=t.render(),n.sub("SETFILESNUMBER",$.proxy(n.setFilesNumber,n)),n.content},postRender:function(){var n=this;n.plugins.fileEdition=n.initPluginPopupEdition();n.form={description:$("#ui-bizagi-wp-project-filespreview-popup-description",n.plugins.fileEdition),image:$(".ui-bizagi-wp-project-popupform-user-image",n.plugins.fileEdition),cancel:$("#ui-bizagi-wp-project-popupform-action-cancel",n.plugins.fileEdition),edit:$("#ui-bizagi-wp-project-popupform-action-editfile",n.plugins.fileEdition)};n.eventsHandler()},setFilesNumber:function(n,t){var i=this,r=t.args,u,f;($.isEmptyObject(i.currentFile)||r.mandatory)&&(u=i.getTemplate("project-filespreview-thenumber"),f=u.render({filesNumber:r.filesNumber}),i.currentFile={},$("#ui-bizagi-wp-project-filespreview-wrapper",i.content).html(f))},initPluginPopupEdition:function(){var n=this,t=n.getTemplate("project-filespreview-popup");return n.dialogBox.formContent=t.render(),n.dialogBox.formContent},showPreview:function(n,t){var i=this,u=i.getTemplate("project-filespreview-preview"),r;i.currentFile=t.args;r=u.render($.extend(t.args,{idCurrentUser:bizagi.currentUser.idUser}));$("#ui-bizagi-wp-project-filespreview-wrapper",i.content).html(r);i.applyMenu()},setEditionData:function(){var n=this;n.form.description.val(n.currentFile.fileData.description);n.currentFile.userData.picture&&n.form.image.prop("src",n.currentFile.userData.picture)},eventsHandler:function(){var n=this;n.form.cancel.on("click",$.proxy(n.onResetFileForm,n));n.form.edit.on("click",$.proxy(n.onSaveEdition,n));n.sub("FILEPREVIEW",$.proxy(n.showPreview,n))},onSelectMenu:function(n,t){var i=this,r;if($(n.currentTarget).find("i").length===0){r=$(t.item).data("item");switch(r){case"edit":i.onOpenEdition();break;case"delete":i.onDeleteFile();break;case"download":i.onDownloadFile()}}},onDownloadFile:function(){var n=this;n.dataService.getDownloadAttachment(n.currentFile.fileData.attachment.guid,n.currentFile.fileData.name)},onOpenEdition:function(){var n=this;n.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"650px",modal:!0,title:bizagi.localization.getResource("workportal-project-files-editfile"),maximize:!0,close:function(){n.onResetFileForm()}});n.setEditionData();n.form.description.focus()},onDeleteFile:function(){var n=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-file-querydelete"),"","info")).done(function(){var t={content:{guid:n.currentFile.fileData.guid},attachmentsToDelete:[n.currentFile.fileData.attachment.guid]};$.when(n.dataService.deleteFile(t)).always(function(i){(i.status===200||i.status===201||i.status===undefined)&&n.pub("notify",{type:"DELETEFILE",args:{guid:t.content.guid}})})})},onSaveEdition:function(){var n=this,t;n.validateAddFileDescriptionForm(n.form.description)&&(n.currentFile.fileData.description=n.form.description.val(),t={content:{guid:n.currentFile.fileData.guid,description:n.currentFile.fileData.description,attachment:n.currentFile.fileData.attachment,name:n.currentFile.fileData.name,date:n.currentFile.fileData.date,user:bizagi.currentUser.idUser,globalParent:n.currentFile.radNumber}},$.when(n.dataService.updateProjectFile(t)).always(function(i){i.status===200||i.status===201||i.status===undefined?($("#ui-bizagi-wp-project-filespreview-description",n.content).text(t.content.description),n.onResetFileForm(),n.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-files-editionsuccess"),"")),n.pub("notify",{type:"UPDATEFILE",args:{description:t.content.description,guid:t.content.guid}})):(n.onResetFileForm(),n.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-general-error-generic"),"")))}))},validateAddFileDescriptionForm:function(n){var i=!1,t=n,r;return t.val().trim()===""?(r=bizagi.localization.getResource("workportal-project-discussion-requireddescription"),t.parent().next().find("span").html(r)):(t.parent().next().find("span").empty(),i=!0),i},onResetFileForm:function(){var n=this;n.form.description.parent().next().find("span").empty();n.dialogBox.formContent.dialog("destroy");n.dialogBox.formContent.detach()},applyMenu:function(){var n=this;$(".ui-bizagi-wp-project-filespreview-edit",n.content).menu({select:$.proxy(n.onSelectMenu,n)}).removeClass("ui-widget-content")},clean:function(){var n=this;n.plugins={};n.form={};n.currentFile={};n.filesNumber=0}});bizagi.injector.register("bizagi.workportal.widgets.project.filesPreview",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.filesPreview]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.file.sidebar",{},{init:function(n,t,i){var r=this;r._super(n,t,i);i=i||{};i.supportNav=!1;r.loadTemplates({"project-file-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.file.sidebar").concat("#project-file-sidebar")})},getWidgetName:function(){return bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_PROJECT_FILE_SIDEBAR},renderContent:function(){var n=this,t=n.getTemplate("project-file-sidebar");return n.content=t.render({}),n.content}});bizagi.injector.register("bizagi.workportal.widgets.project.file.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.file.sidebar],!0);
