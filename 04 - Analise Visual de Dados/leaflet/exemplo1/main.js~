//global variables
let dataIndex = null;
let myMap     = null;

//load data
d3.csv("../../data/ocorrencias_aereas.csv")
    .then(function(data) {
	// data is now whole data set
	data = data.map(item=>{
	    let newItem = {};
	    newItem["ocorrencia_uf"]            = item.ocorrencia_uf;
	    newItem["ocorrencia_horario"]       = item.ocorrencia_horario;
	    newItem["ocorrencia_dia"]           = item.ocorrencia_dia;
	    newItem["ocorrencia_cidade"]        = item.ocorrencia_cidade;
	    newItem["ocorrencia_latitude"]      = +item.ocorrencia_latitude;
	    newItem["ocorrencia_longitude"]     = +item.ocorrencia_longitude;
	    newItem["ocorrencia_pais"]          = item.ocorrencia_pais;
	    newItem["ocorrencia_classificacao"] = item.ocorrencia_classificacao;
	    return newItem;
	});
	//
	dataIndex = crossfilter(data);
	
	// draw chart in here!
	initializeSystem();
    })
    .catch(function(error){
	// handle error   
    })

function addIncidents(){
    //get incidents data from crossfilter
    let colorScale = d3.scaleOrdinal().domain(["ACIDENTE", "INCIDENTE", "INCIDENTE GRAVE"])
	.range(["red", "blue","yellow"]);
    let chartData = dataIndex.allFiltered();
    //use just the first 100 points
    //chartData = chartData.slice(0,100);
    //
    chartData.forEach((function(item){
	//
	let myColor = '#f03';
	myColor = colorScale(item.ocorrencia_classificacao);

	//
	var circle = L.circle([item.ocorrencia_latitude, item.ocorrencia_longitude], {
	    color: myColor,
	    fillColor: myColor,
	    fillOpacity: 0.5,
	    radius: 500
	});
	
	//
	let circlePopupMessage = "Ocorrencia: " + item.ocorrencia_uf + "<br>"+
	    "Data: " + item.ocorrencia_dia + "<br>" +
	    "Classificacao: "+ item.ocorrencia_classificacao;
	circle.bindPopup(circlePopupMessage);
	//add circle to the map
	circle.addTo(this);
	
    }).bind(myMap));
}

function addLegend(){
    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {

	var div = L.DomUtil.create('div', 'info legend');
	var grades = ["Incidente", "Incidente Grave", "Acidente"];   
        var labels = ["blue", "yellow", "red"];

	// loop through our density intervals and generate a label with a colored square for each interval
	for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
		'<i style="background:' + labels[i] + '"></i> ' +
	 	grades[i] + '<br>';
	}

	return div;
    };

    legend.addTo(myMap);
}

function initializeSystem(){
    //variables used to create the map    
    var mapID = "mapID";
    var tileURL = 'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png';
    var tileLayerProperties = {
	maxZoom: 18,
	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    };

    //
    myMap = L.map(mapID).setView([-16.062969971128574,-52.91032791137696], 4);
    var tileLayer = L.tileLayer(tileURL, tileLayerProperties);
    tileLayer.addTo(myMap);

    //
    addIncidents();

    //
    addLegend();
}
