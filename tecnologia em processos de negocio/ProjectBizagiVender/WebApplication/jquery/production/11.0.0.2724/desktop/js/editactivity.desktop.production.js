bizagi.workportal.widgets.project.base.extend("bizagi.workportal.desktop.widgets.project.plan.activities.form",{},{init:function(n,t,i,r){var u=this;u._super(n,t,r);u.dateFormat=bizagi.localization.getResource("dateFormat");u.timeFormat=bizagi.localization.getResource("timeFormat");u.estimatedFinishDateTime;u.plugins={};u.form={};u.notifier=i;u.loadTemplates({"plan-activities-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.form").concat("#project-plan-activities-form"),"plan-activity-items":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.form").concat("#project-activity-items")})},renderContent:function(){var n=this,t=n.getTemplate("plan-activities-main");return n.params.plan.contextualized=typeof n.params.plan.contextualized=="undefined"?!0:n.params.plan.contextualized,n.content=t.render(n.params.plan),n.content},postRender:function(){var n=this,t=n.getContent();n.sub("GETDATA_FORM_EDIT_ACTIVITIY",function(){return n.getDataActivityForm()});n.form={name:$("#activity-form-itemname",n.content),description:$("#activity-form-description",n.content),assignee:$("#activity-form-assignee",n.content),date:$("#activity-form-date",n.content),duration:$("#activity-form-duration",n.content),allowEdition:$("#activity-form-allowedition",n.content),cancel:$("#project-plan-activity-form-cancel",n.content)};n.initializeAutoComplete(n.form.assignee);n.initializeDatePicker(n.form.date);n.initializeSpiner(n.form.duration);$("#link-add-new-item",t).on("click",$.proxy(n.addNewItem,n));n.eventsHandler()},initializeItems:function(n){var t=this,f=t.getContent(),e=t.getTemplate("plan-activity-items"),r={},u,i;r.items=n;u=e.render(r);i=$(".list-items",f);i.empty().append(u);$(".inputtext",i).on("change",$.proxy(t.onSaveForm,t))},initializeAutoComplete:function(n){var t=this,i=t.dataService.serviceLocator.getUrl("admin-getUsersList");n.autocomplete({minLength:2,source:function(n,t){$.ajax({url:i,data:{domain:"",userName:"",fullName:n.term,organization:"",pag:1,pagSize:100,orderField:"fullName"},success:function(n){t($.map(n.users,function(n){return{label:n.user,value:n.idUser}}))}})},select:function(i,r){var u=r.item.label;n.val(u);t.form.IdAssignee=r.item.value;t.onSaveForm(i);return t.pub("notify",{type:"UPDATE_ACTIVITY_INFO",args:{assignee:t.form.IdAssignee}}),!1},focus:function(){return!1},change:function(n,i){return i.item===null&&(t.form.IdAssignee=null,t.form.assignee.val("")),!1}})},initializeDatePicker:function(n){var t=this;n.datepicker({onSelect:function(){t.form.duration.val("");t.estimatedFinishDateTime=t.form.date.datepicker("getDate")?t.form.date.datepicker("getDate").getTime()+86399950:undefined;t.onSaveForm()},onClose:function(){n.val()===""&&t.fieldDurationActive(!0)}});n.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI())},initializeSpiner:function(n){function r(n,i){var r=i||$(n.target).val();bizagi.util.isNumeric(r)&&parseInt(r,10)>0?(t.form.date.val(""),t.estimatedFinishDateTime=undefined):$(n.target).val("")}var t=this,i,u=500,f=bizagi.clone(t.params.plan.idActivitySelected);n.spinner({min:1,max:1e3,placeHolder:bizagi.localization.getResource("workportal-hours"),change:function(n){r(n);f===t.params.plan.idActivitySelected&&t.onSaveForm()},spin:function(n,f){r(n,f.value);clearTimeout(i);$("#myInput").val&&(i=setTimeout($.proxy(t.onSaveForm,t),u))}})},onKeyPressInputItem:function(n){function u(){setTimeout(function(){$(".list-items .item.edit",i).find(".inputtext").focus();var n=$(".list-items .item.edit",i).find(".inputtext").val();$(".list-items .item.edit",i).find(".inputtext").val(n)},51)}function f(n){$(n.target).closest(".item").removeClass("edit");$(n.target).closest(".item").next().addClass("edit");u()}function e(n){$(n.target).closest(".item").removeClass("edit");$(n.target).closest(".item").prev().addClass("edit");u()}var t=this,i=t.getContent(),r,o;setTimeout(function(){$(n.target).siblings(".showtext").text($(n.target).val());$(n.target).prop("title",$(n.target).val())},51);r=n.keyCode||n.which;$(".container-items").removeClass("editing-mouse");switch(r.toString()){case"13":$(n.target).val()!==""&&($(n.target).closest(".item").removeClass("edit"),o=$(n.target).closest(".item").index(),t.addNewItem("",o));break;case"27":$(n.target).closest(".item").prev().length!==0?e(n):$(n.target).closest(".item").next().length!==0&&f(n);$(n.target).closest(".item").remove();t.onSaveForm(n);break;case"38":$(n.target).closest(".item").prev().length!==0&&e(n);break;case"40":$(n.target).closest(".item").next().length!==0&&f(n)}},onFocusInputItem:function(n){$(n.target).closest(".item").addClass("edit").siblings().removeClass("edit")},onFocusOutInputItem:function(n){if($.trim($(n.target).val())===""){var t=$(n.target).closest(".item");$(t).css("display","block").empty().css("background","#E7BA99").animate({backgroundColor:"#FFF",height:"0px"},300,"linear",function(){$(this).remove()})}else $(n.target).closest(".item").removeClass("edit")},onMouseLeaveItem:function(){var n=this,t=n.getContent();$(".container-items",t).addClass("editing-mouse")},onClickDeleteItem:function(n){var t=this;$(n.target).closest(".item").off("keyup",".inputtext",$.proxy(t.onKeyPressInputItem,t));$(n.target).closest(".item").off("click",".item-button.delete",$.proxy(t.onClickDeleteItem,t));$(n.target).closest(".item").remove();t.onSaveForm(n)},addNewItem:function(n,t){var u=this,i=u.getContent(),e,f,r;t===undefined&&(t=$(".list-items .item",i).length-1,t===-1&&(t=0));e=u.getTemplate("plan-activity-items");f={};f.items=[{}];r=e.render(f);$(r).addClass("edit");$(".list-items",i).children().length===0?$(".list-items",i).append(r):$(".list-items",i).children().eq(t).after(r);$(".inputtext",r).on("change",$.proxy(u.onSaveForm,u));setTimeout(function(){$(".list-items .item.edit",i).find(".inputtext").focus()},51)},onDeleteDate:function(n){var t=this;n.keyCode===8&&($(n.target).val(""),t.fieldDurationActive(!0))},onTypeDuration:function(n){var t=this,i=$(n.target);i.val()!==""&&(t.form.date.val(""),t.estimatedFinishDateTime=undefined)},onCancelForm:function(){var n=this;n.pub("notify",{type:"PLANSIDEBAR",args:n.params})},onSaveForm:function(n){n&&n.preventDefault();var t=this,i=t.getDataActivityForm();i&&$.when(t.dataService.editActivityPlan(i)).always(function(n,i,r){r.status===200&&i!=="success"&&t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-activity-update-message"),""))})},getDataActivityForm:function(){function i(){var n=[];return $(".list-items .inputtext").each(function(){$(this).val().trim()!==""&&n.push({id:undefined,resolved:$(this).closest(".item").find("input[type='checkbox']").is(":checked"),name:$(this).val()})}),n}var n=this;if(n.validateParams(n.form.name.val())){var r=n.form.IdAssignee||bizagi.currentUser.idUser,u=n.form.allowEdition.is(":checked")||!1,t={};return $.each(n.params.plan.activities,function(){this.id===n.params.plan.idActivitySelected&&(this.duration=n.form.duration.val(),this.userAssigned=r,this.allowEdition=u,this.description=n.form.description.val(),this.name=n.form.name.val(),this.estimatedFinishDate=n.estimatedFinishDateTime,this.items=i(),this.numTotalItems=this.items.length,t=this)}),t}return!1},validateParams:function(n){var t=this,i;return n===""?(i="* "+bizagi.localization.getResource("workportal-project-plan-popup-field-name-required"),t.form.name.next().find("span").html(i),!1):(t.form.name.next().find("span").empty(),!0)},onChangeForm:function(n,t){var i=this,u,r;i.estimatedFinishDateTime=undefined;u=t.args.idActivityToShow||i.params.plan.idActivitySelected;r=i.params.plan.activities.filter(function(n){return n.id===u})[0];i.setValuesFormFields(t.args.isEditableFormActivity,r);i.setEnabledFormFields(t.args.isEditableFormActivity,r)},onChangeActivityName:function(n){var t=this;t.onSaveForm();t.pub("notify",{type:"UPDATE_ACTIVITY_INFO",args:{displayName:$(n.target).val()}})},setEnabledFormFields:function(n){var t=this;$(t.form.date).blur();n?($(".ui-bizagi-wp-project-plan-activity-action-menu",t.content).show(),$("#activity-form-itemname",t.content).prop("disabled",!1),$("#activity-form-itemname",t.content).removeClass("ui-state-disabled"),$("#activity-form-description",t.content).prop("disabled",!1),$("#activity-form-description",t.content).removeClass("ui-state-disabled"),t.form.assignee.removeClass("ui-state-disabled"),t.activateElement(t.form.assignee),t.fieldDurationActive(!0),t.activateElement(t.form.date),t.form.date.removeClass("ui-state-disabled"),$("#activity-form-allowedition",t.content).prop("disabled",!1),$(".container-items",t.content).addClass("is-editing"),$("#link-add-new-item",t.content).show()):($(".ui-bizagi-wp-project-plan-activity-action-menu",t.content).hide(),$("#activity-form-itemname",t.content).prop("disabled",!0),$("#activity-form-itemname",t.content).addClass("ui-state-disabled"),$("#activity-form-description",t.content).prop("disabled",!0),$("#activity-form-description",t.content).addClass("ui-state-disabled"),t.form.assignee.addClass("ui-state-disabled"),t.deactivateElement(t.form.assignee),t.deactivateElement(t.form.date),t.form.date.addClass("ui-state-disabled"),t.fieldDurationActive(!1),$("#activity-form-allowedition",t.content).prop("disabled",!0),$(".container-items",t.content).removeClass("is-editing"),$("#link-add-new-item",t.content).hide())},setValuesFormFields:function(n,t){var i=this;$("#project-plan-activity-form",i.content)[0].reset();$(".list-items .item",i.content).remove();i.form.name.val(t.name);i.form.description.val(t.description);t.userAssigned&&i.setUserAssignedById(t.userAssigned);i.form.date.datepicker("option","minDate",new Date(i.getDateServer()));t.estimatedFinishDate&&parseInt(t.estimatedFinishDate,10)<i.getDateServer()&&i.form.date.datepicker("option","minDate",new Date(parseInt(t.estimatedFinishDate,10)));t.estimatedFinishDate&&(i.form.date.datepicker("setDate",new Date(parseInt(t.estimatedFinishDate,10))),i.estimatedFinishDateTime=t.estimatedFinishDate);t.duration&&i.form.duration.val(parseInt(t.duration,10));t.allowEdition===!0?i.form.allowEdition.prop("checked",!0):i.form.allowEdition.prop("checked",!1);t.numTotalItems>0?($(".container-items h4",i.content).show(),$(".container-items span",i.content).hide(),i.initializeItems(t.items)):n?$(".container-items span",i.content).hide():$(".container-items span",i.content).show()},fieldDurationActive:function(n){var t=this;n?(t.form.duration.prop("disabled",!1),t.form.duration.spinner("option","disabled",!1)):(t.form.duration.prop("disabled",!0),t.form.duration.spinner("option","disabled",!0))},deactivateElement:function(n){n.prop?(n.prop("disabled",!0),n.closest("tr").addClass("ui-bizagi-workportal-opacity")):(n.enable(!1),n.wrapper.closest("tr").addClass("ui-bizagi-workportal-opacity"))},activateElement:function(n){n.prop?(n.prop("disabled",!1),n.closest("tr").removeClass("ui-bizagi-workportal-opacity")):(n.enable(!0),n.wrapper.closest("tr").removeClass("ui-bizagi-workportal-opacity"))},setUserAssignedById:function(n){var t=this;t.callGetDataUsers(n).then(function(n){t.form.assignee.val(n[0].name)});t.form.IdAssignee=n},eventsHandler:function(){var n=this;n.form.date.on("keydown",$.proxy(n.onDeleteDate,n));n.form.duration.on("keyup",$.proxy(n.onTypeDuration,n));n.form.cancel.on("click",$.proxy(n.onCancelForm,n));n.form.name.on("change",$.proxy(n.onChangeActivityName,n));n.form.description.on("change",$.proxy(n.onSaveForm,n));n.form.allowEdition.on("change",$.proxy(n.onSaveForm,n));n.form.name.donetyping(function(){n.onSaveForm()});n.form.description.donetyping(function(){n.onSaveForm()});n.form.duration.donetyping(function(){n.onSaveForm()});$(".list-items",n.content).on("keyup",".inputtext",$.proxy(n.onKeyPressInputItem,n));$(".list-items",n.content).on("focusout",".inputtext",$.proxy(n.onFocusOutInputItem,n));$(".list-items",n.content).on("focus",".inputtext",$.proxy(n.onFocusInputItem,n));$(".list-items",n.content).on("click",".item-button.delete",$.proxy(n.onClickDeleteItem,n));$(".list-items",n.content).on("mouseleave",".item",$.proxy(n.onMouseLeaveItem,n));n.sub("EDITACTIVITY",$.proxy(n.onChangeForm,n))},callGetDataUsers:function(n){var i=this,t=$.Deferred(),r={userIds:n,width:50,height:50};return i.dataService.getUsersData(r).always(function(n){t.resolve(n)}),t.promise()},clean:function(){var n=this;n.unsub("EDITACTIVITY",$.proxy(n.onChangeForm,n))}});bizagi.injector.register("bizagi.workportal.desktop.widgets.project.plan.activities.form",["workportalFacade","dataService","notifier",bizagi.workportal.desktop.widgets.project.plan.activities.form],!0);
