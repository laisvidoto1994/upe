$.Class.extend("bizagi.bpmn.modeler.observable",{},{subscribe:function(){this.observableElement().bind.apply(this.observableElement(),arguments)},unsubscribe:function(){this.observableElement().unbind.apply(this.observableElement(),arguments)},publish:function(){return this.observableElement().triggerHandler.apply(this.observableElement(),arguments)},observableElement:function(){return this._observableElement?this._observableElement:this._observableElement=$({})}});
bizagi.bpmn.modeler.observable.extend("bizagi.bpmn.modeler.model",{},{init:function(){this.tasks={};this.canvas={}},setModel:function(n){this.tasks=n.tasks;this.canvas=n.canvas;this.triggerModelRedraw()},getViewModel:function(){var n=[];for(val in this.tasks)n.push(this.tasks[val]);return{tasks:n,canvas:this.canvas,isGateway:this.isGateway}},getPersistenceModel:function(){var n={tasks:jQuery.extend({},this.tasks),canvas:jQuery.extend({},this.canvas)};return $.each(n.tasks,function(n,t){delete t.showAura}),n},getTaskById:function(n){return this.tasks[n]},getConnectionRule:function(n,t){var r=this.tasks[n],i;return this.isGateway(r.type)?(i=$.grep(r.rules,function(n){return n.target==t}),i.length>0?i[0].expression:null):null},successorConnectionsCanContainRule:function(n){var n=this.tasks[n];return this.isGateway(n.type)},setCanvasBounds:function(n){this.canvas=n;this.triggerModelChange({redraw:!1})},setExtendedProperty:function(n,t,i){this.tasks[n]&&(this.tasks[n].extendedProperties=this.tasks[n].extendedProperties||{},this.tasks[n].extendedProperties[t]=i,this.triggerModelChange({redraw:!1}))},getExtendedProperty:function(n,t){return this.tasks[n]?this.tasks[n].extendedProperties[t]:null},addTask:function(n,t,i){var r={id:this.newGuid(),type:n,displayName:this.getDefaultName(n),duration:this.getDuration(n),position:t,showAura:!1,predecessors:[],successors:[],rules:[],extendedProperties:{}};i&&r.predecessors.push(i);this.tasks[r.id]=r;this.tasks[i]&&this.tasks[i].successors.push(r.id);this.setAura(r.id,!0);this.triggerModelChange()},addConnection:function(n,t){var i=this.tasks[n],r=this.tasks[t];i.successors.push(t);r.predecessors.push(n);this.triggerModelChange()},changeTaskName:function(n,t){if(this.tasks[n]){if(this.tasks[n].displayName==t)return;this.tasks[n].displayName=t;this.triggerModelChange({redraw:!1})}},changeDuration:function(n,t){if(this.tasks[n]){if(this.tasks[n].duration==t)return;this.tasks[n].duration=t;this.triggerModelChange({redraw:!1})}},changeTaskType:function(n,t){if(this.tasks[n]){if(this.tasks[n].type==t)return;this.tasks[n].type=t;this.triggerModelChange()}},moveTask:function(n,t){this.tasks[n]&&(this.tasks[n].position=t,this.triggerModelChange())},setAura:function(n,t){$.each(this.tasks,function(n,t){t.showAura=!1});this.tasks[n]&&(this.tasks[n].showAura=t)},setConnectionRule:function(n,t,i){var u=this.tasks[n],r=$.grep(u.rules,function(n){return n.target==t}),f=r.length>0?r[0]:{target:t};r.length==0&&u.rules.push(f);f.expression=i;this.triggerModelChange()},deleteTask:function(n){$.each(this.tasks,function(t,i){i.predecessors&&i.predecessors.length>0&&i.predecessors.removeAll(n);i.successors&&i.successors.length>0&&i.successors.removeAll(n)});delete this.tasks[n];this.triggerModelChange()},deleteArrow:function(n,t){var i=this.tasks[n],r=this.tasks[t];i&&i.successors.removeAll(t);r&&r.predecessors.removeAll(n);this.triggerModelChange()},newGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=Math.random()*16|0,i=n=="x"?t:t&3|8;return i.toString(16)})},getDefaultName:function(n){if(n=="UserTask"){var t=$.grep(Object.values(this.tasks),function(n){return n.type=="UserTask"});return"Task "+(t.length+1)}return null},getDuration:function(n){return n=="UserTask"?1:null},triggerModelRedraw:function(){this.publish("model.redraw")},triggerModelChange:function(n){n=n||{redraw:!0};this.publish("model.change");n.redraw&&this.triggerModelRedraw()},isGateway:function(n){return n=="ExclusiveGateway"||n=="ParallelGateway"||n=="InclusiveGateway"||n=="ComplexGateway"}});
bizagi.bpmn.modeler.observable.extend("bizagi.bpmn.modeler.aura",{externalOptions:{form:"bz-icon bz-icon-template-outline",assignee:"bz-icon bz-icon-user-manage"},getClassForExternalOption:function(n){return this.externalOptions[n]}},{init:function(n){$.views.converters("externaloption_class",function(n){return bizagi.bpmn.modeler.aura.getClassForExternalOption(n)});$.templates({bpm_modeler_aura:'<aura class="bpm-aura-for-{{:type}}">                                     {{if showArrow}}                                             <aura-option class="bpm-option-arrow bpmn-icon-connection-multi" data-predecessor="{{:~root.id}}"><\/aura-option>                                     {{/if}}                                     {{for options tmpl="bpm_modeler_auraOption"/}}                                     <special-options {{if showRuleOption}} class="bpm-show-rule-option" {{/if}}>                                         <special-option class="bpm-option-delete bpmn-icon-trash"><\/special-option>                                         {{if showRuleOption}}                                             <special-option class="bpm-option-expression bpmn-icon-conditional-flow"><\/special-option>                                             <special-option class="bpm-option-else bpmn-icon-default-flow"><\/special-option>                                         {{/if}}                                         {{if changeTo && changeTo.length > 0}}                                         <special-option class="bpm-option-change bz-icon bz-icon-asynchronous-outline"><\/special-option>                                         <aura-change>                                             {{for changeTo tmpl="bpm_modeler_auraChangeTo"/}}                                         <\/aura-change>                                         {{/if}}                                     <\/special-options>                                     {{if externalOptions && externalOptions.length > 0}}                                         <external-options>                                             {{for externalOptions tmpl="bpm_modeler_auraExternalOption"/}}                                         <\/external-options>                                     {{/if}}                                 <\/aura>',bpm_modeler_auraOption:'<aura-option class="bpm-{{:#data}} {{tasktype_class: #data}} bpm-cloneable"                                             data-type="{{:#data}}"                                             data-predecessor="{{:~root.id}}">                                         <\/aura-option>',bpm_modeler_auraChangeTo:'<aura-change-to class="bpm-{{:#data}} {{tasktype_class: #data}}"                                                  data-type="{{:#data}}"                                                 data-task="{{:~root.id}}">                                         <\/aura-change-to>',bpm_modeler_auraExternalOption:'<external-option class="bpm-{{:#data}} {{externaloption_class: #data}}"                                                         data-option="{{:#data}}"                                                         data-task="{{:~root.id}}">                                                 <\/external-option>'});this.model=n;this.previousElementId=null;this.aura=null},showForTask:function(n){var t=this,i=n.attr("id"),f={type:"UserTask",options:this.getOptions(n),changeTo:this.getChangeTo(n),externalOptions:this.getExternalOptions(n),showArrow:!0,positioning:"right"},r=this.show(n,f),u;if(r){u=this.aura.find("special-options");u.position({of:n,my:"center-8 top+10",at:"center bottom",collision:"none"});this.aura.find("special-option.bpm-option-change").on("click",function(){t.showChangeToOptions(this)});this.aura.find("special-option.bpm-option-delete").on("click",function(){t.deleteTask(i)});this.aura.find("external-option").on("click",function(){t.manageExternalOption($(this),i)});this.aura.find("aura-option.bpm-option-arrow").draggable({helper:"clone",containment:"#bpm-drawing",grid:[20,20],drag:function(n,r){t.dragArrow(r,i)}})}return r},showForArrow:function(n,t){var f=this,i=n.attr("id"),e={type:"arrow",positioning:"center",showRuleOption:t},r=this.show(n,e),u;if(r){u=this.aura.find("special-options");u.position({of:n,my:"center center",at:"center center",collision:"none"});this.aura.find("special-option.bpm-option-delete").on("click",function(){f.deleteArrow(i)});this.addHandlersForExpressions(i)}return r},show:function(n,t){var e=this,i=n.attr("id"),r,u,f;return this.previousElementId&&(r=this.previousElementId==i,this.hide(this.previousElementId),r)?!1:(this.previousElementId=i,u=$.templates.bpm_modeler_aura.render($.extend(t,{id:i})),this.aura=$(u),n.after(this.aura),this.moveTo(n,t.positioning),t.externalOptions&&(f=this.aura.find("external-options"),f.position({of:n,my:"center-15 bottom+16",at:"center top",collision:"none"})),this.aura.find("aura-option").draggable({helper:"clone",containment:"#bpm-drawing",grid:[20,20],drag:function(n,t){e.publish("item.drag",t)}}),!0)},hide:function(n){(n=n||this.previousElementId,n!=null)&&(this.aura&&this.aura.detach(),this.previousElementId=null)},moveTo:function(n,t){var i=n.attr("id");if(i!=this.previousElementId){this.hide();return}t=t||"right";t=="right"&&this.aura.position({of:n,my:"left+20 center",at:"right center",collision:"none"})},showChangeToOptions:function(n){var t=this.aura.find("aura-change");t.toggleClass("visible");t.position({of:n,my:"center top+10",at:"center bottom",collision:"none"});t.find("aura-change-to").click($.proxy(this.changeTo,this))},addHandlersForExpressions:function(n){var t=this;this.aura.find(".bpm-option-else").click(function(){var i=bizagi.bpmn.modeler.connector.getSourceTaskFromId(n),r=bizagi.bpmn.modeler.connector.getTargetTaskFromId(n);t.publish("arrow.setElse",n);t.model.setConnectionRule(i,r,"else")});this.aura.find(".bpm-option-expression").click(function(){t.publish("arrow.setExpression",n)})},deleteTask:function(n){this.model.deleteTask(n)},deleteArrow:function(n){var t=bizagi.bpmn.modeler.connector.getSourceTaskFromId(n),i=bizagi.bpmn.modeler.connector.getTargetTaskFromId(n);this.model.deleteArrow(t,i)},dragArrow:function(n,t){this.publish("arrow.drag",{source:t,target:n.offset})},changeTo:function(n){var t=$(n.currentTarget),i=t.data("type"),r=t.data("task");this.model.changeTaskType(r,i)},manageExternalOption:function(n,t){var i=n.data("option");this.publish("task.externaloption",{task:t,option:i})},getOptions:function(n){var t=n.data("type");return t=="EndEvent"?[]:["IntermediateEvent","EndEvent","ExclusiveGateway","UserTask"]},getChangeTo:function(n){var t=n.data("type"),i=[];return(t=="ExclusiveGateway"||t=="ParallelGateway"||t=="InclusiveGateway"||t=="ComplexGateway"?i=["ParallelGateway","InclusiveGateway","ComplexGateway","ExclusiveGateway"]:(t=="EndEvent"||t=="TerminateEvent")&&(i=["EndEvent","TerminateEvent"]),i.length>0)?(i.removeOne(t),i):null},getExternalOptions:function(n){var t=n.data("type");return t!="UserTask"&&t!="IntermediateEvent"?[]:["form","assignee"]}});
$.Class.extend("bizagi.bpmn.modeler.path",{},{curve:8,arrowHeight:10,calculateAnchors:function(n,t){var e=Math.min(n.width,t.width),o=Math.min(n.height,t.height),u=n.x+n.width/2,f=t.x+t.width/2,i=n.y+n.height/2,r=t.y+t.height/2;if(n.x+n.width+e<t.x)return{el1:"right",el2:"left"};if(n.x>t.x+t.width+e)return{el1:"left",el2:"right"};if(this.areElementsVeryCloseInXAxis(n,t,e)){if(n.y+n.height<t.y)return{el1:"bottom",el2:"top"};if(n.y>t.y+t.height)return{el1:"top",el2:"bottom"}}if(Math.abs(i-r)<o){if(n.x<t.x)return{el1:"right",el2:"left"};if(n.x>=t.x)return{el1:"left",el2:"right"}}return u<f&&i<r?{el1:"bottom",el2:"left"}:u>f&&i<r?{el1:"bottom",el2:"right"}:u<f&&i>r?{el1:"top",el2:"left"}:u>f&&i>r?{el1:"top",el2:"right"}:void 0},getPath:function(n,t,i,r){var f=Math.min(i.width,r.width),e=Math.min(i.height,r.height),u={x:this.arrowHeight,y:this.arrowHeight,w:n.width-this.arrowHeight,h:n.height-this.arrowHeight};if(this.areVerticalAnchors(t)&&Math.abs(i.x-r.x)<10){if(i.y<r.y)return this.getPathTopToBottom(u,i,r);if(i.y>r.y)return this.getPathBottomToTop(u,i,r)}if(this.areHorizontalAnchors(t)&&Math.abs(i.y-r.y)<10){if(i.x<r.x)return this.getPathLeftToRight(u);if(i.x>r.x)return this.getPathRightToLeft(u)}if(this.areHorizontalAnchors(t)){if(i.x<r.x&&i.y<r.y)return this.getPathLeftToRightBottom(u);if(i.x<r.x&&i.y>r.y)return this.getPathLeftToRightTop(u);if(i.x>r.x&&i.y<r.y)return this.getPathRightToLeftBottom(u);if(i.x>r.x&&i.y>r.y)return this.getPathRightToLeftTop(u)}if(this.areVerticalAnchors(t)){if(i.x<r.x&&i.y<r.y)return this.getPathTopToBottomLeft(u);if(i.x<r.x&&i.y>r.y)return this.getPathBottomToTopLeft(u);if(i.x>r.x&&i.y<r.y)return this.getPathTopToBottomRight(u);if(i.x>r.x&&i.y>r.y)return this.getPathBottomToTopRight(u)}return t.el1=="bottom"&&t.el2=="left"?this.getPathBottomToLeft(u):t.el1=="bottom"&&t.el2=="right"?this.getPathBottomToRight(u):t.el1=="top"&&t.el2=="left"?this.getPathTopToLeft(u):t.el1=="top"&&t.el2=="right"?this.getPathTopToRight(u):void 0},getTransform:function(n,t,i){return this.areVerticalAnchors(n)&&Math.abs(t.x-i.x)<this.arrowHeight?"translate(5, 0)":(n.el1=="left"||n.el1=="right")&&Math.abs(t.y-i.y)<this.arrowHeight?"translate(0, 5)":""},areHorizontalAnchors:function(n){return n.el1=="left"&&n.el2=="right"||n.el1=="right"&&n.el2=="left"},areVerticalAnchors:function(n){return n.el1=="top"&&n.el2=="bottom"||n.el1=="bottom"&&n.el2=="top"},areElementsVeryCloseInXAxis:function(n,t,i){var r=n.x+n.width/2,u=t.x+t.width/2;return Math.abs(r-u)<i?!0:Math.abs(r-t.x)<i?!0:Math.abs(r-t.x+t.width)<i?!0:Math.abs(u-n.x)<i?!0:Math.abs(u-n.x+n.width)<i?!0:!1},getPathLeftToRight:function(n){var r=n.x,t=n.w,u=n.h/2,i=n.h/2;return"M "+r+","+u+" L "+t+","+i+" "+this.getArrowRight(t,i)},getPathRightToLeft:function(n){var r=n.w,t=n.x,u=n.h/2,i=n.h/2;return"M "+r+","+u+" L "+t+","+i+" "+this.getArrowLeft(t,i)},getPathTopToBottom:function(n,t,i){var r=t.x<i.x?this.arrowHeight:n.w,e=r/2,u=r/2,o=n.y,f=n.h;return"M "+e+","+o+" L "+u+","+f+" "+this.getArrowDown(u,f)},getPathBottomToTop:function(n,t,i){var r=t.x<i.x?this.arrowHeight:n.w,e=r/2,u=r/2,o=n.h,f=n.y;return"M "+e+","+o+" L "+u+","+f+" "+this.getArrowUp(u,f)},getPathLeftToRightBottom:function(n){var e=n.x,f=n.w,r=n.y,i=n.h,t=n.w/2,o=n.h/2,u=this.curve;return"M "+e+","+r+" L "+(t-u)+","+r+" S "+t+","+r+" "+t+","+(r+u)+" L "+t+","+(i-u)+" S "+t+","+i+" "+(t+u)+","+i+" L "+f+","+i+" "+this.getArrowRight(f,i)},getPathLeftToRightTop:function(n){var e=n.x,f=n.w,r=n.h,i=n.y,t=n.w/2,o=n.h/2,u=this.curve;return"M "+e+","+r+" L "+(t-u)+","+r+" S "+t+","+r+" "+t+","+(r-u)+" L "+t+","+(i+u)+" S "+t+","+i+" "+(t+u)+","+i+" L "+f+","+i+" "+this.getArrowRight(f,i)},getPathRightToLeftBottom:function(n){var e=n.w,f=n.x,r=n.y,i=n.h,t=n.w/2,o=n.h/2,u=this.curve;return"M "+e+","+r+" L "+(t+u)+","+r+" S "+t+","+r+" "+t+","+(r+u)+" L "+t+","+(i-u)+" S "+t+","+i+" "+(t-u)+","+i+" L "+f+","+i+" "+this.getArrowLeft(f,i)},getPathRightToLeftTop:function(n){var e=n.w,f=n.x,r=n.h,i=n.y,t=n.w/2,o=n.h/2,u=this.curve;return"M "+e+","+r+" L "+(t+u)+","+r+" S "+t+","+r+" "+t+","+(r-u)+" L "+t+","+(i+u)+" S "+t+","+i+" "+(t-u)+","+i+" L "+f+","+i+" "+this.getArrowLeft(f,i)},getPathTopToBottomLeft:function(n){var r=n.x,i=n.w,e=n.y,f=n.h,o=n.w/2,t=n.h/2,u=this.curve;return"M "+r+","+e+" L "+r+","+(t-u)+" S "+r+","+t+" "+(r+u)+","+t+" L "+(i-u)+","+t+" S "+i+","+t+" "+i+","+(t+u)+" L "+i+","+f+" "+this.getArrowDown(i,f)},getPathTopToBottomRight:function(n){var r=n.w,i=n.x,e=n.y,f=n.h,o=n.w/2,t=n.h/2,u=this.curve;return"M "+r+","+e+" L "+r+","+(t-u)+" S "+r+","+t+" "+(r-u)+","+t+" L "+(i+u)+","+t+" S "+i+","+t+" "+i+","+(t+u)+" L "+i+","+f+" "+this.getArrowDown(i,f)},getPathBottomToTopLeft:function(n){var r=n.x,i=n.w,e=n.h,f=n.y,o=n.w/2,t=n.h/2,u=this.curve;return"M "+r+","+e+" L "+r+","+(t+u)+" S "+r+","+t+" "+(r+u)+","+t+" L "+(i-u)+","+t+" S "+i+","+t+" "+i+","+(t-u)+" L "+i+","+f+" "+this.getArrowUp(i,f)},getPathBottomToTopRight:function(n){var r=n.w,i=n.x,e=n.h,f=n.y,o=n.w/2,t=n.h/2,u=this.curve;return"M "+r+","+e+" L "+r+","+(t+u)+" S "+r+","+t+" "+(r-u)+","+t+" L "+(i+u)+","+t+" S "+i+","+t+" "+i+","+(t-u)+" L "+i+","+f+" "+this.getArrowUp(i,f)},getPathBottomToLeft:function(n){var i=n.x,r=n.w,f=n.y,t=n.h,u=this.curve;return"M "+i+","+f+" L "+i+","+(t-u)+" S "+i+","+t+" "+(i+u)+","+t+" L "+r+","+t+" "+this.getArrowRight(r,t)},getPathBottomToRight:function(n){var i=n.w,r=n.x,f=n.y,t=n.h,u=this.curve;return"M "+i+","+f+" L "+i+","+(t-u)+" S "+i+","+t+" "+(i-u)+","+t+" L "+r+","+t+" "+this.getArrowLeft(r,t)},getPathTopToLeft:function(n){var i=n.x,r=n.w,f=n.h,t=n.y,u=this.curve;return"M "+i+","+f+" L "+i+","+(t+u)+" S "+i+","+t+" "+(i+u)+","+t+" L "+r+","+t+" "+this.getArrowRight(r,t)},getPathTopToRight:function(n){var i=n.w,r=n.x,f=n.h,t=n.y,u=this.curve;return"M "+i+","+f+" L "+i+","+(t+u)+" S "+i+","+t+" "+(i-u)+","+t+" L "+r+","+t+" "+this.getArrowLeft(r,t)},getArrowRight:function(){var n=this.arrowHeight/2;return"m -"+n+",-"+n+" l "+n+","+n+" l -"+n+","+n},getArrowLeft:function(){var n=this.arrowHeight/2;return"m "+n+",-"+n+" l -"+n+","+n+" l "+n+","+n},getArrowUp:function(){var n=this.arrowHeight/2;return"m -"+n+","+n+" l "+n+",-"+n+" l "+n+","+n},getArrowDown:function(){var n=this.arrowHeight/2;return"m -"+n+",-"+n+" l "+n+","+n+" l "+n+",-"+n}});
$.Class.extend("bizagi.bpmn.modeler.connector",{buildConnectorId:function(n,t){return"svgFrom_"+n+"_to_"+t},getSourceTaskFromId:function(n){var t=n.indexOf("svgFrom_"),i=n.indexOf("_to_");return n.substring(t+8,i)},getTargetTaskFromId:function(n){var t=n.indexOf("_to_");return n.substring(t+4)}},{init:function(){$.templates({bpm_modeler_connector:'<connector style="position:absolute;left:{{:left}}px;top:{{:top}}px"                                                 id="{{:id}}"                                                 class="bpm-{{:expression}}"                                                 data-expression="{{:expression}}">                                         <svg width="{{:width}}" height="{{:height}}">                                             <path d="{{:path}}" fill="none" stroke="{{:stroke}}" transform="{{:transform}}"/>                                         <\/svg>                                         {{if expression == "else"}} <connector-label>else<\/connection-label> {{/if}}                                     <\/connector>'});this.path=new bizagi.bpmn.modeler.path;this.stroke="#000"},connect:function(n,t,i,r){var u=this.getBounds(t),f=this.getBounds(i),e=this.Class.buildConnectorId(t.attr("id"),i.attr("id"));this.drawLine(n,e,u,f,r)},drawLine:function(n,t,i,r,u){var e=this.modifyPositions(i,r),f={id:t,top:this.getTop(i,r),left:this.getLeft(i,r),width:this.getWidth(i,r),height:this.getHeight(i,r),transform:this.path.getTransform(e,i,r),expression:u,stroke:this.stroke},o,s,h;f.path=this.path.getPath(f,e,i,r);o=$.templates.bpm_modeler_connector.render(f);connector=$(o);n.append(connector);u=="else"&&(s=connector.find("svg"),h=connector.find("connector-label"),h.position({of:s,my:"center center",at:"center center",collision:"none"}))},refresh:function(n,t,i){var u=this.Class.buildConnectorId(t.attr("id"),i.attr("id")),r=$("#"+u),f=r.data("expression");r.detach();this.connect(n,t,i,f)},drawTemporalConnector:function(n,t,i){var r="svgTemporalConnector",u,f;n.find("#"+r).detach();u=this.getBounds(t);f={x:i.left,y:i.top,width:0,height:0};this.drawLine(n,r,u,f)},removeTemporalConnector:function(n){n.find("#svgTemporalConnector").detach()},getBounds:function(n){var t=n.position();return{x:t.left,y:t.top,width:n.outerWidth(),height:n.outerHeight()}},getLeft:function(n,t){return Math.min(n.x,t.x)-this.path.arrowHeight},getTop:function(n,t){return Math.min(n.y,t.y)-this.path.arrowHeight},getWidth:function(n,t){return Math.abs(n.x-t.x)+this.path.arrowHeight*2},getHeight:function(n,t){return Math.abs(n.y-t.y)+this.path.arrowHeight*2},modifyPositions:function(n,t){var i=this.path.calculateAnchors(n,t);return this.adjustToAnchor(n,i.el1),this.adjustToAnchor(t,i.el2),i},adjustToAnchor:function(n,t){(t=="top"||t=="bottom")&&(n.x=n.x+n.width/2);(t=="left"||t=="right")&&(n.y=n.y+n.height/2);t=="bottom"&&(n.y=n.y+n.height);t=="right"&&(n.x=n.x+n.width)}});
bizagi.bpmn.modeler.observable.extend("bizagi.bpmn.modeler.drawing",{},{init:function(n){var t=this;$.templates({bpm_modeler_drawing:'<drawing>                                     {{for tasks tmpl="bpm_modeler_drawingItem"/}}                                   <\/drawing>',bpm_modeler_drawingItem:'<item id="{{: id}}" class="bpm-{{:type}} bpm-moveable"                                             style="left:{{:position.x}}px; top:{{:position.y}}px"                                             data-type="{{: type}}"                                            data-show-aura="{{:showAura}}">                                             <label class="label_task_name">{{:displayName}}<\/label>                                             {{if ~root.isGateway(type)}}<gateway-helper><\/gateway-helper>{{/if}}                                             {{if duration}}<duration>{{:duration}}<\/duration>{{/if}}                                        <\/item>'});this.drawingWidth=0;this.drawingHeight=0;this.model=n;this.model.subscribe("model.redraw",$.proxy(this.refresh,this));this.aura=new bizagi.bpmn.modeler.aura(this.model);this.aura.subscribe("item.drag",$.proxy(this.onElementDragging,this));this.aura.subscribe("arrow.drag",$.proxy(this.onArrowDragging,this));this.aura.subscribe("arrow.setExpression",$.proxy(this.editExpressionForArrow,this));this.aura.subscribe("arrow.setElse",$.proxy(this.triggerElseExpressionForArrow,this));this.aura.subscribe("task.externaloption",$.proxy(this.manageExternalOption,this));this.connector=new bizagi.bpmn.modeler.connector},render:function(n,t){var r=this,u,i,f;this.readOnly=t||!1;u=this.canvas==null;this.canvas=n;i=this.model.getViewModel();f=$.templates.bpm_modeler_drawing.render(i);n.append(f);this.drawing=n.find("drawing");this.canvasWidth=n.width();this.canvasHeight=n.height();this.scrollTop=i.canvas.top||0;this.scrollLeft=i.canvas.left||0;this.drawingWidth=i.canvas.width||this.canvasWidth;this.drawingHeight=i.canvas.height||this.canvasHeight;this.canvas.scrollLeft(this.scrollLeft);this.canvas.scrollTop(this.scrollTop);setTimeout(function(){r.addConnectors(i)},0);this.addHandlers();u&&!this.readOnly&&this.addGeneralHandlers();this.drawing.find("item[data-show-aura=true]").click();$("#bpm-drawing").find(".label_task_name ").each(function(n,t){var i=$(t).text();r.setNameTask(i,$(t))?$(t).text(i.substring(0,20)+"..."):$(t).text(i)})},refresh:function(){this.canvas.empty();this.aura.hide();this.render(this.canvas)},addHandlers:function(){this.drawing.find("item").draggable({containment:"#bpm-drawing",grid:[20,20],drag:$.proxy(this.onTaskDragging,this)});this.configureDroppable()},addGeneralHandlers:function(){this.canvas.on("click","item",$.proxy(this.showAura,this));this.canvas.on("dblclick","item label",$.proxy(this.editTaskName,this));this.canvas.on("dblclick","item duration",$.proxy(this.editDuration,this));this.canvas.on("click","connector",$.proxy(this.showAuraForArrow,this))},configureDroppable:function(){var n=this;this.drawing.droppable({drop:function(t,i){setTimeout(function(){i.helper.hasClass("bpm-cloneable")?n.addTask(i):i.helper.hasClass("bpm-moveable")?n.moveTask(i):i.helper.hasClass("bpm-option-arrow")&&n.addArrow(i)},0)},accept:".bpm-cloneable, .bpm-moveable, .bpm-option-arrow"})},addTask:function(n){var u=n.draggable.data("type"),f=n.draggable.data("predecessor"),r=this.fixPosition(n.offset),t=r.left,i=r.top;t=t-t%20;i=i-i%20;this.model.addTask(u,{x:t,y:i},f)},moveTask:function(n){var u=n.draggable.data("type"),r=n.draggable.attr("id"),t=n.position.left,i=n.position.top;t=t-t%20;i=i-i%20;this.model.moveTask(r,{x:t,y:i})},editTaskName:function(n){var i=this,t=$(n.currentTarget),u=t.parent().attr("id"),r=$("<input type='text' />");r.val(t.text());this.showPopupEditor(t,r,function(n){i.model.changeTaskName(u,n);i.setNameTask(n,t)?t.text(n.substring(0,20)+"..."):t.text(n)})},manageExternalOption:function(n,t){this.publish("drawing.externaloption",t)},editDuration:function(n){var r=this,t=$(n.currentTarget),u=t.parent().attr("id"),i=$('<input type="number" min="1" onkeypress="if(this.value.length==4) return false; return event.charCode >= 48 && event.charCode <= 57"/>');i.val(t.text());this.showPopupEditor(t,i,function(n){r.model.changeDuration(u,n);t.text(n)})},addArrow:function(n){var r=n.draggable.data("predecessor"),u=this.fixPosition(n.offset),t=this.getTasksAtPosition(u),i;t.length==1?(i=t.attr("id"),this.model.addConnection(r,i)):this.connector.removeTemporalConnector(this.canvas)},editExpressionForArrow:function(n,t){var i=bizagi.bpmn.modeler.connector.getSourceTaskFromId(t),r=bizagi.bpmn.modeler.connector.getTargetTaskFromId(t);this.publish("drawing.externaloption",{option:"rule",source:i,target:r})},triggerElseExpressionForArrow:function(n,t){var i=bizagi.bpmn.modeler.connector.getSourceTaskFromId(t),r=bizagi.bpmn.modeler.connector.getTargetTaskFromId(t);this.publish("drawing.externaloption",{option:"else",source:i,target:r})},setExpressionForArrow:function(n,t){this.model.setConnectionRule(n,t,"boolean")},moveCanvas:function(n){var t=100,r=$(n.target),i=r.prop("tagName").toLowerCase();i=="move-right"&&(this.scrollLeft+=t,this.canvasWidth+this.scrollLeft>=this.drawingWidth&&(this.drawingWidth+=t));i=="move-left"&&(this.scrollLeft-=t);i=="move-top"&&(this.scrollTop-=t);i=="move-bottom"&&(this.scrollTop+=t,this.canvasHeight+this.scrollTop>=this.drawingHeight&&(this.drawingHeight+=t));this.scrollTop<0&&(this.scrollTop=0);this.scrollLeft<0&&(this.scrollLeft=0);this.drawing.width(this.drawingWidth);this.drawing.height(this.drawingHeight);this.canvas.scrollLeft(this.scrollLeft);this.canvas.scrollTop(this.scrollTop);this.model.setCanvasBounds({top:this.scrollTop,left:this.scrollLeft,width:this.drawingWidth,height:this.drawingHeight})},onTaskDragging:function(n,t){this.redrawConnector(t.helper.attr("id"),t.position);this.aura.moveTo(t.helper);this.onElementDragging(n,t)},onArrowDragging:function(n,t){var i=this.drawing,r=this.fixPosition(t.target),u;this.connector.drawTemporalConnector(i,i.find("#"+t.source),r);u=this.getTasksAtPosition(r);i.find("item").removeClass("dragging-arrow");u.addClass("dragging-arrow")},onElementDragging:function(){},redrawConnector:function(n){var i=this,r=this.model.getTaskById(n),t=this.drawing;$.each(r.predecessors,function(r,u){u&&i.connector.refresh(t,t.find("#"+u),t.find("#"+n))});$.each(r.successors,function(r,u){u&&i.connector.refresh(t,t.find("#"+n),t.find("#"+u))})},addConnectors:function(n){var t=this;$.each(n.tasks,function(n,i){$.each(i.successors,function(n,r){t.addConnector(i.id,r)})})},addConnector:function(n,t){var i=this.model.getConnectionRule(n,t);this.connector.connect(this.drawing,this.drawing.find("#"+n),this.drawing.find("#"+t),i)},showAura:function(n){var t=$(n.currentTarget),i=this.aura.showForTask(t);this.model.setAura(t.id,i);this.drawing.find("*").removeClass("active");i&&t.addClass("active")},showAuraForArrow:function(n){var t=$(n.currentTarget),i=t.attr("id"),r=bizagi.bpmn.modeler.connector.getSourceTaskFromId(i),u=this.model.successorConnectionsCanContainRule(r),f=this.aura.showForArrow(t,u);this.drawing.find("*").removeClass("active");f&&t.addClass("active")},getTasksAtPosition:function(n){return this.drawing.find("item").filter(function(){var i=$(this),r=i.position(),t={x:r.left,y:r.top,w:i.width(),h:i.height()};return t.x<=n.left&&n.left<=t.x+t.w&&t.y<=n.top&&n.top<=t.y+t.h})},showPopupEditor:function(n,t,i){n.hide();n.after(t);t.focus();t.select();var r=function(){var r=t.val();i(r);n.show();t.detach()};t.keypress(function(n){n.key=="Enter"&&r()});t.click(function(n){return n.preventDefault(),!1});this.drawing.one("click",r)},fixPosition:function(n){var t=this.drawing.offset();return n.left-=t.left,n.top-=t.top,n},setNameTask:function(n,t){if(n.length>20||t.height()>34)return!0}});
bizagi.bpmn.modeler.observable.extend("bizagi.bpmn.modeler.toolbar",{bpmShapes:{StartEvent:"bpmn-icon-start-event-none",IntermediateEvent:"bpmn-icon-intermediate-event-none",EndEvent:"bpmn-icon-end-event-none",TerminateEvent:"bpmn-icon-end-event-terminate",ExclusiveGateway:"bpmn-icon-gateway-xor",ParallelGateway:"bpmn-icon-gateway-parallel",InclusiveGateway:"bpmn-icon-gateway-or",ComplexGateway:"bpmn-icon-gateway-complex",UserTask:"bpmn-icon-task"},getClassForType:function(n){return this.bpmShapes[n]}},{init:function(){$.views.converters("tasktype_class",function(n){return bizagi.bpmn.modeler.toolbar.getClassForType(n)});$.templates({bpm_modeler_toolbar:'<toolbar> {{for items tmpl="bpm_modeler_toolbarItem"/}}<\/toolbar>',bpm_modeler_toolbarItem:'<item class="bpm-{{:#data}} {{tasktype_class: #data}}  bpm-cloneable" data-type="{{:#data}}"><\/item>'});this.items=["StartEvent","IntermediateEvent","EndEvent","ExclusiveGateway","UserTask"]},render:function(n){var i=this,t;this.canvas=n;t=$.templates.bpm_modeler_toolbar.render({items:this.items});this.canvas.append(t);n.find("item").draggable({helper:"clone",containment:"#bpm-drawing",grid:[20,20],drag:$.proxy(this.onItemDragging,this)})},onItemDragging:function(n,t){this.publish("item.dragging",t)}});
bizagi.bpmn.modeler.observable.extend("bizagi.bpmn.modeler.viewer",{},{init:function(n){$.templates({bpm_modeler_viewer_container:'<bpm-modeler>                             <div id="bpm-toolbar"><\/div>                             <div id="bpm-drawing"><\/div>                             <move-helper>                                 <move-top class="bpm-move"><\/move-top>                                 <move-left class="bpm-move"><\/move-left>                                 <move-bottom class="bpm-move"><\/move-bottom>                                 <move-right class="bpm-move"><\/move-right>                             <\/move-helper>                         <\/bpm-modeler>'});this.model=new bizagi.bpmn.modeler.model;this.model.subscribe("model.change",$.proxy(this.changed,this));n&&n.model&&this.model.setModel(n.model);this.drawing=new bizagi.bpmn.modeler.drawing(this.model);this.drawing.subscribe("drawing.externaloption",$.proxy(this.manageExternalOption,this));this.toolbar=new bizagi.bpmn.modeler.toolbar;this.toolbar.subscribe("item.dragging",$.proxy(this.onToolbarItemDragging,this));this.model.isReadOnly=typeof n=="undefined"?!1:n.isReadOnly},render:function(n){this.canvas=n;this.isReadOnly=this.validateIsReadOnly(this.model);var t=$.templates.bpm_modeler_viewer_container.render();this.canvas.html(t);this.isReadOnly?this.renderDrawing(this.isReadOnly):(this.renderToolbar(),this.renderDrawing(this.isReadOnly));this.canvas.on("click",".bpm-move",$.proxy(this.moveCanvas,this))},validateIsReadOnly:function(n){if(n.isReadOnly)return!0},renderToolbar:function(){var n=this.canvas.find("#bpm-toolbar");this.toolbar.render(n)},renderDrawing:function(n){var t=this.canvas.find("#bpm-drawing");this.drawing.render(t,n)},moveCanvas:function(n,t){this.drawing.moveCanvas(n,t)},onToolbarItemDragging:function(n,t){this.drawing.onElementDragging(n,t)},manageExternalOption:function(n,t){this.publish("bpm.modeler.externalOption",t)},setConnectionExpression:function(n,t){this.drawing.setExpressionForArrow(n,t)},save:function(){return this.model.getPersistenceModel()},load:function(n){this.model.setModel(n)},changed:function(){this.publish("bpm.modeler.changed")},setExtendedProperty:function(n,t,i){this.model.setExtendedProperty(n,t,i)},getExtendedProperty:function(n,t){return this.model.getExtendedProperty(n,t)}});Array.prototype.removeOne||(Array.prototype.removeOne=function(n){for(var t=this.length;t--;)if(this[t]===n){this.splice(t,1);return}});Array.prototype.removeAll||(Array.prototype.removeAll=function(n){for(var t=this.length;t--;)this[t]===n&&this.splice(t,1)});
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.processmodeler",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.loadTemplates({processModelerWrapper:bizagi.getTemplate("bizagi.workportal.desktop.widgets.processModeler").concat("#ui-bizagi-workportal-widget-processmodelerview-wrapper"),useNewEngine:!1})},renderContent:function(){var n=this,t=n.getTemplate("processModelerWrapper");return n.content=$.tmpl(t,{}),n.content},postRender:function(){var n=this;n.$processModelerCanvas=$("#canvas",n.content);n.modeler=new bizagi.bpmn.modeler.viewer;n.modeler.render(n.$processModelerCanvas)}});
