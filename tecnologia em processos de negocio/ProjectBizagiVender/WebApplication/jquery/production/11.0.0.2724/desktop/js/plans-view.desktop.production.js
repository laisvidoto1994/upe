bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.manager",{},{usersMap:{},init:function(n,t,i,r,u,f,e,o){var s=this;s._super(n,t,o);s.serviceOrderActivitiesByTransitions=e;s.plans={};s.editDialogBox={};s.allIdUsers=[];s.notifier=r;s.planTemplateCreate=u;s.planPopupEdit=f;s.loadTemplates({"plans.manager.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-wrapper"),"plans.manager.empty":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-empty-message"),"plans.manager.users":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-users"),"plans.manager.activities.tooltip":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-activities-tooltip"),"plans.manager.context.menu.content":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-context-menu-content"),"plans.manager.users.tooltip":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-users-tooltip")})},renderContent:function(){var n=this;return n.content=$("<div/>"),n.content},postRender:function(){var n=this;n.getCalculatedDateServer();n.sub("PLANS-VIEW",$.proxy(n.updateView,n));n.planTemplateCreate.sub("planTemplateCreatedSuccess",function(){n.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))});n.planTemplateCreate.sub("planTemplateCreatedFailed",function(){n.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))});n.planPopupEdit.sub("planEditedSuccess",function(){var t={histName:n.params.histName,planState:n.params.planState,level:1};n.pub("notify",{type:"PLANS-VIEW",args:$.extend(n.params,t)});n.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))});n.planPopupEdit.sub("planEditedFailed",function(){n.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))})},configureHandlers:function(){var n=this,t=n.getContent();$(".wdg-plans-manager-card",t).on("click",$.proxy(n.onClickPlan,n));$(".wdg-plans-manager-card .btn-workonit",t).on("click",function(t){t.stopPropagation();var i=$(t.target),r=i.closest(".wdg-plans-manager-card"),u=r.data("plan-id");n.plans[u].activities.forEach(function(t){n.runningActivity(t)&&n.goToWorkOnIt(t.idCase,t.idWorkItem)})})},onClickPlan:function(n){var i=this,t=$(n.target).closest(".wdg-plans-manager-card"),r=t.data("plan-id"),u=t.data("plan-name"),f={name:u,id:r};i.showPlanDashBoard(f)},showPlanDashBoard:function(n){var t=this,i=new bizagi.workportal.services.behaviors.projectDashboard(t.dataService);t.params.showContextByMenuDashboard="PLANACTIVITIES";t.params.menuPlanDashboard={};t.params.menuPlanDashboard.showCommentsOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonComments;t.params.menuPlanDashboard.showFilesOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonFiles;t.params.menuPlanDashboard.showTimeLineOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonTimeLine;n=t.plans[n.id];n.name.length>28&&(n.name=n.name.substring(0,29)+"...");n.contextualized&&delete t.params.flowContext;$.when(i.getRadNumberForPlanDashboard(n.id,n.contextualized)).done(function(i){t.params.radNumber=i;var r={plan:n,level:2,histName:n.name};t.pub("notify",{type:t.params.showContextByMenuDashboard,args:$.extend(t.params,r)})})},deletePlan:function(n){var t=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done(function(){var i={id:n.id};$.when(t.dataService.deletePlan(i)).always(function(n){if(n.status===200||typeof n.status=="undefined"){$.extend(t.params.plan,i);var r={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,r)});t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""))}else t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))})})},executePlan:function(n){var t=this,r=n.activitiesLength,i;r>0?(i={idPlan:n.id},$.when(t.dataService.putExecutePlan(i)).done(function(){var i=t.plans[n.id];i&&(i.currentState="EXECUTING",i=$.extend(i,{startDate:t.getDateServer()}),$.when(t.dataService.updatePlan(i)).done(function(){var n={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,n)});t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-state-change-running"),""))}))})):t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-action-execute-message-activities-required"),""))},closePlan:function(n){var t=this,i=t.plans[n.id];i&&(i.currentState="CLOSED",$.when(t.dataService.closePlan({idPlan:n.id})).done(function(){$.when(t.dataService.updatePlan(i)).done(function(){var n={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,n)});t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-success"),""))})}).fail(function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-fail"),""))}))},openPopupEditTemplate:function(){var n=this,t=n.plans[n.selectedPlan.id]||{};n.planPopupEdit.showPopup(n.params,n.dataService,t)},openPopupSaveTemplate:function(){var n=this,t=n.plans[n.selectedPlan.id]||{};n.planTemplateCreate.showPopupAddTemplatePlan(n.params,n.dataService,t.contextualized,t.id)},updateView:function(n,t){var i=this,r;i.params=t.args;i.getContent().empty();r=i.getTemplate("plans.manager.wrapper");$.when(i.getData()).done(function(n){n.length>0?(i.content.empty(),i.arrayPlans=i.processData(n),i.content.append(r.render({plans:i.arrayPlans})),$(".wdg-plans-row-dial",i.content).knob(),i.updatePlanDetails(),i.configureHandlers(),i.configureContextMenu(),$("#ui-bizagi-wp-project-homeportal-main").addClass("disabled-right-sidebar").removeClass("enabled-right-sidebar")):(i.content.empty(),i.content.append(i.getTemplate("plans.manager.empty").render()))})},orderActivitiesByTransitions:function(n,t){var i=this;return i.serviceOrderActivitiesByTransitions.getActivitiesByTransitions(n,t)},processData:function(n){for(var i,r,u=this,f=n.length,t=0;t<f;t+=1)u.plans[n[t].id]=n[t],i=n[t].startDate||n[t].creationDate,r=n[t].dueDate,i&&(i=new Date(i),n[t].fromDate=bizagi.util.dateFormatter.getRelativeTime(i,null,!1)),r&&(r=new Date(r),n[t].toDate=bizagi.util.dateFormatter.getRelativeTime(r,null,!1)),n[t].value=0,n[t].completedActivities=0,n[t].activitiesLength=0,n[t].dueDate&&(n[t].dueDateFormat=u.getFormattedDate(new Date(n[t].dueDate))),n[t].locatedState=bizagi.localization.getResource("workportal-project-plan-state-"+n[t].currentState.toLowerCase());return n},updatePlanDetails:function(){for(var i,n=this,u=[],r=[],t=0;t<n.arrayPlans.length;t+=1)u.push(n.arrayPlans[t].idUserCreator),i=n.getMetaData(n.arrayPlans[t].id),$.when(i,n.arrayPlans[t].id).done(function(t,i){n.plans[i].activities=t;n.paintPlanDetails(t,i);n.configureActivitiesTooltip(t,i)}),r.push(i);$.when.apply($,r).then(function(){$.equalizeHeights(".wdg-plans-manager-card");n.getUsers(n.allIdUsers)})},paintPlanDetails:function(n,t){var i=this,h=n.length,p=0,o=0,a=[],f=[],v=[],b=i.getTemplate("plans.manager.users"),s,u,r,y,e,c,l,w;if(i.plans[t].users={},s=i.plans[t].startDate||i.plans[t].creationDate,u=$('[data-plan-id="'+i.plans[t].id+'"]',i.content),h>0){for(r=0;r<h;r+=1)y=n[r].finishDate||n[r].startDate,s=s<y?y:s,n[r].workItemState==="Completed"&&(p+=1,n[r].progress=100),i.runningActivity(n[r])&&(a.push(n[r].name),n[r].progress=0),f.indexOf(n[r].userAssigned)<0?(i.plans[t].users[n[r].userAssigned]=[n[r]],f.push(n[r].userAssigned)):i.plans[t].users[n[r].userAssigned].push(n[r]),i.allIdUsers.indexOf(n[r].userAssigned)<0&&i.allIdUsers.push(n[r].userAssigned),o+=n[r].progress;for(e=0;e<f.length;e+=1)i.usersMap[f[e]]?v.push(i.usersMap[f[e]]):v.push({userAssigned:f[e],picture:""});o=Math.round(o/h);u.find(".wdg-plans-row-completed").html(p);u.find(".wdg-plans-row-activities-length").html(h);u.find(".wdg-plans-row-dial").val(o).trigger("change");u.find(".wdg-plans-users").html(b.render({users:v}));i.getVisibleButtonWorkonit(i.plans[t],o,a)?(u.find(".wdg-plans-row-activities").html(a.join(",")),u.find(".wdg-plans-workonit-row").show()):(u.find(".wdg-plans-activities-row").hide(),u.find(".wdg-plans-workonit-row").hide())}i.plans[t].currentState==="PENDING"?(c=bizagi.localization.getResource("workportal-general-properties-last-update"),l=i.plans[t].creationDate):i.plans[t].currentState==="EXECUTING"?(c=bizagi.localization.getResource("workportal-general-properties-start-date"),l=i.plans[t].startDate):i.plans[t].currentState==="CLOSED"&&(c=bizagi.localization.getResource("workportal-general-properties-closed-date"),l=s);w=i.getFormattedDate(new Date(l));u.find(".first-date-plan").html(c+": "+w)},getResource:function(n){return bizagi.localization.getResource(n)},getFormattedDate:function(n){var i=this,r=i.getResource("dateFormat"),u=bizagi.util.dateFormatter.formatInvariant(n,!1),t=$("<span class='formatDate'>"+u+"<\/span>");return bizagi.util.formatInvariantDate(t,r),t.text()},getVisibleButtonWorkonit:function(n,t,i){var r=!1;return n.currentState==="EXECUTING"&&t<100&&i.length>0&&(r=!0),r},goToWorkOnIt:function(n,t){var i=this;i.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:n,idWorkItem:t})},configureActivitiesTooltip:function(n,t){var i=this,r=i.getTemplate("plans.manager.activities.tooltip"),u=$('[data-plan-id="'+t+'"]',i.content);u.find(".wdg-plans-activities-row").tooltip({content:function(){var t=$();return n.forEach(function(n){var u,f;i.runningActivity(n)&&(u=n.estimatedFinishDate?new Date(n.estimatedFinishDate):null,i.usersMap[n.userAssigned]&&(n.userName=i.usersMap[n.userAssigned].name,n.userPicture=i.usersMap[n.userAssigned].picture,n.formatedEstimatedFinishDate=u?bizagi.util.dateFormatter.formatDate(u,bizagi.localization.getResource("dateFormat")):null),f=r.render({activity:n}),t.push.apply(t,f))}),t}})},runningActivity:function(n){return n.workItemState==="Active"||n.workItemState==="Inactive"},configureUserTooltip:function(){var n=this,t=n.getContent(),i=n.getTemplate("plans.manager.users.tooltip");$(".wdg-plans-users li",t).not(".icon-more").tooltip({content:function(){var t=$(this).data("iduser"),u=$(this).closest(".wdg-plans-manager-card").data("plan-id"),f=$(this).clone(!1),e=n.plans[u].users[t],o={userName:n.usersMap[t].name,activities:e},r=i.render(o);return $(".wdg-plans-tooltip-user-avatar",r).html($("<ul>").append(f)),r}})},getUsers:function(n){for(var f,r,t=this,u=[],e=n.length,i=0;i<e;i+=1)t.usersMap[n[i]]||u.push(n[i]);if(u.length>0)f={userIds:n.join(),width:32,height:32},$.when(t.dataService.getUsersData(f)).done(function(n){for(var r=n.length,i=0;i<r;i+=1)t.usersMap[n[i].id]={picture:n[i].picture?"data:image/png;base64,"+n[i].picture:"",name:n[i].name||"",userAssigned:n[i].id},t.configureAvatar(n[i].id);t.configureUserTooltip()});else{for(r=0;r<n.length;r+=1)t.configureAvatar(n[r]);t.configureUserTooltip()}},configureAvatar:function(n){var t=this,i=$('[data-iduser="'+n+'"]',t.content);t.usersMap[n].picture?i.find(".bz-wp-avatar-img").attr("src",t.usersMap[n].picture):(i.find(".bz-wp-avatar-img").hide(),i.find(".wdg-plans-row-user-label").html(t.usersMap[n].name.getInitials()).show())},configureContextMenu:function(){var n=this,t=n.getContent(),i=n.getTemplate("plans.manager.context.menu.content");$(".wdg-plans-leftmenu",t).on("click",function(r){var u;r.stopPropagation();var o=$(r.target),f=o.closest(".wdg-plans-manager-card"),h=f.data("plan-id"),c=f.data("plan-name"),l=f.data("plan-current-state"),e=parseInt(f.find(".wdg-plans-row-activities-length").html(),0),s=parseInt(f.find(".wdg-plans-row-completed").html(),0),a=isNaN(e)||isNaN(s)?0:e-s;n.selectedPlan={id:h,name:c,activitiesLength:isNaN(e)?0:e,completed:a<=0};u=i.render({currentState:l,completed:n.selectedPlan.completed});$(".plans-manager-context-menu-wrapper",t).append(u);u.menu();n.configureMenuHandlers(u);u.position({my:"left top",at:"left bottom",of:o,collision:"fit"});u.show();$(document).one("click",function(){u.remove()});$(".wdg-plans-manager-card").one("click",function(){u.remove()});$(".wdg-plans-leftmenu").one("click",function(){u.remove()})})},configureMenuHandlers:function(n){var t=this;$("#edit",n).on("click",function(n){n.stopPropagation();t.openPopupEditTemplate(t.selectedPlan)});$("#save",n).on("click",function(n){n.stopPropagation();t.openPopupSaveTemplate(t.selectedPlan)});$("#enable",n).on("click",function(n){n.stopPropagation();t.executePlan(t.selectedPlan)});$("#delete",n).on("click",function(n){n.stopPropagation();t.deletePlan(t.selectedPlan)});$("#close",n).on("click",function(n){n.stopPropagation();t.closePlan(t.selectedPlan)})},getMetaData:function(n){var t=this,i=$.Deferred(),r={idPlan:n},u={idPlan:n},f={idPlan:n};return $.when(t.dataService.getActivities(r),t.dataService.getWorkitemsPlan(u),t.dataService.getTransitionsByPlan(f)).done(function(n,r,u){var f=n||[];f=t.orderActivitiesByTransitions(n,u);t.mergePropertiesActivitiesWithWorkitems(f,r);i.resolve(f)}),i.promise()},getCalculatedDateServer:function(){var n=this;return $.when(n.dataService.getCurrentTimeDateServer()).done(function(t){n.differenceMillisecondsServer=bizagi.util.dateFormatter.getDifferenceBetweenDates(new Date,new Date(t.date),"milliseconds")})},getDateServer:function(){var n=new Date;return n.getTime()+this.differenceMillisecondsServer},getData:function(){var n=this,t={};return n.params.planState!=="all"&&(t.currentState=n.params.planState),n.dataService.getUserPlans(t)},getEmptyDataMessage:function(){var n=this;return n.getTemplate("plans.manager.empty")},mergePropertiesActivitiesWithWorkitems:function(n,t){n.forEach(function(n){var i=t.filter(function(t){return t.guidActivity==n.id});i.length>0&&$.extend(n,{startDate:i[0].wiEntryDate||null,finishDate:i[0].wiSolutionDate||null,idWorkItem:i[0].idWorkItem,workItemState:i[0].workItemState,idCase:i[0].idCase,estimatedFinishDate:i[0].wiEstimatedSolutionDate||n.estimatedFinishDate})})},clean:function(){var n=this;n.params={};n.unsub("PLANS-VIEW",$.proxy(n.updateView,n));n.planTemplateCreate.unsub("planTemplateCreatedSuccess");n.planTemplateCreate.unsub("planTemplateCreatedFailed");n.planPopupEdit.unsub("planEditedSuccess");n.planPopupEdit.unsub("planEditedFailed")}});bizagi.injector.register("bizagi.workportal.widgets.plans.manager",["workportalFacade","dataService","actionService","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit","bizagi.workportal.services.behaviors.orderActivitiesByTransitions",bizagi.workportal.widgets.plans.manager]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.topmenu",{},{init:function(n,t,i,r){var u=this;u.params=r;u._super(n,t,r);u.planCreate=i;u.loadTemplates({"plans.topmenu.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.topmenu").concat("#plans-topmenu-wrapper")})},renderContent:function(){var n=this,t=n.getTemplate("plans.topmenu.wrapper");return n.content=t.render({}),n.content},postRender:function(){var n=this;n.configureHandlers()},configureHandlers:function(){var n=this,t=n.getContent();$(".wdg-topmenu-add",t).on("click",$.proxy(n.onClickAddPlan,n))},onClickAddPlan:function(){var n=this;n.planCreate.showPopupAddPlan(n.params,n.dataService,!1);n.planCreate.unsub("planCreated");n.planCreate.sub("planCreated",function(t,i){var r=i.paramsNewPlan,u=r.name;r.name.length>28&&(u=r.name.substring(0,29)+"...");n.params.radNumber=i.radNumber;n.params.showContextByMenuDashboard="PLANACTIVITIES";n.pub("notify",{type:"PLANACTIVITIES",args:$.extend(n.params,{plan:i.paramsNewPlan,level:2,histName:u})})})}});bizagi.injector.register("bizagi.workportal.widgets.plans.topmenu",["workportalFacade","dataService","bizagi.workportal.widgets.project.plan.create",bizagi.workportal.widgets.plans.topmenu]);
(function(n){"use strict";var t={},i=Math.max,r=Math.min;t.c={};t.c.d=n(document);t.c.t=function(n){return n.originalEvent.touches.length-1};t.o=function(){var i=this;this.o=null;this.$=null;this.i=null;this.g=null;this.v=null;this.cv=null;this.x=0;this.y=0;this.w=0;this.h=0;this.$c=null;this.c=null;this.t=0;this.isInit=!1;this.fgColor=null;this.pColor=null;this.dH=null;this.cH=null;this.eH=null;this.rH=null;this.scale=1;this.relative=!1;this.relativeWidth=!1;this.relativeHeight=!1;this.$div=null;this.run=function(){var t=function(n,t){for(var r in t)i.o[r]=t[r];i._carve().init();i._configure()._draw()};if(!this.$.data("kontroled")){if(this.$.data("kontroled",!0),this.extend(),this.o=n.extend({min:this.$.data("min")!==undefined?this.$.data("min"):0,max:this.$.data("max")!==undefined?this.$.data("max"):100,stopper:!0,readOnly:this.$.data("readonly")||this.$.attr("readonly")==="readonly",cursor:this.$.data("cursor")===!0&&30||this.$.data("cursor")||0,thickness:this.$.data("thickness")&&Math.max(Math.min(this.$.data("thickness"),1),.01)||.35,lineCap:this.$.data("linecap")||"butt",width:this.$.data("width")||200,height:this.$.data("height")||200,displayInput:this.$.data("displayinput")==null||this.$.data("displayinput"),displayPrevious:this.$.data("displayprevious"),fgColor:this.$.data("fgcolor")||"#87CEEB",inputColor:this.$.data("inputcolor"),font:this.$.data("font")||"Arial",fontWeight:this.$.data("font-weight")||"bold",inline:!1,step:this.$.data("step")||1,rotation:this.$.data("rotation"),draw:null,change:null,cancel:null,release:null,format:function(n){return n},parse:function(n){return parseFloat(n)}},this.o),this.o.flip=this.o.rotation==="anticlockwise"||this.o.rotation==="acw",this.o.inputColor||(this.o.inputColor=this.o.fgColor),this.$.is("fieldset")?(this.v={},this.i=this.$.find("input"),this.i.each(function(t){var r=n(this);i.i[t]=r;i.v[t]=i.o.parse(r.val());r.bind("change blur",function(){var n={};n[t]=r.val();i.val(i._validate(n))})}),this.$.find("legend").remove()):(this.i=this.$,this.v=this.o.parse(this.$.val()),this.v===""&&(this.v=this.o.min),this.$.bind("change blur",function(){i.val(i._validate(i.o.parse(i.$.val())))})),this.o.displayInput||this.$.hide(),this.$c=n(document.createElement("canvas")).attr({width:this.o.width,height:this.o.height}),this.$div=n('<div style="'+(this.o.inline?"display:inline;":"")+"width:"+this.o.width+"px;height:"+this.o.height+'px;"><\/div>'),this.$.wrap(this.$div).before(this.$c),this.$div=this.$.parent(),typeof G_vmlCanvasManager!="undefined"&&G_vmlCanvasManager.initElement(this.$c[0]),this.c=this.$c[0].getContext?this.$c[0].getContext("2d"):null,!this.c)throw{name:"CanvasNotSupportedException",message:"Canvas not supported. Please use excanvas on IE8.0.",toString:function(){return this.name+": "+this.message}};return this.scale=(window.devicePixelRatio||1)/(this.c.webkitBackingStorePixelRatio||this.c.mozBackingStorePixelRatio||this.c.msBackingStorePixelRatio||this.c.oBackingStorePixelRatio||this.c.backingStorePixelRatio||1),this.relativeWidth=this.o.width%1!=0&&this.o.width.indexOf("%"),this.relativeHeight=this.o.height%1!=0&&this.o.height.indexOf("%"),this.relative=this.relativeWidth||this.relativeHeight,this._carve(),this.v instanceof Object?(this.cv={},this.copy(this.v,this.cv)):this.cv=this.v,this.$.bind("configure",t).parent().bind("configure",t),this._listen()._configure()._xy().init(),this.isInit=!0,this.$.val(this.o.format(this.v)),this._draw(),this}};this._carve=function(){if(this.relative){var n=this.relativeWidth?this.$div.parent().width()*parseInt(this.o.width)/100:this.$div.parent().width(),t=this.relativeHeight?this.$div.parent().height()*parseInt(this.o.height)/100:this.$div.parent().height();this.w=this.h=Math.min(n,t)}else this.w=this.o.width,this.h=this.o.height;return this.$div.css({width:this.w+"px",height:this.h+"px"}),this.$c.attr({width:this.w,height:this.h}),this.scale!==1&&(this.$c[0].width=this.$c[0].width*this.scale,this.$c[0].height=this.$c[0].height*this.scale,this.$c.width(this.w),this.$c.height(this.h)),this};this._draw=function(){var n=!0;i.g=i.c;i.clear();i.dH&&(n=i.dH());n!==!1&&i.draw()};this._touch=function(n){var r=function(n){var t=i.xy2val(n.originalEvent.touches[i.t].pageX,n.originalEvent.touches[i.t].pageY);t!=i.cv&&(i.cH&&i.cH(t)===!1||(i.change(i._validate(t)),i._draw()))};return this.t=t.c.t(n),r(n),t.c.d.bind("touchmove.k",r).bind("touchend.k",function(){t.c.d.unbind("touchmove.k touchend.k");i.val(i.cv)}),this};this._mouse=function(n){var r=function(n){var t=i.xy2val(n.pageX,n.pageY);t!=i.cv&&(i.cH&&i.cH(t)===!1||(i.change(i._validate(t)),i._draw()))};return r(n),t.c.d.bind("mousemove.k",r).bind("keyup.k",function(n){if(n.keyCode===27){if(t.c.d.unbind("mouseup.k mousemove.k keyup.k"),i.eH&&i.eH()===!1)return;i.cancel()}}).bind("mouseup.k",function(){t.c.d.unbind("mousemove.k mouseup.k keyup.k");i.val(i.cv)}),this};this._xy=function(){var n=this.$c.offset();return this.x=n.left,this.y=n.top,this};this._listen=function(){return this.o.readOnly?this.$.attr("readonly","readonly"):(this.$c.bind("mousedown",function(n){n.preventDefault();i._xy()._mouse(n)}).bind("touchstart",function(n){n.preventDefault();i._xy()._touch(n)}),this.listen()),this.relative&&n(window).resize(function(){i._carve().init();i._draw()}),this};this._configure=function(){return this.o.draw&&(this.dH=this.o.draw),this.o.change&&(this.cH=this.o.change),this.o.cancel&&(this.eH=this.o.cancel),this.o.release&&(this.rH=this.o.release),this.o.displayPrevious?(this.pColor=this.h2rgba(this.o.fgColor,"0.4"),this.fgColor=this.h2rgba(this.o.fgColor,"0.6")):this.fgColor=this.o.fgColor,this};this._clear=function(){this.$c[0].width=this.$c[0].width};this._validate=function(n){var t=~~((n<0?-.5:.5)+n/this.o.step)*this.o.step;return Math.round(t*100)/100};this.listen=function(){};this.extend=function(){};this.init=function(){};this.change=function(){};this.val=function(){};this.xy2val=function(){};this.draw=function(){};this.clear=function(){this._clear()};this.h2rgba=function(n,t){var i;return n=n.substring(1,7),i=[parseInt(n.substring(0,2),16),parseInt(n.substring(2,4),16),parseInt(n.substring(4,6),16)],"rgba("+i[0]+","+i[1]+","+i[2]+","+t+")"};this.copy=function(n,t){for(var i in n)t[i]=n[i]}};t.Dial=function(){t.o.call(this);this.startAngle=null;this.xy=null;this.radius=null;this.lineWidth=null;this.cursorExt=null;this.w2=null;this.PI2=2*Math.PI;this.extend=function(){this.o=n.extend({bgColor:this.$.data("bgcolor")||"#EEEEEE",angleOffset:this.$.data("angleoffset")||0,angleArc:this.$.data("anglearc")||360,inline:!0},this.o)};this.val=function(n,t){if(null!=n){if(n=this.o.parse(n),t!==!1&&n!=this.v&&this.rH&&this.rH(n)===!1)return;this.cv=this.o.stopper?i(r(n,this.o.max),this.o.min):n;this.v=this.cv;this.$.val(this.o.format(this.v));this._draw()}else return this.v};this.xy2val=function(n,t){var u,f;return u=Math.atan2(n-(this.x+this.w2),-(t-this.y-this.w2))-this.angleOffset,this.o.flip&&(u=this.angleArc-u-this.PI2),this.angleArc!=this.PI2&&u<0&&u>-.5?u=0:u<0&&(u+=this.PI2),f=u*(this.o.max-this.o.min)/this.angleArc+this.o.min,this.o.stopper&&(f=i(r(f,this.o.max),this.o.min)),f};this.listen=function(){var t=this,u,e,h=function(n){n.preventDefault();var o=n.originalEvent,s=o.detail||o.wheelDeltaX,h=o.detail||o.wheelDeltaY,f=t._validate(t.o.parse(t.$.val()))+(s>0||h>0?t.o.step:s<0||h<0?-t.o.step:0);f=i(r(f,t.o.max),t.o.min);t.val(f,!1);t.rH&&(clearTimeout(u),u=setTimeout(function(){t.rH(f);u=null},100),e||(e=setTimeout(function(){u&&t.rH(f);e=null},200)))},o,f,s=1,c={37:-t.o.step,38:t.o.step,39:t.o.step,40:-t.o.step};this.$.bind("keydown",function(u){var e=u.keyCode,h;e>=96&&e<=105&&(e=u.keyCode=e-48);o=parseInt(String.fromCharCode(e));isNaN(o)&&(e!==13&&e!==8&&e!==9&&e!==189&&(e!==190||t.$.val().match(/\./))&&u.preventDefault(),n.inArray(e,[37,38,39,40])>-1&&(u.preventDefault(),h=t.o.parse(t.$.val())+c[e]*s,t.o.stopper&&(h=i(r(h,t.o.max),t.o.min)),t.change(t._validate(h)),t._draw(),f=window.setTimeout(function(){s*=2},30)))}).bind("keyup",function(){isNaN(o)?f&&(window.clearTimeout(f),f=null,s=1,t.val(t.$.val())):t.$.val()>t.o.max&&t.$.val(t.o.max)||t.$.val()<t.o.min&&t.$.val(t.o.min)});this.$c.bind("mousewheel DOMMouseScroll",h);this.$.bind("mousewheel DOMMouseScroll",h)};this.init=function(){(this.v<this.o.min||this.v>this.o.max)&&(this.v=this.o.min);this.$.val(this.v);this.w2=this.w/2;this.cursorExt=this.o.cursor/100;this.xy=this.w2*this.scale;this.lineWidth=this.xy*this.o.thickness;this.lineCap=this.o.lineCap;this.radius=this.xy-this.lineWidth/2;this.o.angleOffset&&(this.o.angleOffset=isNaN(this.o.angleOffset)?0:this.o.angleOffset);this.o.angleArc&&(this.o.angleArc=isNaN(this.o.angleArc)?this.PI2:this.o.angleArc);this.angleOffset=this.o.angleOffset*Math.PI/180;this.angleArc=this.o.angleArc*Math.PI/180;this.startAngle=1.5*Math.PI+this.angleOffset;this.endAngle=1.5*Math.PI+this.angleOffset+this.angleArc;var n=i(String(Math.abs(this.o.max)).length,String(Math.abs(this.o.min)).length,2)+2;this.o.displayInput&&this.i.css({width:(this.w/2+4>>0)+"px",height:(this.w/3>>0)+"px",position:"absolute","vertical-align":"middle","margin-top":(this.w/3>>0)+"px","margin-left":"-"+(this.w*3/4+2>>0)+"px",border:0,background:"none",font:this.o.fontWeight+" "+(this.w/n>>0)+"px "+this.o.font,"text-align":"center",color:this.o.inputColor||this.o.fgColor,padding:"0px","-webkit-appearance":"none"})||this.i.css({width:"0px",visibility:"hidden"})};this.change=function(n){this.cv=n;this.$.val(this.o.format(n))};this.angle=function(n){return(n-this.o.min)*this.angleArc/(this.o.max-this.o.min)};this.arc=function(n){var t,i;return n=this.angle(n),this.o.flip?(t=this.endAngle+1e-5,i=t-n-1e-5):(t=this.startAngle-1e-5,i=t+n+1e-5),this.o.cursor&&(t=i-this.cursorExt)&&(i=i+this.cursorExt),{s:t,e:i,d:this.o.flip&&!this.o.cursor}};this.draw=function(){var n=this.g,i=this.arc(this.cv),t,r=1;n.lineWidth=this.lineWidth;n.lineCap=this.lineCap;this.o.bgColor!=="none"&&(n.beginPath(),n.strokeStyle=this.o.bgColor,n.arc(this.xy,this.xy,this.radius,this.endAngle-1e-5,this.startAngle+1e-5,!0),n.stroke());this.o.displayPrevious&&(t=this.arc(this.v),n.beginPath(),n.strokeStyle=this.pColor,n.arc(this.xy,this.xy,this.radius,t.s,t.e,t.d),n.stroke(),r=this.cv==this.v);n.beginPath();n.strokeStyle=r?this.o.fgColor:this.fgColor;n.arc(this.xy,this.xy,this.radius,i.s,i.e,i.d);n.stroke()};this.cancel=function(){this.val(this.v)}};n.fn.dial=n.fn.knob=function(i){return this.each(function(){var r=new t.Dial;r.o=i;r.$=n(this);r.run()}).parent()}})($);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.filters",{},{init:function(n,t,i){var r=this;r.params=i;r._super(n,t,i);r.plansLinks=bizagi.injector.get("bizagi.workportal.widgets.decontextualized.plans",i);r.loadTemplates({"plans.filters.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.filters").concat("#plans-filter-wrapper")})},renderContent:function(){var n=this,t,i={},r;return r=n.getTemplate("plans.filters.wrapper"),t=n.getData(),i.items=t.items,n.content=r.render(i),n.content},postRender:function(){var n=this;n.configureHandlers()},setSelectedFilter:function(n){$(n).addClass("wdg-ftr-selected").siblings().removeClass("wdg-ftr-selected")},onLoadPlansView:function(n,t){var i=this;i.setSelectedFilter($(".wdg-plan-filter-card[data-data='"+t.args.planState+"']",i.content))},configureHandlers:function(){var n=this,t=n.getContent();$(".wdg-plan-filter-card",t).on("click",$.proxy(n.onClickFilter,n));n.sub("PLANS-VIEW",$.proxy(n.onLoadPlansView,n))},clean:function(){var n=this,t=n.getContent();t&&$(".wdg-plan-filter-card",t).off("click");n.unsub("PLANS-VIEW",$.proxy(n.onLoadPlansView,n))},getData:function(){var n=this;return n.plansLinks.getData()},onClickFilter:function(n){var t=this,i=$(n.target).closest(".wdg-plan-filter-card"),f=i.data("title"),r=i.data("data"),e=r.toLowerCase(),u;t.setSelectedFilter(i);u={histName:f,planState:r,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,u)})}});bizagi.injector.register("bizagi.workportal.widgets.plans.filters",["workportalFacade","dataService",bizagi.workportal.widgets.plans.filters]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activities.sidebar",{},{init:function(n,t,i){var r=this;r._super(n,t,i);i=i||{};r.loadTemplates({"project-plan-activities-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.sidebar").concat("#project-plan-activities-sidebar")})},renderContent:function(){var n=this,t=n.getTemplate("project-plan-activities-sidebar");return n.content=t.render({}),n.content}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.activities.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activities.sidebar],!0);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.create",{},{init:function(n,t,i,r){var u=this;u.params=r;u.contextualized;u._super(n,t,r);u.notifier=i;u.loadTemplates({"plan-create":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.create").concat("#plan-create")});u.dialogBox={}},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.initPlugins()},initPlugins:function(){var n=this,t=n.getTemplate("plan-create");n.dialogBox.formContent=t.render({});n.dialogBox.elements={inputName:$("#input-name-plan",n.dialogBox.formContent),inputTemplate:$("#templates-plan",n.dialogBox.formContent),buttonSave:$("#button-accept-create-plan",n.dialogBox.formContent),buttonCancel:$("#button-cancel-create-plan",n.dialogBox.formContent)};n.dialogBox.elements.buttonSave.on("click",$.proxy(n.onClickSavePlan,n));n.dialogBox.elements.buttonCancel.on("click",$.proxy(n.closeDialogBox,n));n.notifier=bizagi.injector.get("notifier")},closeDialogBox:function(){var n=this;n.dialogBox.formContent.dialog("destroy");n.dialogBox.formContent.detach();n.dialogBox.templateGuid=""},showPopupAddPlan:function(n,t,i){var r=this;r.params=n;r.dataService=t;r.contextualized=i;r.content=$("<div><\/div>");r.initPlugins();r.dialogBox.elements.inputTemplate.html("");r.dataService.getTemplatesByParentWorkItem({parentWorkItem:n.guidWorkItem}).done(function(n){var t={combo:[],id:"templates"};t.combo=n;r.dialogBox.elements.inputTemplate.uicombo({isEditable:!1,data:t,itemValue:function(n){return n.id},itemText:function(n){return n.name},onChange:function(n){var t=n.ui.data("value");r.dialogBox.elements.inputTemplate.val(t);r.dialogBox.templateGuid=t},css:"display: none"});r.dialogBox.elements.inputTemplate.keydown(function(){(event.keyCode==8||event.keyCode==46)&&(event.preventDefault(),r.dialogBox.templateGuid="",r.dialogBox.elements.inputTemplate.val(""),$("input",r.dialogBox.elements.inputTemplate).val(""))});n.length>0?$(".field-template",r.dialogBox.formContent).show():$(".field-template",r.dialogBox.formContent).hide()}).fail(function(){$(".field-template",r.dialogBox.formContent).hide()});r.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-popup-title-add-plan"),maximize:!1,close:function(){r.dialogBox.formContent.dialog("destroy");r.dialogBox.formContent.detach()}})},onClickSavePlan:function(n){n.preventDefault();var t=this;t.validateParams()&&t.createNewPlan()},createNewPlan:function(){var n=this,i=n.params.guidWorkItem||null,t={idUserCreator:bizagi.currentUser.idUser,id:undefined,startDate:null,creationDate:null,parentWorkItem:i,description:null,currentState:"PENDING",name:n.dialogBox.elements.inputName.val(),waitForCompletion:!0,dueDate:null,contextualized:n.contextualized,idTemplate:n.dialogBox.templateGuid};$.when(n.sendDataInsertPlan(t)).then(function(i){t=$.extend(t,{id:i.id});t.activities=[];t.users=[];var r=new bizagi.workportal.services.behaviors.projectDashboard(n.dataService);n.params.menuPlanDashboard={};n.params.menuPlanDashboard.showCommentsOptionMenu=r.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonComments;n.params.menuPlanDashboard.showFilesOptionMenu=r.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonFiles;n.params.menuPlanDashboard.showTimeLineOptionMenu=r.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonTimeLine;$.when(r.getRadNumberForPlanDashboard(t.id,t.contextualized)).done(function(i){n.pub("planCreated",{paramsNewPlan:t,radNumber:i});n.closeDialogBox();n.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-created"),""))})})},validateParams:function(){var i=this,n=i.dialogBox.elements.inputName,t;return n.val()&&n.val()!==""?!0:(t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required"),n.next().find("span").html(t),!1)},sendDataInsertPlan:function(n){var i=this,t=$.Deferred();return $.when(i.dataService.postPlan(n)).always(function(n,i,r){r.status===201?t.resolve(n):t.reject()}),t.promise()}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.create",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.create]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.edit",{},{init:function(n,t,i,r){var u=this;u.params=r;u.planToEdit;u._super(n,t,r);u.notifier=i;u.loadTemplates({"plans.manager.popup.edit.plan":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.edit").concat("#plans-manager-popup-edit-plan")});u.editDialogBox={}},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this},closeEditDialogBox:function(){var n=this;n.editDialogBox.elements.inputDueDate.datepicker("destroy");n.editDialogBox.formContent.dialog("destroy");n.editDialogBox.formContent.detach()},showPopup:function(n,t,i){var r=this;r.planToEdit=i;r.initEditDialogBox(i);r.editDialogBox.elements.inputName.val(i.name);r.editDialogBox.elements.inputDesc.val(i.description);r.editDialogBox.elements.inputWaitForCompletion.prop("checked",i.waitForCompletion);r.editDialogBox.elements.inputDueDate.datepicker();r.editDialogBox.elements.inputDueDate.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI());i.dueDate&&r.editDialogBox.elements.inputDueDate.datepicker("setDate",new Date(i.dueDate));r.editDialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-editplan"),maximize:!0,close:function(){r.editDialogBox.elements.inputDueDate.datepicker("destroy");r.editDialogBox.formContent.dialog("destroy");r.editDialogBox.formContent.detach()}})},initEditDialogBox:function(n){var t=this,i=t.getTemplate("plans.manager.popup.edit.plan");t.editDialogBox.formContent=i.render(n);t.editDialogBox.elements={inputName:$("#input-name-plan",t.editDialogBox.formContent),inputDesc:$("#input-desc-plan",t.editDialogBox.formContent),inputDueDate:$("#input-dueDate-plan",t.editDialogBox.formContent),inputWaitForCompletion:$("#input-waitForCompletion",t.editDialogBox.formContent),buttonSave:$("#button-accept-edit-plan",t.editDialogBox.formContent),buttonCancel:$("#button-cancel-edit-plan",t.editDialogBox.formContent)};t.editDialogBox.elements.buttonSave.on("click",$.proxy(t.saveEditedPlan,t));t.editDialogBox.elements.buttonCancel.on("click",$.proxy(t.closeEditDialogBox,t))},saveEditedPlan:function(n){n.preventDefault();var t=this;t.validateEditDialogBoxParams()&&$.when(t.getParamsUpdatePlan()).done(function(n){$.when(t.dataService.updatePlan(n)).done(function(){t.closeEditDialogBox();t.pub("planEditedSuccess",{paramsEditPlan:n})}).fail(function(){t.pub("planEditedFailed")})})},getParamsUpdatePlan:function(){var n=this,i=$.Deferred(),t={},r,u;return t=n.planToEdit,t.name=n.editDialogBox.elements.inputName.val(),t.description=n.editDialogBox.elements.inputDesc.val(),n.editDialogBox.elements.inputWaitForCompletion.length!==0&&(t.waitForCompletion=n.editDialogBox.elements.inputWaitForCompletion.prop("checked")),r=n.editDialogBox.elements.inputDueDate.datepicker("getDate"),r?(u={idUser:bizagi.currentUser.idUser,date:r.getTime()},$.when(n.dataService.getEndHourWorkingByDate(u)).done(function(n){t.dueDate=n.dateTime;i.resolve(t)})):i.resolve(t),i.promise()},validateEditDialogBoxParams:function(){var i=this,n=i.editDialogBox.elements.inputName,t;return n.val()&&n.val()!==""?!0:(t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required"),n.next().find("span").html(t),!1)}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.edit",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.edit]);
bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.template.create",{},{init:function(n,t,i){var r=this;r.params=i;r.contextualized;r.idPlanSelected;r._super(n,t,i);r.loadTemplates({"plan-template-create":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.template.create").concat("#plan-template-create")});r.dialogBox={}},renderContent:function(){var n=this;return n.content=$("<div><\/div>"),n.content},postRender:function(){var n=this;n.initPlugins()},initPlugins:function(){var n=this,t=n.getTemplate("plan-template-create");n.dialogBox.formContent=t.render({});n.dialogBox.elements={inputName:$("#input-name-template",n.dialogBox.formContent),buttonSave:$("#button-accept-create-template",n.dialogBox.formContent),buttonCancel:$("#button-cancel-create-template",n.dialogBox.formContent)};n.dialogBox.elements.buttonSave.on("click",$.proxy(n.onClickSaveTemplate,n));n.dialogBox.elements.buttonCancel.on("click",$.proxy(n.closeDialogBox,n))},closeDialogBox:function(){var n=this;n.dialogBox.formContent.dialog("destroy");n.dialogBox.formContent.detach()},showPopupAddTemplatePlan:function(n,t,i,r){var u=this;u.params=n;u.dataService=t;u.contextualized=i;u.idPlanSelected=r;u.content=$("<div><\/div>");u.initPlugins();u.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-action-popup-save-as-template"),maximize:!1,close:function(){u.dialogBox.formContent.dialog("destroy");u.dialogBox.formContent.detach()}})},onClickSaveTemplate:function(n){var t,i;n.preventDefault();t=this;t.validateSaveDialogBoxParams()&&(i={idPlan:t.idPlanSelected,name:t.dialogBox.elements.inputName.val()},$.when(t.dataService.createTemplateByPlan(i)).done(function(){t.closeDialogBox();t.pub("planTemplateCreatedSuccess",{})}).fail(function(){t.pub("planTemplateCreatedFailed",{})}))},validateSaveDialogBoxParams:function(){var i=this,n=i.dialogBox.elements.inputName,t;return n.val()&&n.val()!==""?!0:(t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required"),n.next().find("span").html(t),!1)}});bizagi.injector.register("bizagi.workportal.widgets.project.plan.template.create",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.template.create]);
bizagi.workportal.widgets.admin.caseSearch.extend("bizagi.workportal.widgets.reassigncase",{},{init:function(n,t,i){var r=this;r._super(n,t,i);r.loadTemplates({"admin.case.search":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search"),"admin.case.search.fields":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-fields"),"admin.case.search.button":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-buttons"),"admin.case.search.result":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-result"),"admin.case.search.pagination":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-pagination"),"admin.case.search.invalidate":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-invalidate"),"admin.case.search.reassign":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-reassign"),"admin.case.search.reassign.form":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-reassign-form"),"admin.case.search.action.result":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-action-result"),useNewEngine:!1})},getWidgetName:function(){return bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_REASSIGN_CASE},renderContent:function(){var n=this,i=n.getTemplate("admin.case.search"),t;return t=n.content=$.tmpl(i,{}),n.loadtemplates(),t},loadtemplates:function(){var n=this;n.generalContentTmpl=n.getTemplate("admin.case.search");n.fieldsContentTmpl=n.getTemplate("admin.case.search.fields");n.buttonContentTmpl=n.getTemplate("admin.case.search.button");n.resultContentTmpl=n.getTemplate("admin.case.search.result");n.paginationTmpl=n.getTemplate("admin.case.search.pagination");n.invalidateContentTmpl=n.getTemplate("admin.case.search.invalidate");n.reassignContentTmpl=n.getTemplate("admin.case.search.reassign");n.reassignFormTmpl=n.getTemplate("admin.case.search.reassign.form");n.actionResultContentTmpl=n.getTemplate("admin.case.search.action.result")},postRender:function(){var n=this;n.maxElemShow=10;n.maxPageToShow=5;n.processNavigation=[];n.setupData()},setupData:function(){var n=this,t={cases:[]},i=[];n.setupInitialData();n.setupDatePicker();n.setupProcessTree();n.setupMainButtons();t.cases.push({idCase:n.params.data.idCase,idWorkItem:n.params.data.idWorkItem});i.push({taskItem:n.params.data.idCase+": "+n.params.data.idtask,idWorkItem:n.params.data.idWorkItem});n.selectedTasks=t;n.selectedTasksToShow=i;n.showReassignForm(n.content,n.selectedTasksToShow)},setupInitialData:function(){var n=this,t=n.getContent(),i;n.buttonBackAction="backToMainForm";n.selectedUserId="";n.selectedUserName="";n.selectedTasks="";n.selectedTasksToShow="";n.searchParams="";n.processTree="";$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-subtitle"));$("#mainForm",t).remove();$("#dinamicContent",t).remove();$("#case-search-log-data-buttonset",t).remove();i=$.tmpl(n.reassignFormTmpl,{});t.append(i)},setupDatePicker:function(){var n=this,t=n.getContent();$(".biz-wp-form-datepicker",t).datepicker({controlType:"select",dateFormat:"dd/mm/yy"})},setupProcessTree:function(){var n=this,t=n.getContent();bizagi.treeRoutSelected=[];$("#treeLinksId").remove();n.processTree=new bizagi.workportal.widgets.processtree(n.workportalFacade,n.dataService,$.extend(n.params,{canvas:$("#processTree",t)}));n.processTree.render()},setupUsersSearchForm:function(){var n=this,i=n.getContent(),t=$.Deferred();$("#biz-wp-users-table-form").html("");n.usersTable=new bizagi.workportal.widgets.userstable(n.workportalFacade,n.dataService,$.extend(n.params,{canvas:$("#biz-wp-users-table-form",i),userLinkLabel:[bizagi.localization.getResource("workportal-widget-admincasesearch-reassign")],parentDef:t}));n.usersTable.render();$.when(t).done(function(t,i){n.assignEventReassignLinks(t,i)})},findResults:function(n,t,i){var r=this;t.Page=i?i:1;$.when(r.dataService.getAdminCasesList(t)).done(function(i){var f;if($(".biz-wp-table").remove(),$(".case-search-action-wrapper").remove(),$("#biz-wp-table-summary-wrapper").remove(),r.totalRecords=i.records,r.totalPages=i.total,i.rows.length>0){r.showCasesSearchResultFrame(n,i);r.setupActionsButton(n);var o=r.maxPageToShow>r.totalPages?r.totalPages:r.maxPageToShow,s=$("#biz-wp-table-pager-wrapper"),u={},e;for(u.pagination=r.totalPages>1?!0:!1,u.page=i.page,u.pages={},f=1;f<=o;f++)u.pages[f]={pageNumber:f};e=$.tmpl(r.paginationTmpl,u).html();s.append(e);$("ul").bizagiPagination({maxElemShow:r.maxElemShow,totalPages:r.totalPages,actualPage:i.page,listElement:$("#biz-wp-table-pager-wrapper"),clickCallBack:function(i){r.findResults(n,t,i.page)}})}else bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-authentication-log-none"),"Bizagi","warning")}).fail(function(n){bizagi.log(n)})},showCasesSearchResultFrame:function(n,t){var i=this,r=i.preprocessResultList(t.headers,t),u=$.tmpl(i.resultContentTmpl,{headers:t.headers,rows:r}),f=$.tmpl(i.invalidateContentTmpl,{}),e=$.tmpl(i.reassignContentTmpl,{});$("#mainForm",n).hide();$("#dinamicContent",n).html(u);$(".case-search-action-wrapper",n).append(f);$(".case-search-action-wrapper",n).append(e);$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-table-title"));$("#btn-admin-case-search-clear",n).hide();$("#btn-admin-case-search",n).hide();$("#btn-admin-case-back",n).css("display","inline");i.setupActivitiesLink(n);i.setupGraphicQueryEvent(n)},preprocessResultList:function(n,t){for(var u=this,r=[],f=t.rows.length,i=0;i<f;i++)r.push(u.processResultItem(n,t.rows[i]));return r},processResultItem:function(n,t){var i=this,e=t.data,l=t.idCase,k=t.idWorkFlow,p=[],r=[],h,v,y,u=[],w,o=-1,f=0,b=!1,c,a,s;for(r.push({id:"checkCaseAdmin",value:l});o++<n.length-1;)switch(n[o].fieldName){case i.columnsID.caseNumber:r.push({id:"caseNumber",value:{idCase:l,caseNumber:e[f]}});f++;break;case i.columnsID.process:r.push({id:"idWorkItem",value:e[f]});f++;break;case i.columnsID.userName:case i.columnsID.task:case i.columnsID.taskDueDate:if(h===undefined){for(s=e.length;s-->0;)if(Array.isArray(e[s])){h=e[s];b=!0;break}f++}b?(n[o].fieldName==i.columnsID.taskDueDate&&e.splice(o,1),y=h[0],i.columnsID.userName==n[o].fieldName?(r=r.concat(i.processTaskObjectUser(y)),u.indexOf(i.columnsID.userName)==-1&&u.push(i.columnsID.userName)):i.columnsID.task==n[o].fieldName?(r=r.concat(i.processTaskObject(y,l)),u.indexOf(i.columnsID.task)==-1&&u.push(i.columnsID.task)):i.columnsID.taskDueDate==n[o].fieldName&&(r=r.concat(i.processTaskObjectDate(y)),u.indexOf(i.columnsID.taskDueDate)==-1&&u.push(i.columnsID.taskDueDate))):n[o].fieldName==i.columnsID.taskDueDate&&(r=r.concat({estimatedSolutionDate:e[o]}),u.indexOf(i.columnsID.taskDueDate)==-1&&u.push(i.columnsID.taskDueDate));break;case i.columnsID.processCreationDate:r.push({id:"processCreationDate",value:e[f]});f++;break;case i.columnsID.processDueDate:r.push({id:"processDueDate",value:e[f]});f++;break;default:r.push({id:"customField",value:e[f]});f++}if(r.push({id:"viewProcess",value:{idCase:l,idworkflow:k}}),p.push({attr:"first_row",data:r}),v=h?h.length:0,v>1)for(w=u.length,c=1;c<v;c++){for(a=[],s=-1;s++<w-1;)u[s]==i.columnsID.task?a.push(i.processTaskObject(h[c],l)):u[s]==i.columnsID.taskDueDate?a.push(i.processTaskObjectDate(h[c])):u[s]==i.columnsID.userName&&a.push(i.processTaskObjectUser(h[c]));p.push({attr:"next_row",data:a})}return{data:p,totalTask:v}},processTaskObject:function(n,t){return{taskName:n.taskName,colorState:n.colorState,idCase:t,idWorkItem:n.idWorkItem,idTask:n.idTask}},processTaskObjectDate:function(n){var t={};return t.estimatedSolutionDate=n.estimatedSolutionDate?n.estimatedSolutionDate:"",t},processTaskObjectUser:function(n){var t={};return t.userName=n.assignee?n.assignee:"",t},invalidateCases:function(n){var i=this,t={cases:[]};$("input:checkbox[name=CaseAdmin]:checked",n).each(function(){var n=$(this).val();t.cases.push({idCase:n})});t.cases.length==0?bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-empty-msg"),"Bizagi","warning"):$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-confirm-msg"),"Bizagi","warning")).done(function(){var r=$("#txtReason",n).val(),u={action:"abort",cases:JSON.stringify(t),reason:r};$.when(i.dataService.abortReassignItems(u)).done(function(t){i.showActionResultFrame(n,t.response,"invalidate")}).fail(function(n){bizagi.log(n)})})},showReassignTasksFrame:function(n){var i=this,r={cases:[]},t=[];$("input:checkbox[name=workItemAdmin]:checked",n).each(function(){var n=$(this).val();n=n.split("|");r.cases.push({idCase:n[0],idWorkItem:n[1]});t.push({taskItem:n[0]+": "+n[2],idWorkItem:n[1]})});t.length==0?bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-admincasesearch-reassign-empty-msg"),"Bizagi","warning"):(i.selectedTasks=r,i.selectedTasksToShow=t,i.showReassignForm(n,t))},showReassignForm:function(n,t){var i=this,r;i.buttonBackAction="backToCases";r=$.tmpl(i.reassignFormTmpl,{tasks:t});$("#dinamicContent",n).hide();$("#dinamicContent2",n).html(r);$("#btn-admin-case-search-clear",n).hide();$("#btn-admin-case-search",n).hide();$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-reassign-title"));i.setupUsersSearchForm()},reassignTasks:function(){var n=this,t=n.getContent(),i={action:"reassignItems",cases:JSON.stringify(n.selectedTasks),idNewUser:n.selectedUserId};$.when(n.dataService.abortReassignItems(i)).done(function(i){n.showActionResultFrame(t,i.response,"reassign")}).fail(function(n){bizagi.log(n)})},showActionResultFrame:function(n,t,i){var h=this,s=t.length>1?"-several":"",u="",f="",e=[],r,o;if(s=i+s,s=="invalidate")for(r=0;r<t.length;r++)t[r].deleted==!0?(u=t[r].idCase,u+=r+1<t.length?", ":"",e[0]=!0):(f=t[r].idCase,f+=r+1<t.length?", ":"",e[1]=!1);else if(s=="invalidate-several")for(r=0;r<t.length;r++)t[r].deleted==!0?(u+=t[r].idCase,u+=r+1<t.length?", ":"",e[0]=!0):(f+=t[r].idCase,f+=r+1<t.length?", ":"",e[1]=!1);else if(s=="reassign")for(r=0;r<t.length;r++)t[r].reassigned==!0?(u+=t[r].idCase,u+=r+1<t.length?", ":"",e[0]=!0):(f=t[r].idCase,f+=r+1<t.length?", ":"",e[1]=!1);else if(s=="reassign-several"){for(u+="<br/><br/>",f+="<br/><br/>",r=0;r<t.length;r++)t[r].reassigned==!0?(u+=t[r].idCase+"<br/>",e[0]=!0):(f+=t[r].idCase+"<br/>",e[1]=!1);u+="<br/>";f+="<br/>"}o=$.tmpl(h.actionResultContentTmpl,{action:s,resultStatus:e});o=o[0].innerHTML.replace("{0}","<strong>"+u+"<\/strong>");o=o.replace("{3}","<strong>"+f+"<\/strong>");o=o.replace("{1}",h.selectedUserName);o=o.replace("{1}",h.selectedUserName);i=="invalidate"&&$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-result-title"));$("#mainForm",n).html("");$("#dinamicContent",n).css("display","inline");$("#dinamicContent",n).html(o);$("#dinamicContent2",n).remove();$("#usersTable",n).remove();$("#btn-admin-case-back",n).css("display","none");$("#btn-admin-case-search-clear",n).css("display","none");$("#btn-admin-case-search",n).css("display","none");$("#btn-admin-case-finish",n).css("display","inline");$("#biz-wp-userstable-wrapperform").hide();$("#biz-wp-userstable-wrapperlist").hide();h.usersTable.resultStatus=e.indexOf(!1)==-1},setupMainButtons:function(){var n=this,t=n.getContent(),r=$.tmpl(n.buttonContentTmpl,{}),i;t.append(r);i=$("#case-search-log-data-buttonset",t);$("#btn-admin-case-search-clear",i).click(function(){$(".biz-wp-input-text",t).val("");$(".biz-wp-form-datepicker",t).val("");n.setupProcessTree()});$("#btn-admin-case-search",i).click(function(){var f="",e="",o="",i="",u="",r=n.processTree.getTreeRouteSelected(),s;r.length>0&&(r.length==2?(f=r[1],o=r[0],e=""):(f=r[r.length-1],e=r[1],o=r[0]));s={h_action:"getCases",I_ProcessState:"Running",h_idApp:"",I_Users:"ALL",eventAsTask:!0,orderType:1,order:"",orderField:"",I_radNumber:$("#caseInput").val(),I_idWFClass:o,I_USERFULLNAME:$("#userNameInput").val(),I_USERPOSITION:$("#userPositionInput").val(),I_From__CreationDate:$("#sinceDate").val(),I_To__CreationDate:$("#toDate").val(),h_idWFClassAuth:"",I_idCategory:e,I_idApplication:f,PageSize:n.maxElemShow};$("#sinceDate").val()==""||bizagi.util.isDate($("#sinceDate").val())?$("#toDate").val()==""||bizagi.util.isDate($("#toDate").val())?(n.searchParams=s,n.findResults(t,s)):(i=bizagi.localization.getResource("workportal-general-invalid-date"),u=bizagi.localization.getResource("workportal-widget-admincasesearch-to-date"),i=i.replace("{0}",u),bizagi.showMessageBox(i,"Bizagi","warning")):(i=bizagi.localization.getResource("workportal-general-invalid-date"),u=bizagi.localization.getResource("workportal-widget-admincasesearch-date-since"),i=i.replace("{0}",u),bizagi.showMessageBox(i,"Bizagi","warning"))});$("#btn-admin-case-back",i).click(function(){n.buttonBackAction=="backToMainForm"?n.backToMainForm():n.buttonBackAction=="backToCases"&&n.backToCases()});$("#btn-admin-case-finish",i).click(function(){n.publish("closeCurrentDialog")})},backToCases:function(){var t=this,n=t.getContent();t.buttonBackAction="backToMainForm";$("#dinamicContent",n).show();$("#dinamicContent2",n).html("");$("#usersTable").remove();$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-table-title"));$("#btn-admin-case-search-clear",n).hide();$("#btn-admin-case-search",n).hide()},backToMainForm:function(){var t=this,n=t.getContent();$("#mainForm",n).show();$("#dinamicContent",n).html("");$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-subtitle"));$("#btn-admin-case-search-clear",n).show();$("#btn-admin-case-search",n).show();$("#btn-admin-case-back",n).css("display","none")},assignEventReassignLinks:function(n,t){var i=this;i.selectedUserId=n;i.selectedUserName=t;i.reassignTasks()},setupActionsButton:function(n){var t=this;$("#btn-admin-case-invalidate",n).click(function(){t.invalidateCases(n)});$("#btn-admin-case-reassign",n).click(function(){t.showReassignTasksFrame(n)})},setupActivitiesLink:function(n){var t=this;$(".activityClicked",n).click(function(){t.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:$(this)[0].getAttribute("data-idCase"),idWorkItem:$(this)[0].getAttribute("data-idworkItem"),idTask:$(this)[0].getAttribute("data-idTask")});t.publish("closeCurrentDialog")});$(".caseClicked",n).click(function(){t.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:$(this)[0].getAttribute("data-idCase"),idWorkItem:"",idTask:""});t.publish("closeCurrentDialog")});$(".cases-column-header",n).click(function(){var r=$(this)[0].getAttribute("data-columnorder"),i=$(this)[0].getAttribute("data-ordertype"),u=$(this)[0].getAttribute("data-columnOrderName");i=i=="1"?0:1;t.searchParams.order=r;t.searchParams.orderType=i;t.searchParams.orderField=u;t.findResults(n,t.searchParams,t.searchParams.Page)})},setupGraphicQueryEvent:function(n){var t=this;$(".biz-wp-diagram-view-icon",n).click(function(){var n=$(this).data("idcase"),i=$(this).data("idworkflow");t.showGraphicQuery({idCase:n,idWorkflow:i})})}});
